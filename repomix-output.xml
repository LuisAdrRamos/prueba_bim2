This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.env.example
.gitattributes
.gitignore
.metadata
analysis_options.yaml
android/.gitignore
android/app/build.gradle
android/app/src/debug/AndroidManifest.xml
android/app/src/main/AndroidManifest.xml
android/app/src/main/kotlin/com/example/prueba_bim2/MainActivity.kt
android/app/src/main/res/drawable-v21/launch_background.xml
android/app/src/main/res/drawable/launch_background.xml
android/app/src/main/res/mipmap-hdpi/ic_launcher.png
android/app/src/main/res/mipmap-mdpi/ic_launcher.png
android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
android/app/src/main/res/values-night/styles.xml
android/app/src/main/res/values/styles.xml
android/app/src/profile/AndroidManifest.xml
android/build.gradle
android/gradle.properties
android/gradle/wrapper/gradle-wrapper.properties
android/settings.gradle
lib/core/constants/app_constants.dart
lib/core/error/failures.dart
lib/core/network/network_info.dart
lib/core/theme/app_theme.dart
lib/core/usecase/usecase.dart
lib/features/ai_assistant/data/datasources/ai_remote_data_source.dart
lib/features/ai_assistant/data/repositories/ai_repository_impl.dart
lib/features/ai_assistant/domain/entities/message_entity.dart
lib/features/ai_assistant/domain/repositories/ai_repository.dart
lib/features/ai_assistant/presentation/bloc/chat_bloc.dart
lib/features/ai_assistant/presentation/bloc/chat_event.dart
lib/features/ai_assistant/presentation/bloc/chat_state.dart
lib/features/ai_assistant/presentation/pages/chat_page.dart
lib/features/auth/data/datasources/auth_remote_data_source.dart
lib/features/auth/data/models/user_model.dart
lib/features/auth/data/repositories/auth_repository_impl.dart
lib/features/auth/domain/entities/user_entity.dart
lib/features/auth/domain/repositories/auth_repository.dart
lib/features/auth/domain/usecases/get_current_user.dart
lib/features/auth/domain/usecases/reset_password.dart
lib/features/auth/domain/usecases/sign_in.dart
lib/features/auth/domain/usecases/sign_out.dart
lib/features/auth/domain/usecases/sign_up.dart
lib/features/auth/presentation/bloc/auth_bloc.dart
lib/features/auth/presentation/bloc/auth_event.dart
lib/features/auth/presentation/bloc/auth_state.dart
lib/features/auth/presentation/pages/email_verification_sent_page.dart
lib/features/auth/presentation/pages/login_page.dart
lib/features/auth/presentation/pages/profile_page.dart
lib/features/auth/presentation/pages/register_page.dart
lib/features/auth/presentation/pages/reset_password_page.dart
lib/features/auth/presentation/pages/welcome_page.dart
lib/features/auth/presentation/widgets/custom_text_field.dart
lib/features/auth/presentation/widgets/loading_overlay.dart
lib/features/pet_management/data/datasources/pet_remote_data_source.dart
lib/features/pet_management/data/models/pet_model.dart
lib/features/pet_management/data/repositories/pet_repository_impl.dart
lib/features/pet_management/domain/entities/pet_entity.dart
lib/features/pet_management/domain/repositories/pet_repository.dart
lib/features/pet_management/presentation/bloc/pet_bloc.dart
lib/features/pet_management/presentation/bloc/pet_event.dart
lib/features/pet_management/presentation/bloc/pet_state.dart
lib/features/pet_management/presentation/pages/adopter_home_page.dart
lib/features/pet_management/presentation/pages/create_pet_page.dart
lib/features/pet_management/presentation/pages/location_picker_page.dart
lib/features/pet_management/presentation/pages/map_page.dart
lib/features/pet_management/presentation/pages/pet_detail_page.dart
lib/features/pet_management/presentation/pages/shelter_home_page.dart
lib/features/pet_management/presentation/widgets/pet_card.dart
lib/injection_container.config.dart
lib/injection_container.dart
lib/main.dart
pubspec.lock
pubspec.yaml
README.md
vercel/.gitignore
vercel/api/config.js
vercel/package.json
vercel/public/reset-password.html
vercel/public/verify-email.html
vercel/vercel.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="lib/features/ai_assistant/data/datasources/ai_remote_data_source.dart">
import 'dart:convert';
import 'package:http/http.dart' as http;
import 'package:flutter_dotenv/flutter_dotenv.dart';
import 'package:injectable/injectable.dart';
import '../../domain/entities/message_entity.dart';

abstract class AIRemoteDataSource {
  Future<String> sendMessage(String message, List<MessageEntity> history);
}

@LazySingleton(as: AIRemoteDataSource)
class AIRemoteDataSourceImpl implements AIRemoteDataSource {
  final http.Client client;

  AIRemoteDataSourceImpl(this.client);

  @override
  Future<String> sendMessage(
      String currentMessage, List<MessageEntity> history) async {
    final apiKey = dotenv.env['GEMINI_API_KEY'];
    final baseUrl = dotenv.env['GEMINI_BASE_URL'];

    if (apiKey == null || baseUrl == null) {
      throw Exception("Faltan configurar las variables en el .env");
    }

    final url = Uri.parse("$baseUrl?key=$apiKey");

    // --- AQU EST EL TRUCO DEL EXPERTO VETERINARIO ---
    // Preparamos el historial para Gemini
    final contents = history.map((msg) {
      return {
        "role": msg.isUser ? "user" : "model",
        "parts": [
          {"text": msg.text}
        ],
      };
    }).toList();

    // Inyectamos el System Prompt como si fuera el primer mensaje del contexto (hack compatible con todas las versiones)
    if (history.isEmpty) {
      contents.insert(0, {
        "role": "user",
        "parts": [
          {
            "text":
                "Eres un asistente veterinario experto, amable y conciso. Responde dudas sobre mascotas."
          }
        ]
      });
      contents.insert(1, {
        "role": "model",
        "parts": [
          {
            "text":
                "Entendido. Soy un veterinario experto. 驴En qu茅 puedo ayudarte con tu mascota hoy?"
          }
        ]
      });
    }

    // A帽adimos el mensaje actual
    contents.add({
      "role": "user",
      "parts": [
        {"text": currentMessage}
      ],
    });

    final body = jsonEncode({
      "contents": contents,
      "generationConfig": {"temperature": 0.7, "maxOutputTokens": 1000},
    });

    try {
      final response = await client
          .post(url, headers: {'Content-Type': 'application/json'}, body: body)
          .timeout(const Duration(seconds: 30));

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        final candidate = data["candidates"]?[0];

        if (candidate != null && candidate["content"] != null) {
          final parts = candidate["content"]["parts"] as List;
          if (parts.isNotEmpty) {
            return parts[0]["text"] ?? "No pude generar una respuesta.";
          }
        }
        return "Sin respuesta de la IA.";
      } else {
        throw Exception("Error API: ${response.statusCode}");
      }
    } catch (e) {
      throw Exception("Error de conexi贸n: $e");
    }
  }
}
</file>

<file path="lib/features/ai_assistant/data/repositories/ai_repository_impl.dart">
import 'package:dartz/dartz.dart';
import 'package:injectable/injectable.dart';
import '../../../../core/error/failures.dart';
import '../../domain/entities/message_entity.dart';
import '../../domain/repositories/ai_repository.dart';
import '../datasources/ai_remote_data_source.dart';

@LazySingleton(as: AIRepository)
class AIRepositoryImpl implements AIRepository {
  final AIRemoteDataSource remoteDataSource;

  AIRepositoryImpl(this.remoteDataSource);

  @override
  Future<Either<Failure, String>> sendMessage(
      String message, List<MessageEntity> history) async {
    try {
      final response = await remoteDataSource.sendMessage(message, history);
      return Right(response);
    } catch (e) {
      return Left(ServerFailure(e.toString()));
    }
  }
}
</file>

<file path="lib/features/ai_assistant/domain/entities/message_entity.dart">
class MessageEntity {
  final String text;
  final bool isUser;
  final DateTime timestamp;

  MessageEntity({
    required this.text,
    required this.isUser,
    DateTime? timestamp,
  }) : timestamp = timestamp ?? DateTime.now();
}
</file>

<file path="lib/features/ai_assistant/domain/repositories/ai_repository.dart">
import 'package:dartz/dartz.dart';
import '../../../../core/error/failures.dart';
import '../entities/message_entity.dart';

abstract class AIRepository {
  Future<Either<Failure, String>> sendMessage(
      String message, List<MessageEntity> history);
}
</file>

<file path="lib/features/ai_assistant/presentation/bloc/chat_bloc.dart">
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:injectable/injectable.dart';
import '../../domain/entities/message_entity.dart';
import '../../domain/repositories/ai_repository.dart';
import 'chat_event.dart';
import 'chat_state.dart';

@injectable
class ChatBloc extends Bloc<ChatEvent, ChatState> {
  final AIRepository repository;

  ChatBloc(this.repository) : super(const ChatInitial()) {
    on<SendMessage>(_onSendMessage);
    on<ClearChat>((event, emit) => emit(const ChatInitial()));
  }

  Future<void> _onSendMessage(
      SendMessage event, Emitter<ChatState> emit) async {
    final currentMessages = List<MessageEntity>.from(state.messages);

    // 1. A帽adir mensaje del usuario inmediatamente
    currentMessages.add(MessageEntity(text: event.text, isUser: true));
    emit(ChatLoading(currentMessages));

    // 2. Llamar a la IA
    final result = await repository.sendMessage(event.text, state.messages);

    // 3. Manejar respuesta
    result.fold(
      (failure) => emit(ChatError(currentMessages, failure.message)),
      (response) {
        currentMessages.add(MessageEntity(text: response, isUser: false));
        emit(ChatLoaded(
            List.from(currentMessages))); // Nueva lista para forzar update
      },
    );
  }
}
</file>

<file path="lib/features/ai_assistant/presentation/bloc/chat_event.dart">
import 'package:equatable/equatable.dart';

abstract class ChatEvent extends Equatable {
  const ChatEvent();
  @override
  List<Object> get props => [];
}

class SendMessage extends ChatEvent {
  final String text;
  const SendMessage(this.text);
}

class ClearChat extends ChatEvent {}
</file>

<file path="lib/features/ai_assistant/presentation/bloc/chat_state.dart">
import 'package:equatable/equatable.dart';
import '../../domain/entities/message_entity.dart';

abstract class ChatState extends Equatable {
  final List<MessageEntity> messages;
  const ChatState(this.messages);
  @override
  List<Object> get props => [messages];
}

class ChatInitial extends ChatState {
  const ChatInitial() : super(const []);
}

class ChatLoading extends ChatState {
  const ChatLoading(super.messages);
}

class ChatLoaded extends ChatState {
  const ChatLoaded(super.messages);
}

class ChatError extends ChatState {
  final String message;
  const ChatError(super.messages, this.message);
}
</file>

<file path="lib/features/ai_assistant/presentation/pages/chat_page.dart">
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:flutter_markdown/flutter_markdown.dart';
import '../../../../injection_container.dart';
import '../bloc/chat_bloc.dart';
import '../bloc/chat_event.dart';
import '../bloc/chat_state.dart';
import '../../domain/entities/message_entity.dart';

class ChatPage extends StatelessWidget {
  const ChatPage({super.key});

  @override
  Widget build(BuildContext context) {
    // Usamos BlocProvider aqu铆 para que el estado persista mientras estemos en esta tab
    // (O idealmente lo subimos al main si queremos que persista al cambiar de tab)
    return BlocProvider(
      create: (_) => getIt<ChatBloc>(),
      child: const ChatView(),
    );
  }
}

class ChatView extends StatefulWidget {
  const ChatView({super.key});

  @override
  State<ChatView> createState() => _ChatViewState();
}

class _ChatViewState extends State<ChatView> {
  final _controller = TextEditingController();
  final _scrollController = ScrollController();

  void _scrollToBottom() {
    if (_scrollController.hasClients) {
      _scrollController.animateTo(
        _scrollController.position.maxScrollExtent + 100,
        duration: const Duration(milliseconds: 300),
        curve: Curves.easeOut,
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Asistente Veterinario '),
        actions: [
          IconButton(
            icon: const Icon(Icons.delete_outline),
            onPressed: () => context.read<ChatBloc>().add(ClearChat()),
          ),
        ],
      ),
      body: Column(
        children: [
          Expanded(
            child: BlocConsumer<ChatBloc, ChatState>(
              listener: (context, state) {
                // Scroll al fondo cuando llega un mensaje nuevo
                if (state is ChatLoaded || state is ChatLoading) {
                  WidgetsBinding.instance
                      .addPostFrameCallback((_) => _scrollToBottom());
                }
                if (state is ChatError) {
                  ScaffoldMessenger.of(context)
                      .showSnackBar(SnackBar(content: Text(state.message)));
                }
              },
              builder: (context, state) {
                if (state.messages.isEmpty) {
                  return const Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(Icons.pets, size: 60, color: Colors.grey),
                        SizedBox(height: 10),
                        Text("隆Hola! Soy tu veterinario virtual.",
                            style: TextStyle(color: Colors.grey)),
                        Text("Preg煤ntame sobre salud o cuidados.",
                            style: TextStyle(color: Colors.grey)),
                      ],
                    ),
                  );
                }

                return ListView.builder(
                  controller: _scrollController,
                  padding: const EdgeInsets.all(16),
                  itemCount:
                      state.messages.length + (state is ChatLoading ? 1 : 0),
                  itemBuilder: (context, index) {
                    if (index >= state.messages.length) {
                      return const _TypingIndicator();
                    }
                    return _MessageBubble(message: state.messages[index]);
                  },
                );
              },
            ),
          ),
          _buildInputArea(context),
        ],
      ),
    );
  }

  Widget _buildInputArea(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(8),
      color: Colors.white,
      child: SafeArea(
        child: Row(
          children: [
            Expanded(
              child: TextField(
                controller: _controller,
                decoration: InputDecoration(
                  hintText: 'Escribe tu consulta...',
                  border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(25)),
                  contentPadding:
                      const EdgeInsets.symmetric(horizontal: 20, vertical: 10),
                ),
                onSubmitted: (_) => _sendMessage(context),
              ),
            ),
            const SizedBox(width: 8),
            FloatingActionButton(
              onPressed: () => _sendMessage(context),
              mini: true,
              backgroundColor: const Color(0xFFFF8B3D),
              child: const Icon(Icons.send, color: Colors.white),
            ),
          ],
        ),
      ),
    );
  }

  void _sendMessage(BuildContext context) {
    final text = _controller.text.trim();
    if (text.isNotEmpty) {
      context.read<ChatBloc>().add(SendMessage(text));
      _controller.clear();
    }
  }
}

class _MessageBubble extends StatelessWidget {
  final MessageEntity message;
  const _MessageBubble({required this.message});

  @override
  Widget build(BuildContext context) {
    final isUser = message.isUser;
    return Align(
      alignment: isUser ? Alignment.centerRight : Alignment.centerLeft,
      child: Container(
        margin: const EdgeInsets.symmetric(vertical: 4),
        padding: const EdgeInsets.all(12),
        constraints:
            BoxConstraints(maxWidth: MediaQuery.of(context).size.width * 0.8),
        decoration: BoxDecoration(
          color: isUser ? const Color(0xFFFF8B3D) : Colors.grey[200],
          borderRadius: BorderRadius.only(
            topLeft: const Radius.circular(16),
            topRight: const Radius.circular(16),
            bottomLeft: Radius.circular(isUser ? 16 : 4),
            bottomRight: Radius.circular(isUser ? 4 : 16),
          ),
        ),
        child: isUser
            ? Text(message.text, style: const TextStyle(color: Colors.white))
            : MarkdownBody(data: message.text), // Renderiza Markdown para la IA
      ),
    );
  }
}

class _TypingIndicator extends StatelessWidget {
  const _TypingIndicator();
  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.all(8.0),
      child: Row(
        children: [
          const CircleAvatar(
              radius: 10, child: Icon(Icons.smart_toy, size: 12)),
          const SizedBox(width: 10),
          Text('Escribiendo...',
              style: TextStyle(
                  color: Colors.grey[600], fontStyle: FontStyle.italic)),
        ],
      ),
    );
  }
}
</file>

<file path=".gitattributes">
# Auto detect text files and perform LF normalization
* text=auto
</file>

<file path=".gitignore">
.env

# Miscellaneous
*.class
*.log
*.pyc
*.swp
.DS_Store
.atom/
.build/
.buildlog/
.history
.svn/
.swiftpm/
migrate_working_dir/

# IntelliJ related
*.iml
*.ipr
*.iws
.idea/

# The .vscode folder contains launch configuration and tasks you configure in
# VS Code which you may wish to be included in version control, so this line
# is commented out by default.
#.vscode/

# Flutter/Dart/Pub related
**/doc/api/
**/ios/Flutter/.last_build_id
.dart_tool/
.flutter-plugins
.flutter-plugins-dependencies
.pub-cache/
.pub/
/build/

# Symbolication related
app.*.symbols

# Obfuscation related
app.*.map.json

# Android Studio will place build artifacts here
/android/app/debug
/android/app/profile
/android/app/release
</file>

<file path=".metadata">
# This file tracks properties of this Flutter project.
# Used by Flutter tool to assess capabilities and perform upgrades etc.
#
# This file should be version controlled and should not be manually edited.

version:
  revision: "d8a9f9a52e5af486f80d932e838ee93861ffd863"
  channel: "stable"

project_type: app

# Tracks metadata for the flutter migrate command
migration:
  platforms:
    - platform: root
      create_revision: d8a9f9a52e5af486f80d932e838ee93861ffd863
      base_revision: d8a9f9a52e5af486f80d932e838ee93861ffd863
    - platform: android
      create_revision: d8a9f9a52e5af486f80d932e838ee93861ffd863
      base_revision: d8a9f9a52e5af486f80d932e838ee93861ffd863
    - platform: ios
      create_revision: d8a9f9a52e5af486f80d932e838ee93861ffd863
      base_revision: d8a9f9a52e5af486f80d932e838ee93861ffd863
    - platform: linux
      create_revision: d8a9f9a52e5af486f80d932e838ee93861ffd863
      base_revision: d8a9f9a52e5af486f80d932e838ee93861ffd863
    - platform: macos
      create_revision: d8a9f9a52e5af486f80d932e838ee93861ffd863
      base_revision: d8a9f9a52e5af486f80d932e838ee93861ffd863
    - platform: web
      create_revision: d8a9f9a52e5af486f80d932e838ee93861ffd863
      base_revision: d8a9f9a52e5af486f80d932e838ee93861ffd863
    - platform: windows
      create_revision: d8a9f9a52e5af486f80d932e838ee93861ffd863
      base_revision: d8a9f9a52e5af486f80d932e838ee93861ffd863

  # User provided section

  # List of Local paths (relative to this file) that should be
  # ignored by the migrate tool.
  #
  # Files that are not part of the templates will be ignored by default.
  unmanaged_files:
    - 'lib/main.dart'
    - 'ios/Runner.xcodeproj/project.pbxproj'
</file>

<file path="analysis_options.yaml">
# This file configures the analyzer, which statically analyzes Dart code to
# check for errors, warnings, and lints.
#
# The issues identified by the analyzer are surfaced in the UI of Dart-enabled
# IDEs (https://dart.dev/tools#ides-and-editors). The analyzer can also be
# invoked from the command line by running `flutter analyze`.

# The following line activates a set of recommended lints for Flutter apps,
# packages, and plugins designed to encourage good coding practices.
include: package:flutter_lints/flutter.yaml

linter:
  # The lint rules applied to this project can be customized in the
  # section below to disable rules from the `package:flutter_lints/flutter.yaml`
  # included above or to enable additional rules. A list of all available lints
  # and their documentation is published at https://dart.dev/lints.
  #
  # Instead of disabling a lint rule for the entire project in the
  # section below, it can also be suppressed for a single line of code
  # or a specific dart file by using the `// ignore: name_of_lint` and
  # `// ignore_for_file: name_of_lint` syntax on the line or in the file
  # producing the lint.
  rules:
    # avoid_print: false  # Uncomment to disable the `avoid_print` rule
    # prefer_single_quotes: true  # Uncomment to enable the `prefer_single_quotes` rule

# Additional information about this file can be found at
# https://dart.dev/guides/language/analysis-options
</file>

<file path="android/.gitignore">
gradle-wrapper.jar
/.gradle
/captures/
/gradlew
/gradlew.bat
/local.properties
GeneratedPluginRegistrant.java

# Remember to never publicly share your keystore.
# See https://flutter.dev/to/reference-keystore
key.properties
**/*.keystore
**/*.jks
</file>

<file path="android/app/build.gradle">
plugins {
    id "com.android.application"
    id "kotlin-android"
    // The Flutter Gradle Plugin must be applied after the Android and Kotlin Gradle plugins.
    id "dev.flutter.flutter-gradle-plugin"
}

android {
    namespace = "com.example.prueba_bim2"
    compileSdk = flutter.compileSdkVersion
    ndkVersion = flutter.ndkVersion

    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_1_8
        targetCompatibility = JavaVersion.VERSION_1_8
    }

    kotlinOptions {
        jvmTarget = JavaVersion.VERSION_1_8
    }

    defaultConfig {
        // TODO: Specify your own unique Application ID (https://developer.android.com/studio/build/application-id.html).
        applicationId = "com.example.prueba_bim2"
        // You can update the following values to match your application needs.
        // For more information, see: https://flutter.dev/to/review-gradle-config.
        minSdk = flutter.minSdkVersion
        targetSdk = flutter.targetSdkVersion
        versionCode = flutter.versionCode
        versionName = flutter.versionName
    }

    buildTypes {
        release {
            // TODO: Add your own signing config for the release build.
            // Signing with the debug keys for now, so `flutter run --release` works.
            signingConfig = signingConfigs.debug
        }
    }
}

flutter {
    source = "../.."
}
</file>

<file path="android/app/src/debug/AndroidManifest.xml">
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <!-- The INTERNET permission is required for development. Specifically,
         the Flutter tool needs it to communicate with the running application
         to allow setting breakpoints, to provide hot reload, etc.
    -->
    <uses-permission android:name="android.permission.INTERNET"/>
</manifest>
</file>

<file path="android/app/src/main/kotlin/com/example/prueba_bim2/MainActivity.kt">
package com.example.prueba_bim2

import io.flutter.embedding.android.FlutterActivity

class MainActivity: FlutterActivity()
</file>

<file path="android/app/src/main/res/drawable-v21/launch_background.xml">
<?xml version="1.0" encoding="utf-8"?>
<!-- Modify this file to customize your launch splash screen -->
<layer-list xmlns:android="http://schemas.android.com/apk/res/android">
    <item android:drawable="?android:colorBackground" />

    <!-- You can insert your own image assets here -->
    <!-- <item>
        <bitmap
            android:gravity="center"
            android:src="@mipmap/launch_image" />
    </item> -->
</layer-list>
</file>

<file path="android/app/src/main/res/drawable/launch_background.xml">
<?xml version="1.0" encoding="utf-8"?>
<!-- Modify this file to customize your launch splash screen -->
<layer-list xmlns:android="http://schemas.android.com/apk/res/android">
    <item android:drawable="@android:color/white" />

    <!-- You can insert your own image assets here -->
    <!-- <item>
        <bitmap
            android:gravity="center"
            android:src="@mipmap/launch_image" />
    </item> -->
</layer-list>
</file>

<file path="android/app/src/main/res/values-night/styles.xml">
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <!-- Theme applied to the Android Window while the process is starting when the OS's Dark Mode setting is on -->
    <style name="LaunchTheme" parent="@android:style/Theme.Black.NoTitleBar">
        <!-- Show a splash screen on the activity. Automatically removed when
             the Flutter engine draws its first frame -->
        <item name="android:windowBackground">@drawable/launch_background</item>
    </style>
    <!-- Theme applied to the Android Window as soon as the process has started.
         This theme determines the color of the Android Window while your
         Flutter UI initializes, as well as behind your Flutter UI while its
         running.

         This Theme is only used starting with V2 of Flutter's Android embedding. -->
    <style name="NormalTheme" parent="@android:style/Theme.Black.NoTitleBar">
        <item name="android:windowBackground">?android:colorBackground</item>
    </style>
</resources>
</file>

<file path="android/app/src/main/res/values/styles.xml">
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <!-- Theme applied to the Android Window while the process is starting when the OS's Dark Mode setting is off -->
    <style name="LaunchTheme" parent="@android:style/Theme.Light.NoTitleBar">
        <!-- Show a splash screen on the activity. Automatically removed when
             the Flutter engine draws its first frame -->
        <item name="android:windowBackground">@drawable/launch_background</item>
    </style>
    <!-- Theme applied to the Android Window as soon as the process has started.
         This theme determines the color of the Android Window while your
         Flutter UI initializes, as well as behind your Flutter UI while its
         running.

         This Theme is only used starting with V2 of Flutter's Android embedding. -->
    <style name="NormalTheme" parent="@android:style/Theme.Light.NoTitleBar">
        <item name="android:windowBackground">?android:colorBackground</item>
    </style>
</resources>
</file>

<file path="android/app/src/profile/AndroidManifest.xml">
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <!-- The INTERNET permission is required for development. Specifically,
         the Flutter tool needs it to communicate with the running application
         to allow setting breakpoints, to provide hot reload, etc.
    -->
    <uses-permission android:name="android.permission.INTERNET"/>
</manifest>
</file>

<file path="android/build.gradle">
allprojects {
    repositories {
        google()
        mavenCentral()
    }
}

rootProject.buildDir = "../build"
subprojects {
    project.buildDir = "${rootProject.buildDir}/${project.name}"
}
subprojects {
    project.evaluationDependsOn(":app")
}

tasks.register("clean", Delete) {
    delete rootProject.buildDir
}
</file>

<file path="android/gradle.properties">
org.gradle.jvmargs=-Xmx4G -XX:MaxMetaspaceSize=2G -XX:+HeapDumpOnOutOfMemoryError
android.useAndroidX=true
android.enableJetifier=true
</file>

<file path="lib/core/constants/app_constants.dart">
import 'package:flutter_dotenv/flutter_dotenv.dart';

class AppConstants {
  // Supabase Configuration (loaded from .env)
  static String get supabaseUrl => dotenv.env['SUPABASE_URL'] ?? '';
  static String get supabaseAnonKey => dotenv.env['SUPABASE_ANON_KEY'] ?? '';

  // Deep Link Configuration
  static const String appScheme = 'loginpro';

  // Vercel URLs (loaded from .env)
  static String get vercelBaseUrl => dotenv.env['VERCEL_BASE_URL'] ?? '';
  static const String emailVerificationPath = '/verify-email';
  static const String resetPasswordPath = '/reset-password';

  // Error Messages
  static const String networkError = 'Sin conexi贸n a internet';
  static const String serverError = 'Error del servidor';
  static const String authError = 'Error de autenticaci贸n';
  static const String unknownError = 'Error desconocido';
}
</file>

<file path="lib/core/error/failures.dart">
import 'package:equatable/equatable.dart';

abstract class Failure extends Equatable {
  final String message;

  const Failure(this.message);

  @override
  List<Object> get props => [message];
}

class ServerFailure extends Failure {
  const ServerFailure(super.message);
}

class AuthFailure extends Failure {
  const AuthFailure(super.message);
}

class NetworkFailure extends Failure {
  const NetworkFailure(super.message);
}

class CacheFailure extends Failure {
  const CacheFailure(super.message);
}
</file>

<file path="lib/core/network/network_info.dart">
import 'package:connectivity_plus/connectivity_plus.dart';
import 'package:injectable/injectable.dart';

abstract class NetworkInfo {
  Future<bool> get isConnected;
}

@LazySingleton(as: NetworkInfo)
class NetworkInfoImpl implements NetworkInfo {
  final Connectivity connectivity;

  NetworkInfoImpl(this.connectivity);

  @override
  Future<bool> get isConnected async {
    final result = await connectivity.checkConnectivity();
    return result.first != ConnectivityResult.none;
  }
}
</file>

<file path="lib/core/usecase/usecase.dart">
import 'package:dartz/dartz.dart';
import '../error/failures.dart';

abstract class UseCase<Type, Params> {
  Future<Either<Failure, Type>> call(Params params);
}

class NoParams {}
</file>

<file path="lib/features/auth/domain/usecases/get_current_user.dart">
import 'package:dartz/dartz.dart';
import 'package:injectable/injectable.dart';
import '../../../../core/error/failures.dart';
import '../../../../core/usecase/usecase.dart';
import '../entities/user_entity.dart';
import '../repositories/auth_repository.dart';

@injectable
class GetCurrentUser implements UseCase<UserEntity?, NoParams> {
  final AuthRepository repository;

  GetCurrentUser(this.repository);

  @override
  Future<Either<Failure, UserEntity?>> call(NoParams params) async {
    return await repository.getCurrentUser();
  }
}
</file>

<file path="lib/features/auth/domain/usecases/reset_password.dart">
import 'package:dartz/dartz.dart';
import 'package:injectable/injectable.dart';
import '../../../../core/error/failures.dart';
import '../../../../core/usecase/usecase.dart';
import '../repositories/auth_repository.dart';

@injectable
class ResetPassword implements UseCase<void, ResetPasswordParams> {
  final AuthRepository repository;

  ResetPassword(this.repository);

  @override
  Future<Either<Failure, void>> call(ResetPasswordParams params) async {
    return await repository.sendPasswordResetEmail(
      email: params.email,
    );
  }
}

class ResetPasswordParams {
  final String email;

  ResetPasswordParams({
    required this.email,
  });
}
</file>

<file path="lib/features/auth/domain/usecases/sign_in.dart">
import 'package:dartz/dartz.dart';
import 'package:injectable/injectable.dart';
import '../../../../core/error/failures.dart';
import '../../../../core/usecase/usecase.dart';
import '../entities/user_entity.dart';
import '../repositories/auth_repository.dart';

@injectable
class SignIn implements UseCase<UserEntity, SignInParams> {
  final AuthRepository repository;

  SignIn(this.repository);

  @override
  Future<Either<Failure, UserEntity>> call(SignInParams params) async {
    return await repository.signInWithEmailAndPassword(
      email: params.email,
      password: params.password,
    );
  }
}

class SignInParams {
  final String email;
  final String password;

  SignInParams({
    required this.email,
    required this.password,
  });
}
</file>

<file path="lib/features/auth/domain/usecases/sign_out.dart">
import 'package:dartz/dartz.dart';
import 'package:injectable/injectable.dart';
import '../../../../core/error/failures.dart';
import '../../../../core/usecase/usecase.dart';
import '../repositories/auth_repository.dart';

@injectable
class SignOut implements UseCase<void, NoParams> {
  final AuthRepository repository;

  SignOut(this.repository);

  @override
  Future<Either<Failure, void>> call(NoParams params) async {
    return await repository.signOut();
  }
}
</file>

<file path="lib/features/auth/presentation/bloc/auth_state.dart">
import 'package:equatable/equatable.dart';
import '../../domain/entities/user_entity.dart';

abstract class AuthState extends Equatable {
  const AuthState();

  @override
  List<Object?> get props => [];
}

class AuthInitial extends AuthState {
  const AuthInitial();
}

class AuthLoading extends AuthState {
  const AuthLoading();
}

class AuthAuthenticated extends AuthState {
  final UserEntity user;

  const AuthAuthenticated(this.user);

  @override
  List<Object> get props => [user];
}

class AuthUnauthenticated extends AuthState {
  const AuthUnauthenticated();
}

class AuthError extends AuthState {
  final String message;

  const AuthError(this.message);

  @override
  List<Object> get props => [message];
}

class ResetPasswordSent extends AuthState {
  const ResetPasswordSent();
}

class EmailVerificationRequired extends AuthState {
  final String email;

  const EmailVerificationRequired(this.email);

  @override
  List<Object> get props => [email];
}
</file>

<file path="lib/features/auth/presentation/pages/email_verification_sent_page.dart">
import 'package:flutter/material.dart';

class EmailVerificationSentPage extends StatelessWidget {
  final String email;

  const EmailVerificationSentPage({
    super.key,
    required this.email,
  });

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);

    return Scaffold(
      body: SafeArea(
        child: Center(
          child: SingleChildScrollView(
            padding: const EdgeInsets.all(24.0),
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                // Icono de email
                Container(
                  width: 120,
                  height: 120,
                  decoration: BoxDecoration(
                    color: theme.colorScheme.primary.withOpacity(0.1),
                    shape: BoxShape.circle,
                  ),
                  child: Icon(
                    Icons.mark_email_unread_rounded,
                    size: 60,
                    color: theme.colorScheme.primary,
                  ),
                ),
                const SizedBox(height: 32),

                // T铆tulo
                Text(
                  '隆Revisa tu correo!',
                  style: theme.textTheme.headlineMedium?.copyWith(
                    fontWeight: FontWeight.bold,
                    color: theme.colorScheme.onSurface,
                  ),
                  textAlign: TextAlign.center,
                ),
                const SizedBox(height: 16),

                // Mensaje
                Text(
                  'Hemos enviado un enlace de verificaci贸n a:',
                  style: theme.textTheme.bodyLarge?.copyWith(
                    color: theme.colorScheme.onSurface.withOpacity(0.7),
                  ),
                  textAlign: TextAlign.center,
                ),
                const SizedBox(height: 8),

                // Email
                Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 16,
                    vertical: 12,
                  ),
                  decoration: BoxDecoration(
                    color: theme.colorScheme.surfaceContainerHighest,
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Text(
                    email,
                    style: theme.textTheme.titleMedium?.copyWith(
                      fontWeight: FontWeight.w600,
                      color: theme.colorScheme.primary,
                    ),
                  ),
                ),
                const SizedBox(height: 24),

                // Instrucciones
                Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: Colors.amber.withOpacity(0.1),
                    borderRadius: BorderRadius.circular(12),
                    border: Border.all(
                      color: Colors.amber.withOpacity(0.3),
                    ),
                  ),
                  child: Row(
                    children: [
                      const Icon(
                        Icons.info_outline,
                        color: Colors.amber,
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: Text(
                          'Debes confirmar tu correo electr贸nico para poder iniciar sesi贸n en la aplicaci贸n.',
                          style: theme.textTheme.bodyMedium?.copyWith(
                            color: Colors.amber.shade800,
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
                const SizedBox(height: 32),

                // Pasos
                _buildStep(
                  context,
                  number: '1',
                  text: 'Abre tu bandeja de entrada',
                  icon: Icons.inbox_rounded,
                ),
                const SizedBox(height: 12),
                _buildStep(
                  context,
                  number: '2',
                  text: 'Busca el correo de Login Pro',
                  icon: Icons.search_rounded,
                ),
                const SizedBox(height: 12),
                _buildStep(
                  context,
                  number: '3',
                  text: 'Haz clic en el enlace de verificaci贸n',
                  icon: Icons.link_rounded,
                ),
                const SizedBox(height: 40),

                // Bot贸n volver al login
                SizedBox(
                  width: double.infinity,
                  child: FilledButton.icon(
                    onPressed: () {
                      Navigator.of(context).popUntil((route) => route.isFirst);
                    },
                    icon: const Icon(Icons.login_rounded),
                    label: const Text('Ir a Iniciar Sesi贸n'),
                    style: FilledButton.styleFrom(
                      padding: const EdgeInsets.symmetric(vertical: 16),
                    ),
                  ),
                ),
                const SizedBox(height: 16),

                // Nota sobre spam
                Text(
                  '驴No encuentras el correo? Revisa tu carpeta de spam.',
                  style: theme.textTheme.bodySmall?.copyWith(
                    color: theme.colorScheme.onSurface.withOpacity(0.5),
                  ),
                  textAlign: TextAlign.center,
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildStep(
    BuildContext context, {
    required String number,
    required String text,
    required IconData icon,
  }) {
    final theme = Theme.of(context);

    return Row(
      children: [
        Container(
          width: 32,
          height: 32,
          decoration: BoxDecoration(
            color: theme.colorScheme.primary,
            shape: BoxShape.circle,
          ),
          child: Center(
            child: Text(
              number,
              style: const TextStyle(
                color: Colors.white,
                fontWeight: FontWeight.bold,
              ),
            ),
          ),
        ),
        const SizedBox(width: 12),
        Icon(
          icon,
          color: theme.colorScheme.primary.withOpacity(0.7),
          size: 20,
        ),
        const SizedBox(width: 8),
        Expanded(
          child: Text(
            text,
            style: theme.textTheme.bodyMedium,
          ),
        ),
      ],
    );
  }
}
</file>

<file path="lib/features/auth/presentation/pages/profile_page.dart">
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../bloc/auth_bloc.dart';
import '../bloc/auth_event.dart';
import '../bloc/auth_state.dart';

class ProfilePage extends StatelessWidget {
  const ProfilePage({super.key});

  @override
  Widget build(BuildContext context) {
    final user = (context.read<AuthBloc>().state as AuthAuthenticated).user;

    return Scaffold(
      appBar: AppBar(title: const Text('Mi Perfil')),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(24),
        child: Column(
          children: [
            // Foto de perfil
            Center(
              child: Stack(
                children: [
                  CircleAvatar(
                    radius: 60,
                    backgroundImage: user.photoUrl != null
                        ? NetworkImage(user.photoUrl!)
                        : null,
                    backgroundColor: Colors.grey[200],
                    child: user.photoUrl == null
                        ? const Icon(Icons.person, size: 60, color: Colors.grey)
                        : null,
                  ),
                  Positioned(
                    bottom: 0,
                    right: 0,
                    child: CircleAvatar(
                      backgroundColor: Theme.of(context).colorScheme.primary,
                      radius: 20,
                      child: IconButton(
                        icon: const Icon(Icons.camera_alt,
                            size: 20, color: Colors.white),
                        onPressed: () {
                          // TODO: Implementar subida de foto de perfil (Fase de Refinamiento 2)
                          ScaffoldMessenger.of(context).showSnackBar(
                            const SnackBar(
                                content: Text('Pr贸ximamente: Editar foto')),
                          );
                        },
                      ),
                    ),
                  ),
                ],
              ),
            ),
            const SizedBox(height: 32),

            // Datos
            _ProfileItem(
                title: 'Nombre',
                value: user.displayName ?? 'No especificado',
                icon: Icons.person_outline),
            _ProfileItem(
                title: 'Correo', value: user.email, icon: Icons.email_outlined),
            _ProfileItem(
                title: 'Rol',
                value: user.role == 'shelter'
                    ? 'Refugio / Fundaci贸n'
                    : 'Adoptante',
                icon: Icons.verified_user_outlined),

            const SizedBox(height: 40),

            // Botones de acci贸n
            SizedBox(
              width: double.infinity,
              child: OutlinedButton(
                onPressed: () {
                  // TODO: Navegar a pantalla de editar datos
                },
                child: const Text('Editar Perfil'),
              ),
            ),
            const SizedBox(height: 16),
            SizedBox(
              width: double.infinity,
              child: ElevatedButton.icon(
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.red[50],
                  foregroundColor: Colors.red,
                  elevation: 0,
                ),
                onPressed: () {
                  context.read<AuthBloc>().add(const SignOutRequested());
                  Navigator.of(context)
                      .popUntil((route) => route.isFirst); // Volver al inicio
                },
                icon: const Icon(Icons.logout),
                label: const Text('Cerrar Sesi贸n'),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

class _ProfileItem extends StatelessWidget {
  final String title;
  final String value;
  final IconData icon;

  const _ProfileItem(
      {required this.title, required this.value, required this.icon});

  @override
  Widget build(BuildContext context) {
    return Card(
      margin: const EdgeInsets.only(bottom: 16),
      child: ListTile(
        leading: Icon(icon, color: Theme.of(context).colorScheme.primary),
        title: Text(title,
            style: const TextStyle(fontSize: 12, color: Colors.grey)),
        subtitle: Text(value,
            style: const TextStyle(fontSize: 16, fontWeight: FontWeight.w500)),
      ),
    );
  }
}
</file>

<file path="lib/features/auth/presentation/pages/reset_password_page.dart">
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../bloc/auth_bloc.dart';
import '../bloc/auth_event.dart';
import '../bloc/auth_state.dart';
import '../widgets/custom_text_field.dart';
import '../widgets/loading_overlay.dart';

class ResetPasswordPage extends StatefulWidget {
  const ResetPasswordPage({super.key});

  @override
  State<ResetPasswordPage> createState() => _ResetPasswordPageState();
}

class _ResetPasswordPageState extends State<ResetPasswordPage> {
  final _formKey = GlobalKey<FormState>();
  final _emailController = TextEditingController();

  @override
  void dispose() {
    _emailController.dispose();
    super.dispose();
  }

  void _handleResetPassword() {
    if (_formKey.currentState!.validate()) {
      context.read<AuthBloc>().add(
            ResetPasswordRequested(
              email: _emailController.text.trim(),
            ),
          );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: BlocConsumer<AuthBloc, AuthState>(
        listener: (context, state) {
          if (state is AuthError) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: Text(state.message),
                backgroundColor: Theme.of(context).colorScheme.error,
              ),
            );
          } else if (state is ResetPasswordSent) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: const Text(
                  'Se ha enviado un correo de recuperaci贸n. Por favor revisa tu bandeja de entrada.',
                ),
                backgroundColor: Colors.green,
                duration: const Duration(seconds: 5),
              ),
            );
            Navigator.of(context).pop();
          }
        },
        builder: (context, state) {
          final isLoading = state is AuthLoading;

          return LoadingOverlay(
            isLoading: isLoading,
            child: SafeArea(
              child: Center(
                child: SingleChildScrollView(
                  padding: const EdgeInsets.all(24.0),
                  child: Form(
                    key: _formKey,
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      crossAxisAlignment: CrossAxisAlignment.stretch,
                      children: [
                        // Back button
                        Align(
                          alignment: Alignment.centerLeft,
                          child: IconButton(
                            icon: const Icon(Icons.arrow_back),
                            onPressed: () => Navigator.of(context).pop(),
                          ),
                        ),
                        const SizedBox(height: 16),

                        // Logo o icono
                        Icon(
                          Icons.lock_reset_rounded,
                          size: 80,
                          color: Theme.of(context).colorScheme.primary,
                        ),
                        const SizedBox(height: 24),

                        // T铆tulo
                        Text(
                          'Recuperar contrase帽a',
                          style: Theme.of(context).textTheme.displayMedium,
                          textAlign: TextAlign.center,
                        ),
                        const SizedBox(height: 8),
                        Text(
                          'Ingresa tu correo electr贸nico y te enviaremos un enlace para restablecer tu contrase帽a',
                          style: Theme.of(context).textTheme.bodyMedium,
                          textAlign: TextAlign.center,
                        ),
                        const SizedBox(height: 48),

                        // Email field
                        CustomTextField(
                          controller: _emailController,
                          label: 'Correo electr贸nico',
                          hint: 'tu@email.com',
                          prefixIcon: Icons.email_outlined,
                          keyboardType: TextInputType.emailAddress,
                          validator: (value) {
                            if (value == null || value.isEmpty) {
                              return 'Por favor ingresa tu correo';
                            }
                            if (!value.contains('@')) {
                              return 'Por favor ingresa un correo v谩lido';
                            }
                            return null;
                          },
                        ),
                        const SizedBox(height: 32),

                        // Send button
                        SizedBox(
                          height: 56,
                          child: ElevatedButton(
                            onPressed: isLoading ? null : _handleResetPassword,
                            child: const Text('Enviar enlace de recuperaci贸n'),
                          ),
                        ),
                        const SizedBox(height: 24),

                        // Info card
                        Card(
                          child: Padding(
                            padding: const EdgeInsets.all(16.0),
                            child: Row(
                              children: [
                                Icon(
                                  Icons.info_outline,
                                  color: Theme.of(context).colorScheme.primary,
                                ),
                                const SizedBox(width: 12),
                                Expanded(
                                  child: Text(
                                    'Recibir谩s un enlace para crear una nueva contrase帽a',
                                    style: Theme.of(context).textTheme.bodyMedium,
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              ),
            ),
          );
        },
      ),
    );
  }
}
</file>

<file path="lib/features/auth/presentation/widgets/custom_text_field.dart">
import 'package:flutter/material.dart';

class CustomTextField extends StatefulWidget {
  final TextEditingController controller;
  final String label;
  final String hint;
  final IconData? prefixIcon;
  final bool isPassword;
  final TextInputType? keyboardType;
  final String? Function(String?)? validator;

  const CustomTextField({
    super.key,
    required this.controller,
    required this.label,
    required this.hint,
    this.prefixIcon,
    this.isPassword = false,
    this.keyboardType,
    this.validator,
  });

  @override
  State<CustomTextField> createState() => _CustomTextFieldState();
}

class _CustomTextFieldState extends State<CustomTextField> {
  bool _obscureText = true;

  @override
  Widget build(BuildContext context) {
    return TextFormField(
      controller: widget.controller,
      obscureText: widget.isPassword && _obscureText,
      keyboardType: widget.keyboardType,
      validator: widget.validator,
      decoration: InputDecoration(
        labelText: widget.label,
        hintText: widget.hint,
        prefixIcon: widget.prefixIcon != null
            ? Icon(widget.prefixIcon, color: Theme.of(context).colorScheme.primary)
            : null,
        suffixIcon: widget.isPassword
            ? IconButton(
                icon: Icon(
                  _obscureText ? Icons.visibility_outlined : Icons.visibility_off_outlined,
                  color: Theme.of(context).colorScheme.primary,
                ),
                onPressed: () {
                  setState(() {
                    _obscureText = !_obscureText;
                  });
                },
              )
            : null,
      ),
    );
  }
}
</file>

<file path="lib/features/auth/presentation/widgets/loading_overlay.dart">
import 'package:flutter/material.dart';

class LoadingOverlay extends StatelessWidget {
  final bool isLoading;
  final Widget child;

  const LoadingOverlay({
    super.key,
    required this.isLoading,
    required this.child,
  });

  @override
  Widget build(BuildContext context) {
    return Stack(
      children: [
        child,
        if (isLoading)
          Container(
            color: Colors.black.withOpacity(0.3),
            child: const Center(
              child: CircularProgressIndicator(),
            ),
          ),
      ],
    );
  }
}
</file>

<file path="lib/features/pet_management/data/datasources/pet_remote_data_source.dart">
import 'dart:io';
import 'package:injectable/injectable.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:uuid/uuid.dart';
import '../models/pet_model.dart';

abstract class PetRemoteDataSource {
  Future<void> createPet(PetModel pet, File imageFile);
  Future<List<PetModel>> getPets();
  Future<List<PetModel>> getMyPets(String shelterId);
  Future<void> updatePet(PetModel pet, File? newImage);
  Future<void> deletePet(String petId, String imageUrl);
}

@LazySingleton(as: PetRemoteDataSource)
class PetRemoteDataSourceImpl implements PetRemoteDataSource {
  final SupabaseClient supabaseClient;

  PetRemoteDataSourceImpl(this.supabaseClient);

  @override
  Future<void> createPet(PetModel pet, File imageFile) async {
    try {
      // 1. Subir Imagen al Bucket 'pets'
      final fileExt = imageFile.path.split('.').last;
      final fileName = '${const Uuid().v4()}.$fileExt';
      final filePath = 'pets/$fileName';

      await supabaseClient.storage.from('pets').upload(
            filePath,
            imageFile,
            fileOptions: const FileOptions(cacheControl: '3600', upsert: false),
          );

      // 2. Obtener URL p煤blica
      final imageUrl =
          supabaseClient.storage.from('pets').getPublicUrl(filePath);

      // 3. Guardar datos en tabla 'pets' con la URL de la imagen
      final petData = pet.toJson();
      petData['image_url'] = imageUrl; // Actualizamos la URL real

      await supabaseClient.from('pets').insert(petData);
    } catch (e) {
      throw Exception('Error al crear mascota: $e');
    }
  }

  @override
  Future<List<PetModel>> getPets() async {
    try {
      final response = await supabaseClient
          .from('pets')
          .select()
          .eq('is_adopted', false) // Solo las disponibles
          .order('created_at', ascending: false);

      return (response as List).map((e) => PetModel.fromJson(e)).toList();
    } catch (e) {
      throw Exception('Error al cargar mascotas: $e');
    }
  }

  @override
  Future<List<PetModel>> getMyPets(String shelterId) async {
    try {
      final response = await supabaseClient
          .from('pets')
          .select()
          .eq('shelter_id', shelterId)
          .order('created_at', ascending: false);

      return (response as List).map((e) => PetModel.fromJson(e)).toList();
    } catch (e) {
      throw Exception('Error al cargar mis mascotas: $e');
    }
  }

  @override
  Future<void> updatePet(PetModel pet, File? newImage) async {
    try {
      String imageUrl = pet.imageUrl;

      // 1. Si hay nueva imagen, subirla
      if (newImage != null) {
        final fileExt = newImage.path.split('.').last;
        final fileName = '${const Uuid().v4()}.$fileExt';
        final filePath = 'pets/$fileName';

        await supabaseClient.storage.from('pets').upload(
              filePath,
              newImage,
              fileOptions:
                  const FileOptions(cacheControl: '3600', upsert: false),
            );

        imageUrl = supabaseClient.storage.from('pets').getPublicUrl(filePath);

        // Opcional: Borrar la imagen vieja aqu铆 si quieres ahorrar espacio
      }

      // 2. Actualizar datos en la tabla
      final petData = pet.toJson();
      petData['image_url'] =
          imageUrl; // Actualizamos con la nueva (o la misma) URL

      // Eliminamos campos que no deber铆an cambiar o que Supabase ignora
      petData.remove('id');
      petData.remove('created_at');

      await supabaseClient.from('pets').update(petData).eq('id', pet.id);
    } catch (e) {
      throw Exception('Error al actualizar mascota: $e');
    }
  }

  @override
  Future<void> deletePet(String petId, String imageUrl) async {
    try {
      // 1. Borrar registro de la Base de Datos
      await supabaseClient.from('pets').delete().eq('id', petId);

      // 2. Borrar imagen del Storage
      if (imageUrl.isNotEmpty) {
        try {
          final uri = Uri.parse(imageUrl);
          // La URL suele terminar en .../pets/nombre_imagen.jpg
          // Tomamos el 煤ltimo segmento que es el nombre del archivo
          final fileName = uri.pathSegments.last;

          // Asumimos que guardaste en la carpeta 'pets/' dentro del bucket
          await supabaseClient.storage.from('pets').remove(['pets/$fileName']);
        } catch (e) {
          // Si falla borrar la foto, no detenemos el proceso principal
          print('No se pudo borrar la imagen del storage: $e');
        }
      }
    } catch (e) {
      throw Exception('Error al borrar mascota: $e');
    }
  }
}
</file>

<file path="lib/features/pet_management/data/models/pet_model.dart">
import '../../domain/entities/pet_entity.dart';

class PetModel extends PetEntity {
  const PetModel({
    required super.id,
    required super.name,
    required super.species,
    required super.breed,
    required super.age,
    required super.size,
    required super.gender,
    required super.description,
    required super.imageUrl,
    required super.locationLat,
    required super.locationLng,
    required super.shelterId,
    required super.isAdopted,
  });

  // De JSON (Supabase) a Dart
  factory PetModel.fromJson(Map<String, dynamic> json) {
    return PetModel(
      id: json['id'],
      name: json['name'],
      species: json['species'],
      breed: json['breed'] ?? '',
      age: json['age'] ?? '',
      size: json['size'] ?? '',
      gender: json['gender'] ?? '',
      description: json['description'] ?? '',
      imageUrl: json['image_url'] ?? '',
      locationLat: (json['location_lat'] as num?)?.toDouble() ?? 0.0,
      locationLng: (json['location_lng'] as num?)?.toDouble() ?? 0.0,
      shelterId: json['shelter_id'],
      isAdopted: json['is_adopted'] ?? false,
    );
  }

  // De Dart a JSON (Para subir a Supabase)
  Map<String, dynamic> toJson() {
    return {
      'name': name,
      'species': species,
      'breed': breed,
      'age': age,
      'size': size,
      'gender': gender,
      'description': description,
      'image_url': imageUrl,
      'location_lat': locationLat,
      'location_lng': locationLng,
      'shelter_id': shelterId,
    };
  }
}
</file>

<file path="lib/features/pet_management/data/repositories/pet_repository_impl.dart">
import 'dart:io';
import 'package:dartz/dartz.dart';
import 'package:injectable/injectable.dart';
import '../../../../core/error/failures.dart';
import '../../../../core/network/network_info.dart';
import '../../domain/entities/pet_entity.dart';
import '../../domain/repositories/pet_repository.dart';
import '../datasources/pet_remote_data_source.dart';
import '../models/pet_model.dart';

@LazySingleton(as: PetRepository)
class PetRepositoryImpl implements PetRepository {
  final PetRemoteDataSource remoteDataSource;
  final NetworkInfo networkInfo;

  PetRepositoryImpl({
    required this.remoteDataSource,
    required this.networkInfo,
  });

  @override
  Future<Either<Failure, void>> createPet({
    required PetEntity pet,
    required File imageFile,
  }) async {
    if (!await networkInfo.isConnected) {
      return const Left(NetworkFailure('Sin conexi贸n a internet'));
    }
    try {
      // Convertimos Entity a Model
      final petModel = PetModel(
        id: pet.id,
        name: pet.name,
        species: pet.species,
        breed: pet.breed,
        age: pet.age,
        size: pet.size,
        gender: pet.gender,
        description: pet.description,
        imageUrl: '', // Se llenar谩 en el datasource
        locationLat: pet.locationLat,
        locationLng: pet.locationLng,
        shelterId: pet.shelterId,
        isAdopted: pet.isAdopted,
      );

      await remoteDataSource.createPet(petModel, imageFile);
      return const Right(null);
    } catch (e) {
      return Left(ServerFailure(e.toString().replaceAll('Exception: ', '')));
    }
  }

  @override
  Future<Either<Failure, List<PetEntity>>> getPets() async {
    if (!await networkInfo.isConnected) {
      return const Left(NetworkFailure('Sin conexi贸n a internet'));
    }
    try {
      final pets = await remoteDataSource.getPets();
      return Right(pets);
    } catch (e) {
      return Left(ServerFailure(e.toString().replaceAll('Exception: ', '')));
    }
  }

  @override
  Future<Either<Failure, List<PetEntity>>> getMyPets(String shelterId) async {
    if (!await networkInfo.isConnected) {
      return const Left(NetworkFailure('Sin conexi贸n a internet'));
    }
    try {
      final pets = await remoteDataSource.getMyPets(shelterId);
      return Right(pets);
    } catch (e) {
      return Left(ServerFailure(e.toString().replaceAll('Exception: ', '')));
    }
  }

  @override
  Future<Either<Failure, void>> updatePet(
      {required PetEntity pet, File? newImage}) async {
    if (!await networkInfo.isConnected) {
      return const Left(NetworkFailure('Sin conexi贸n a internet'));
    }
    try {
      // Convertir Entity a Model
      final petModel = PetModel(
        id: pet.id,
        name: pet.name,
        species: pet.species,
        breed: pet.breed,
        age: pet.age,
        size: pet.size,
        gender: pet.gender,
        description: pet.description,
        imageUrl: pet.imageUrl,
        locationLat: pet.locationLat,
        locationLng: pet.locationLng,
        shelterId: pet.shelterId,
        isAdopted: pet.isAdopted,
      );

      await remoteDataSource.updatePet(petModel, newImage);
      return const Right(null);
    } catch (e) {
      return Left(ServerFailure(e.toString().replaceAll('Exception: ', '')));
    }
  }

  @override
  Future<Either<Failure, void>> deletePet(String petId, String imageUrl) async {
    if (!await networkInfo.isConnected) {
      return const Left(NetworkFailure('Sin conexi贸n a internet'));
    }
    try {
      await remoteDataSource.deletePet(petId, imageUrl);
      return const Right(null);
    } catch (e) {
      return Left(ServerFailure(e.toString()));
    }
  }
}
</file>

<file path="lib/features/pet_management/domain/entities/pet_entity.dart">
import 'package:equatable/equatable.dart';

class PetEntity extends Equatable {
  final String id;
  final String name;
  final String species;
  final String breed;
  final String age;
  final String size;
  final String gender;
  final String description;
  final String imageUrl;
  final double locationLat;
  final double locationLng;
  final String shelterId;
  final bool isAdopted;

  const PetEntity({
    required this.id,
    required this.name,
    required this.species,
    required this.breed,
    required this.age,
    required this.size,
    required this.gender,
    required this.description,
    required this.imageUrl,
    required this.locationLat,
    required this.locationLng,
    required this.shelterId,
    required this.isAdopted,
  });

  @override
  List<Object?> get props => [id, name, shelterId, imageUrl];
}
</file>

<file path="lib/features/pet_management/domain/repositories/pet_repository.dart">
import 'dart:io';
import 'package:dartz/dartz.dart';
import '../../../../core/error/failures.dart';
import '../entities/pet_entity.dart';

abstract class PetRepository {
  // Subir imagen y crear mascota
  Future<Either<Failure, void>> createPet({
    required PetEntity pet,
    required File imageFile,
  });

  // Leer mascotas (Opcional: filtrar por especie)
  Future<Either<Failure, List<PetEntity>>> getPets();

  // Obtener mis mascotas (para el refugio)
  Future<Either<Failure, List<PetEntity>>> getMyPets(String shelterId);

  Future<Either<Failure, void>> updatePet({
    required PetEntity pet,
    File? newImage, // Opcional
  });

  // Borrar mascota
  Future<Either<Failure, void>> deletePet(String petId, String imageUrl);
}
</file>

<file path="lib/features/pet_management/presentation/bloc/pet_bloc.dart">
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:injectable/injectable.dart';
import '../../domain/repositories/pet_repository.dart';
import 'pet_event.dart';
import 'pet_state.dart';

@injectable
class PetBloc extends Bloc<PetEvent, PetState> {
  final PetRepository repository;

  PetBloc(this.repository) : super(PetInitial()) {
    on<LoadPets>(_onLoadPets);
    on<LoadMyPets>(_onLoadMyPets);
    on<CreatePet>(_onCreatePet);
    on<UpdatePet>(_onUpdatePet);
    on<DeletePet>(_onDeletePet);
  }

  Future<void> _onLoadPets(LoadPets event, Emitter<PetState> emit) async {
    emit(PetLoading());
    final result = await repository.getPets();
    result.fold(
      (failure) => emit(PetError(failure.message)),
      (allPets) {
        // 1. Filtrar por Especie
        var filteredPets = event.filter == 'Todos'
            ? allPets
            : allPets.where((pet) => pet.species == event.filter).toList();

        // 2. Filtrar por Buscador (NUEVO)
        if (event.searchQuery.isNotEmpty) {
          final query = event.searchQuery.toLowerCase();
          filteredPets = filteredPets.where((pet) {
            return pet.name.toLowerCase().contains(query);
          }).toList();
        }

        emit(PetLoaded(filteredPets));
      },
    );
  }

  Future<void> _onLoadMyPets(LoadMyPets event, Emitter<PetState> emit) async {
    emit(PetLoading());
    final result = await repository.getMyPets(event.shelterId);

    result.fold(
      (failure) => emit(PetError(failure.message)),
      (allPets) {
        // 1. Filtrar por Especie
        var filteredPets = event.filter == 'Todos'
            ? allPets
            : allPets.where((pet) => pet.species == event.filter).toList();

        // 2. Filtrar por Buscador (Nombre)
        if (event.searchQuery.isNotEmpty) {
          final query = event.searchQuery.toLowerCase();
          filteredPets = filteredPets.where((pet) {
            return pet.name.toLowerCase().contains(query);
          }).toList();
        }

        emit(PetLoaded(filteredPets));
      },
    );
  }

  Future<void> _onCreatePet(CreatePet event, Emitter<PetState> emit) async {
    emit(PetLoading());
    final result =
        await repository.createPet(pet: event.pet, imageFile: event.imageFile);
    result.fold(
      (failure) => emit(PetError(failure.message)),
      (_) => emit(const PetOperationSuccess('Mascota publicada exitosamente')),
    );
  }

  Future<void> _onUpdatePet(UpdatePet event, Emitter<PetState> emit) async {
    emit(PetLoading());
    final result =
        await repository.updatePet(pet: event.pet, newImage: event.newImage);
    result.fold(
      (failure) => emit(PetError(failure.message)),
      (_) =>
          emit(const PetOperationSuccess('Mascota actualizada correctamente')),
    );
  }

  Future<void> _onDeletePet(DeletePet event, Emitter<PetState> emit) async {
    emit(PetLoading());
    final result = await repository.deletePet(event.petId, event.imageUrl);
    result.fold(
      (failure) => emit(PetError(failure.message)),
      (_) {
        // Despu茅s de borrar, recargamos la lista autom谩ticamente
        add(LoadMyPets(event.shelterId));
      },
    );
  }
}
</file>

<file path="lib/features/pet_management/presentation/bloc/pet_event.dart">
import 'dart:io';
import 'package:equatable/equatable.dart';
import '../../domain/entities/pet_entity.dart';

abstract class PetEvent extends Equatable {
  const PetEvent();
  @override
  List<Object?> get props => [];
}

// Cargar todas las mascotas (para el Home Adoptante)
class LoadPets extends PetEvent {
  final String filter;
  final String searchQuery; // <--- NUEVO CAMPO

  const LoadPets(
      {this.filter = 'Todos',
      this.searchQuery = '' // <--- Valor por defecto vac铆o
      });

  @override
  List<Object> get props => [filter, searchQuery];
}

// Cargar SOLO mis mascotas (para el Panel del Refugio)
class LoadMyPets extends PetEvent {
  final String shelterId;
  final String filter; // 'Todos', 'Perro', 'Gato'
  final String searchQuery; // Texto del buscador

  const LoadMyPets(this.shelterId,
      {this.filter = 'Todos', this.searchQuery = ''});

  @override
  List<Object> get props => [shelterId, filter, searchQuery];
}

// Crear una nueva mascota
class CreatePet extends PetEvent {
  final PetEntity pet;
  final File imageFile;

  const CreatePet({required this.pet, required this.imageFile});
  @override
  List<Object> get props => [pet, imageFile];
}

// Actualizar una mascota existente
class UpdatePet extends PetEvent {
  final PetEntity pet;
  final File? newImage;

  const UpdatePet({required this.pet, this.newImage});
  @override
  List<Object?> get props => [pet, newImage];
}

// Borrar una mascota
class DeletePet extends PetEvent {
  final String petId;
  final String imageUrl;
  final String shelterId; // Para recargar la lista despu茅s

  const DeletePet({
    required this.petId,
    required this.imageUrl,
    required this.shelterId,
  });
  @override
  List<Object> get props => [petId, imageUrl, shelterId];
}
</file>

<file path="lib/features/pet_management/presentation/bloc/pet_state.dart">
import 'package:equatable/equatable.dart';
import '../../domain/entities/pet_entity.dart';

abstract class PetState extends Equatable {
  const PetState();
  @override
  List<Object?> get props => [];
}

class PetInitial extends PetState {}

class PetLoading extends PetState {}

class PetLoaded extends PetState {
  final List<PetEntity> pets;
  const PetLoaded(this.pets);
  @override
  List<Object> get props => [pets];
}

class PetOperationSuccess extends PetState {
  final String message;
  const PetOperationSuccess(this.message);
  @override
  List<Object> get props => [message];
}

class PetError extends PetState {
  final String message;
  const PetError(this.message);
  @override
  List<Object> get props => [message];
}
</file>

<file path="lib/features/pet_management/presentation/pages/location_picker_page.dart">
import 'package:flutter/material.dart';
import 'package:flutter_map/flutter_map.dart';
import 'package:latlong2/latlong.dart';

class LocationPickerPage extends StatefulWidget {
  final LatLng? initialLocation; // Para cuando editamos

  const LocationPickerPage({super.key, this.initialLocation});

  @override
  State<LocationPickerPage> createState() => _LocationPickerPageState();
}

class _LocationPickerPageState extends State<LocationPickerPage> {
  // Coordenada por defecto (Quito Centro-Norte)
  LatLng _selectedLocation = const LatLng(-0.180653, -78.467834);
  final MapController _mapController = MapController();

  // DATOS QUEMADOS (Refugios conocidos)
  final Map<String, LatLng> _shelters = {
    'Poliperros EPN': const LatLng(-0.210300, -78.489000), // Cerca de la Poli
    'PAE Tumbaco': const LatLng(-0.217300, -78.402000), // Referencial
    'Parque La Carolina': const LatLng(-0.180653, -78.467834),
  };

  @override
  void initState() {
    super.initState();
    if (widget.initialLocation != null) {
      // Si la ubicaci贸n guardada no es 0,0, la usamos
      if (widget.initialLocation!.latitude != 0) {
        _selectedLocation = widget.initialLocation!;
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Seleccionar Ubicaci贸n'),
        actions: [
          IconButton(
            icon: const Icon(Icons.check),
            onPressed: () {
              // Retornamos la coordenada seleccionada a la pantalla anterior
              Navigator.pop(context, _selectedLocation);
            },
          )
        ],
      ),
      body: Column(
        children: [
          // 1. Botones de "Datos Quemados" (Para el Ingeniero)
          Container(
            height: 60,
            padding: const EdgeInsets.symmetric(vertical: 8),
            child: ListView(
              scrollDirection: Axis.horizontal,
              padding: const EdgeInsets.symmetric(horizontal: 16),
              children: _shelters.entries.map((entry) {
                return Padding(
                  padding: const EdgeInsets.only(right: 10),
                  child: ActionChip(
                    avatar: const Icon(Icons.pin_drop, size: 16),
                    label: Text(entry.key),
                    onPressed: () {
                      setState(() {
                        _selectedLocation = entry.value;
                      });
                      _mapController.move(entry.value, 15.0);
                    },
                  ),
                );
              }).toList(),
            ),
          ),

          // 2. El Mapa Interactivo
          Expanded(
            child: FlutterMap(
              mapController: _mapController,
              options: MapOptions(
                initialCenter: _selectedLocation,
                initialZoom: 14.0,
                onTap: (tapPosition, point) {
                  // Al tocar el mapa, movemos el pin
                  setState(() {
                    _selectedLocation = point;
                  });
                },
              ),
              children: [
                TileLayer(
                  urlTemplate: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
                  userAgentPackageName: 'com.example.petadopt',
                ),
                MarkerLayer(
                  markers: [
                    Marker(
                      point: _selectedLocation,
                      width: 50,
                      height: 50,
                      child: const Icon(
                        Icons.location_on,
                        color: Colors.red,
                        size: 50,
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),

          // 3. Coordenadas (Info visual)
          Container(
            padding: const EdgeInsets.all(16),
            color: Colors.white,
            width: double.infinity,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text('Ubicaci贸n seleccionada:',
                    style: TextStyle(fontWeight: FontWeight.bold)),
                Text(
                    '${_selectedLocation.latitude}, ${_selectedLocation.longitude}'),
                const SizedBox(height: 10),
                SizedBox(
                  width: double.infinity,
                  child: ElevatedButton(
                    onPressed: () {
                      Navigator.pop(context, _selectedLocation);
                    },
                    child: const Text('Confirmar Ubicaci贸n'),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}
</file>

<file path="lib/features/pet_management/presentation/pages/map_page.dart">
import 'package:flutter/material.dart';
import 'package:flutter_map/flutter_map.dart';
import 'package:latlong2/latlong.dart';
import 'package:geolocator/geolocator.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../../injection_container.dart';
import '../bloc/pet_bloc.dart';
import '../bloc/pet_event.dart';
import '../bloc/pet_state.dart';
import '../../domain/entities/pet_entity.dart'; // Import necesario
import 'pet_detail_page.dart';

class MapPage extends StatefulWidget {
  const MapPage({super.key});

  @override
  State<MapPage> createState() => _MapPageState();
}

class _MapPageState extends State<MapPage> {
  final MapController _mapController = MapController();
  LatLng? _myLocation;
  bool _isLoadingLocation = true;

  @override
  void initState() {
    super.initState();
    _determinePosition();
  }

  Future<void> _determinePosition() async {
    // ... (Misma l贸gica de permisos que ya ten铆as, la omito para ahorrar espacio visual, mantenla igual) ...
    // Aseg煤rate de copiar tu l贸gica de _determinePosition aqu铆
    // Si quieres te la pego completa abajo, pero es la misma de antes.
    bool serviceEnabled;
    LocationPermission permission;

    serviceEnabled = await Geolocator.isLocationServiceEnabled();
    if (!serviceEnabled) {
      if (mounted) setState(() => _isLoadingLocation = false);
      return;
    }

    permission = await Geolocator.checkPermission();
    if (permission == LocationPermission.denied) {
      permission = await Geolocator.requestPermission();
      if (permission == LocationPermission.denied) {
        if (mounted) setState(() => _isLoadingLocation = false);
        return;
      }
    }

    if (permission == LocationPermission.deniedForever) {
      if (mounted) setState(() => _isLoadingLocation = false);
      return;
    }

    final position = await Geolocator.getCurrentPosition();
    if (mounted) {
      setState(() {
        _myLocation = LatLng(position.latitude, position.longitude);
        _isLoadingLocation = false;
      });
      _mapController.move(_myLocation!, 14.0);
    }
  }

  String _getDistanceString(LatLng point) {
    if (_myLocation == null) return 'Calculando...';
    final Distance distance = const Distance();
    final double km = distance.as(LengthUnit.Kilometer, _myLocation!, point);
    if (km < 1) {
      final double m = distance.as(LengthUnit.Meter, _myLocation!, point);
      return '${m.round()} m';
    }
    return '${km.toStringAsFixed(1)} km';
  }

  // Helper para obtener nombre del lugar basado en coordenadas (Hardcode inverso)
  String _getLocationName(double lat, double lng) {
    // Tolerancia peque帽a por si los decimales var铆an m铆nimamente
    if ((lat - -0.210300).abs() < 0.001 && (lng - -78.489000).abs() < 0.001)
      return 'Poliperros EPN';
    if ((lat - -0.217300).abs() < 0.001 && (lng - -78.402000).abs() < 0.001)
      return 'PAE Tumbaco';
    if ((lat - -0.180653).abs() < 0.001 && (lng - -78.467834).abs() < 0.001)
      return 'Parque La Carolina';
    return 'Refugio Registrado';
  }

  @override
  Widget build(BuildContext context) {
    return BlocProvider(
      create: (_) => getIt<PetBloc>()..add(const LoadPets()),
      child: Scaffold(
        body: Stack(
          children: [
            FlutterMap(
              mapController: _mapController,
              options: MapOptions(
                initialCenter: const LatLng(-0.180653, -78.467834),
                initialZoom: 13.0,
              ),
              children: [
                TileLayer(
                  urlTemplate: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
                  userAgentPackageName: 'com.example.petadopt',
                ),
                BlocBuilder<PetBloc, PetState>(
                  builder: (context, state) {
                    List<Marker> markers = [];

                    // 1. MI UBICACIN
                    if (_myLocation != null) {
                      markers.add(
                        Marker(
                          point: _myLocation!,
                          width: 60,
                          height: 60,
                          child: const Column(
                            children: [
                              Icon(Icons.location_history,
                                  color: Colors.blue, size: 40),
                              Text('Yo',
                                  style: TextStyle(
                                      fontWeight: FontWeight.bold,
                                      fontSize: 10)),
                            ],
                          ),
                        ),
                      );
                    }

                    // 2. LOGICA DE AGRUPACIN DE MASCOTAS
                    if (state is PetLoaded) {
                      // Map para agrupar: "lat,lng" -> [Lista de mascotas]
                      final Map<String, List<PetEntity>> groupedPets = {};

                      for (var pet in state.pets) {
                        if (pet.locationLat == 0 && pet.locationLng == 0)
                          continue;

                        // Clave 煤nica basada en posici贸n
                        final key = '${pet.locationLat},${pet.locationLng}';
                        if (!groupedPets.containsKey(key)) {
                          groupedPets[key] = [];
                        }
                        groupedPets[key]!.add(pet);
                      }

                      // Crear un marcador por cada GRUPO (Ubicaci贸n)
                      groupedPets.forEach((key, petsAtLocation) {
                        final lat = petsAtLocation.first.locationLat;
                        final lng = petsAtLocation.first.locationLng;
                        final point = LatLng(lat, lng);
                        final count = petsAtLocation.length;

                        markers.add(
                          Marker(
                            point: point,
                            width: 60, height: 60, // Un poco m谩s grande
                            child: GestureDetector(
                              onTap: () {
                                _showPetsAtLocation(
                                    context, petsAtLocation, point);
                              },
                              child: Stack(
                                alignment: Alignment.center,
                                children: [
                                  const Icon(Icons.location_on,
                                      color: Colors.red, size: 50),
                                  // Si hay m谩s de 1, mostramos el n煤mero
                                  if (count > 1)
                                    Positioned(
                                      top: 5,
                                      child: Container(
                                        padding: const EdgeInsets.all(4),
                                        decoration: const BoxDecoration(
                                          color: Colors.white,
                                          shape: BoxShape.circle,
                                        ),
                                        child: Text(
                                          '$count',
                                          style: const TextStyle(
                                              fontWeight: FontWeight.bold,
                                              fontSize: 12),
                                        ),
                                      ),
                                    ),
                                ],
                              ),
                            ),
                          ),
                        );
                      });
                    }
                    return MarkerLayer(markers: markers);
                  },
                ),
              ],
            ),

            // Bot贸n GPS (Igual que antes)
            Positioned(
              right: 20,
              bottom: 40,
              child: FloatingActionButton(
                heroTag: 'gps_fab',
                onPressed: () {
                  if (_myLocation != null)
                    _mapController.move(_myLocation!, 15.0);
                  else
                    _determinePosition();
                },
                child: _isLoadingLocation
                    ? const Padding(
                        padding: EdgeInsets.all(12),
                        child: CircularProgressIndicator(color: Colors.white))
                    : const Icon(Icons.my_location),
              ),
            ),
          ],
        ),
      ),
    );
  }

  // --- NUEVO MODAL: LISTA DE MASCOTAS ---
  void _showPetsAtLocation(
      BuildContext context, List<PetEntity> pets, LatLng point) {
    final distanceStr = _getDistanceString(point);
    final locationName = _getLocationName(point.latitude, point.longitude);

    showModalBottomSheet(
      context: context,
      isScrollControlled:
          true, // Para permitir que sea m谩s alto si es necesario
      backgroundColor: Colors.transparent,
      builder: (_) => Container(
        height: 400, // Altura fija suficiente para lista
        decoration: const BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
        ),
        padding: const EdgeInsets.fromLTRB(20, 10, 20, 20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Barra deslizadora
            Center(
              child: Container(
                width: 40,
                height: 4,
                margin: const EdgeInsets.only(bottom: 15),
                decoration: BoxDecoration(
                    color: Colors.grey[300],
                    borderRadius: BorderRadius.circular(2)),
              ),
            ),

            // T铆tulo de la Ubicaci贸n
            Text(locationName,
                style:
                    const TextStyle(fontSize: 20, fontWeight: FontWeight.bold)),
            Row(
              children: [
                const Icon(Icons.location_on, size: 14, color: Colors.grey),
                const SizedBox(width: 4),
                Text('A $distanceStr de ti',
                    style: const TextStyle(color: Colors.grey)),
                const SizedBox(width: 10),
                Container(
                  padding:
                      const EdgeInsets.symmetric(horizontal: 8, vertical: 2),
                  decoration: BoxDecoration(
                      color: Colors.orange.shade100,
                      borderRadius: BorderRadius.circular(10)),
                  child: Text('${pets.length} mascotas',
                      style: TextStyle(
                          fontSize: 12, color: Colors.orange.shade900)),
                )
              ],
            ),
            const SizedBox(height: 15),
            const Divider(),

            // LISTA DE MASCOTAS EN ESTE LUGAR
            Expanded(
              child: ListView.separated(
                itemCount: pets.length,
                separatorBuilder: (_, __) => const SizedBox(height: 15),
                itemBuilder: (context, index) {
                  final pet = pets[index];
                  return GestureDetector(
                    onTap: () {
                      Navigator.pop(context); // Cerrar modal
                      Navigator.push(
                        context,
                        MaterialPageRoute(
                          builder: (_) => PetDetailPage(
                            pet: pet,
                            userLocation: _myLocation,
                            locationName:
                                locationName, // Pasamos el nombre del lugar
                          ),
                        ),
                      );
                    },
                    child: Container(
                      padding: const EdgeInsets.all(10),
                      decoration: BoxDecoration(
                        color: Colors.grey[50],
                        borderRadius: BorderRadius.circular(15),
                        border: Border.all(color: Colors.grey.shade200),
                      ),
                      child: Row(
                        children: [
                          // Foto
                          ClipRRect(
                            borderRadius: BorderRadius.circular(10),
                            child: Image.network(
                              pet.imageUrl,
                              width: 80,
                              height: 80,
                              fit: BoxFit.cover,
                              errorBuilder: (_, __, ___) => Container(
                                  width: 80,
                                  height: 80,
                                  color: Colors.grey[300]),
                            ),
                          ),
                          const SizedBox(width: 15),
                          // Info
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(pet.name,
                                    style: const TextStyle(
                                        fontSize: 18,
                                        fontWeight: FontWeight.bold)),
                                Text('${pet.breed}  ${pet.age}',
                                    style: TextStyle(
                                        color: Colors.grey[600], fontSize: 13)),
                                const SizedBox(height: 8),
                                const Text('Ver detalles >',
                                    style: TextStyle(
                                        color: Colors.orange,
                                        fontWeight: FontWeight.bold,
                                        fontSize: 12)),
                              ],
                            ),
                          ),
                        ],
                      ),
                    ),
                  );
                },
              ),
            ),
          ],
        ),
      ),
    );
  }
}
</file>

<file path="lib/features/pet_management/presentation/pages/shelter_home_page.dart">
import 'dart:async'; // Necesario para el Timer del buscador (Debounce)
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../../injection_container.dart';
import '../../../auth/presentation/bloc/auth_bloc.dart';
import '../../../auth/presentation/bloc/auth_event.dart';
import '../../../auth/presentation/bloc/auth_state.dart';
import '../../../auth/presentation/pages/profile_page.dart';
import '../../domain/entities/pet_entity.dart';
import '../bloc/pet_bloc.dart';
import '../bloc/pet_event.dart';
import '../bloc/pet_state.dart';
import 'create_pet_page.dart';

class ShelterHomePage extends StatefulWidget {
  final String userId;
  const ShelterHomePage({super.key, required this.userId});

  @override
  State<ShelterHomePage> createState() => _ShelterHomePageState();
}

class _ShelterHomePageState extends State<ShelterHomePage> {
  int _currentIndex = 0;

  // Variables para filtros
  String _currentFilter = 'Todos';
  String _searchQuery = '';
  Timer? _debounce; // Para no buscar en cada tecla, sino al dejar de escribir

  @override
  void dispose() {
    _debounce?.cancel();
    super.dispose();
  }

  // Funci贸n para manejar el cambio de filtro (Especie)
  void _onFilterChanged(BuildContext context, String filter) {
    setState(() => _currentFilter = filter);
    context.read<PetBloc>().add(LoadMyPets(widget.userId,
        filter: _currentFilter, searchQuery: _searchQuery));
  }

  // Funci贸n para manejar la b煤squeda (Nombre)
  void _onSearchChanged(BuildContext context, String query) {
    setState(() => _searchQuery = query);

    // Usamos un "debounce" para esperar 500ms a que termine de escribir
    if (_debounce?.isActive ?? false) _debounce!.cancel();
    _debounce = Timer(const Duration(milliseconds: 500), () {
      context.read<PetBloc>().add(LoadMyPets(widget.userId,
          filter: _currentFilter, searchQuery: _searchQuery));
    });
  }

  @override
  Widget build(BuildContext context) {
    final authState = context.watch<AuthBloc>().state;
    String shelterName = 'Refugio';
    if (authState is AuthAuthenticated) {
      shelterName = authState.user.displayName ?? 'Refugio';
    }

    return BlocProvider(
      create: (_) => getIt<PetBloc>()..add(LoadMyPets(widget.userId)),
      child: Scaffold(
        backgroundColor: const Color(0xFFF5F7FA),
        floatingActionButton: _currentIndex == 0
            ? FloatingActionButton.extended(
                onPressed: () async {
                  await Navigator.push(context,
                      MaterialPageRoute(builder: (_) => const CreatePetPage()));
                  if (context.mounted) setState(() {});
                },
                label: const Text('Nueva Mascota'),
                icon: const Icon(Icons.add),
                backgroundColor: Theme.of(context).colorScheme.primary,
                foregroundColor: Colors.white,
              )
            : null,
        body: SafeArea(
          child: _currentIndex == 0
              ? _buildDashboard(context, shelterName)
              : _currentIndex == 1
                  ? const Center(child: Text('Solicitudes (Fase 5)'))
                  : const ProfilePage(),
        ),
        bottomNavigationBar: BottomNavigationBar(
          currentIndex: _currentIndex,
          onTap: (index) => setState(() => _currentIndex = index),
          selectedItemColor: Theme.of(context).colorScheme.primary,
          items: const [
            BottomNavigationBarItem(
                icon: Icon(Icons.dashboard), label: 'Panel'),
            BottomNavigationBarItem(
                icon: Icon(Icons.description), label: 'Solicitudes'),
            BottomNavigationBarItem(icon: Icon(Icons.person), label: 'Perfil'),
          ],
        ),
      ),
    );
  }

  Widget _buildDashboard(BuildContext context, String name) {
    // Usamos un Builder interno para tener acceso al contexto del PetBloc
    return Builder(builder: (dashboardContext) {
      return Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Encabezado + Buscador
          Container(
            padding: const EdgeInsets.all(24.0),
            color: Colors.white,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text('Panel de Administraci贸n',
                            style: TextStyle(color: Colors.grey[600])),
                        const SizedBox(height: 4),
                        Text(name,
                            style: const TextStyle(
                                fontSize: 24,
                                fontWeight: FontWeight.bold,
                                color: Color(0xFF2D3436))),
                      ],
                    ),
                    // Bot贸n de Salir (Igual que en Adoptante)
                    CircleAvatar(
                      backgroundColor: const Color(0xFFF5F7FA),
                      child: IconButton(
                        icon: const Icon(Icons.logout, color: Colors.black54),
                        onPressed: () => dashboardContext
                            .read<AuthBloc>()
                            .add(const SignOutRequested()),
                      ),
                    ),
                  ],
                ),
                
                // BUSCADOR
                TextField(
                  onChanged: (value) =>
                      _onSearchChanged(dashboardContext, value),
                  decoration: InputDecoration(
                    hintText: 'Buscar mascota...',
                    prefixIcon: const Icon(Icons.search, color: Colors.grey),
                    filled: true,
                    fillColor: const Color(0xFFF5F7FA),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(12),
                      borderSide: BorderSide.none,
                    ),
                    contentPadding: const EdgeInsets.symmetric(vertical: 0),
                  ),
                ),

                const SizedBox(height: 16),

                // FILTROS (Chips)
                Row(
                  children: [
                    _AdminFilterChip(
                        label: 'Todos',
                        isSelected: _currentFilter == 'Todos',
                        onTap: () =>
                            _onFilterChanged(dashboardContext, 'Todos')),
                    const SizedBox(width: 8),
                    _AdminFilterChip(
                        label: 'Perro',
                        isSelected: _currentFilter == 'Perro',
                        onTap: () =>
                            _onFilterChanged(dashboardContext, 'Perro')),
                    const SizedBox(width: 8),
                    _AdminFilterChip(
                        label: 'Gato',
                        isSelected: _currentFilter == 'Gato',
                        onTap: () =>
                            _onFilterChanged(dashboardContext, 'Gato')),
                  ],
                ),
              ],
            ),
          ),

          // Grilla de Resultados
          Expanded(
            child: BlocBuilder<PetBloc, PetState>(
              builder: (context, state) {
                if (state is PetLoading)
                  return const Center(child: CircularProgressIndicator());
                if (state is PetLoaded) {
                  if (state.pets.isEmpty) {
                    return Center(
                      child: Column(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          Icon(Icons.search_off,
                              size: 60, color: Colors.grey[300]),
                          const SizedBox(height: 10),
                          Text('No se encontraron mascotas ($_currentFilter)'),
                        ],
                      ),
                    );
                  }
                  return RefreshIndicator(
                    onRefresh: () async =>
                        context.read<PetBloc>().add(LoadMyPets(
                              widget.userId,
                              filter: _currentFilter,
                              searchQuery: _searchQuery,
                            )),
                    child: GridView.builder(
                      padding: const EdgeInsets.symmetric(
                          horizontal: 16, vertical: 16),
                      gridDelegate:
                          const SliverGridDelegateWithFixedCrossAxisCount(
                        crossAxisCount: 2,
                        childAspectRatio: 0.7,
                        crossAxisSpacing: 16,
                        mainAxisSpacing: 16,
                      ),
                      itemCount: state.pets.length,
                      itemBuilder: (context, index) {
                        final pet = state.pets[index];
                        return Container(
                          decoration: BoxDecoration(
                            color: Colors.white,
                            borderRadius: BorderRadius.circular(16),
                            boxShadow: [
                              BoxShadow(
                                  color: Colors.black.withOpacity(0.05),
                                  blurRadius: 5)
                            ],
                          ),
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.stretch,
                            children: [
                              // Foto
                              Expanded(
                                child: ClipRRect(
                                  borderRadius: const BorderRadius.vertical(
                                      top: Radius.circular(16)),
                                  child: Image.network(
                                    pet.imageUrl,
                                    fit: BoxFit.cover,
                                    errorBuilder: (_, __, ___) => Container(
                                        color: Colors.grey[200],
                                        child: const Icon(Icons.pets)),
                                  ),
                                ),
                              ),
                              // Datos
                              Padding(
                                padding: const EdgeInsets.all(8.0),
                                child: Column(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    Text(pet.name,
                                        style: const TextStyle(
                                            fontWeight: FontWeight.bold,
                                            fontSize: 16)),
                                    Text(pet.breed,
                                        style: const TextStyle(
                                            fontSize: 12, color: Colors.grey),
                                        maxLines: 1),
                                  ],
                                ),
                              ),
                              // Botones
                              Padding(
                                padding: const EdgeInsets.symmetric(
                                    horizontal: 8.0, vertical: 8.0),
                                child: Row(
                                  children: [
                                    Expanded(
                                      child: OutlinedButton(
                                        onPressed: () async {
                                          await Navigator.push(
                                              context,
                                              MaterialPageRoute(
                                                  builder: (_) => CreatePetPage(
                                                      petToEdit: pet)));
                                          if (context.mounted)
                                            context.read<PetBloc>().add(
                                                LoadMyPets(widget.userId,
                                                    filter: _currentFilter));
                                        },
                                        style: OutlinedButton.styleFrom(
                                          padding: EdgeInsets.zero,
                                          minimumSize: const Size(0, 30),
                                          side: BorderSide(
                                              color: Colors.blue.shade200),
                                        ),
                                        child: const Icon(Icons.edit,
                                            size: 16, color: Colors.blue),
                                      ),
                                    ),
                                    const SizedBox(width: 8),
                                    Expanded(
                                      child: OutlinedButton(
                                        onPressed: () =>
                                            _confirmDelete(context, pet),
                                        style: OutlinedButton.styleFrom(
                                          padding: EdgeInsets.zero,
                                          minimumSize: const Size(0, 30),
                                          side: BorderSide(
                                              color: Colors.red.shade200),
                                        ),
                                        child: const Icon(Icons.delete,
                                            size: 16, color: Colors.red),
                                      ),
                                    ),
                                  ],
                                ),
                              )
                            ],
                          ),
                        );
                      },
                    ),
                  );
                }
                return const SizedBox.shrink();
              },
            ),
          ),
        ],
      );
    });
  }

  void _confirmDelete(BuildContext context, PetEntity pet) {
    showDialog(
      context: context,
      builder: (dialogContext) => AlertDialog(
        title: const Text('驴Eliminar mascota?'),
        content: Text(
            'Est谩s a punto de eliminar a ${pet.name}. Esta acci贸n no se puede deshacer.'),
        actions: [
          TextButton(
              onPressed: () => Navigator.pop(dialogContext),
              child: const Text('Cancelar')),
          TextButton(
            onPressed: () {
              Navigator.pop(dialogContext);
              context.read<PetBloc>().add(DeletePet(
                  petId: pet.id,
                  imageUrl: pet.imageUrl,
                  shelterId: widget.userId));
            },
            child: const Text('Eliminar', style: TextStyle(color: Colors.red)),
          ),
        ],
      ),
    );
  }
}

// Chip de filtro simple (Copia local estilizada para admin)
class _AdminFilterChip extends StatelessWidget {
  final String label;
  final bool isSelected;
  final VoidCallback onTap;

  const _AdminFilterChip(
      {required this.label, required this.isSelected, required this.onTap});

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 6),
        decoration: BoxDecoration(
          color:
              isSelected ? Theme.of(context).colorScheme.primary : Colors.white,
          borderRadius: BorderRadius.circular(20),
          border: isSelected ? null : Border.all(color: Colors.grey.shade300),
        ),
        child: Text(
          label,
          style: TextStyle(
            color: isSelected ? Colors.white : Colors.grey[700],
            fontWeight: FontWeight.bold,
            fontSize: 13,
          ),
        ),
      ),
    );
  }
}
</file>

<file path="lib/injection_container.dart">
import 'package:connectivity_plus/connectivity_plus.dart';
import 'package:get_it/get_it.dart';
import 'package:injectable/injectable.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:http/http.dart' as http; // <--- Importante para el cliente HTTP

import 'core/constants/app_constants.dart';
import 'injection_container.config.dart';

// Imports de la funcionalidad de IA
import 'features/ai_assistant/data/datasources/ai_remote_data_source.dart';
import 'features/ai_assistant/data/repositories/ai_repository_impl.dart';
import 'features/ai_assistant/domain/repositories/ai_repository.dart';
import 'features/ai_assistant/presentation/bloc/chat_bloc.dart';

// Definimos la instancia global
final getIt = GetIt.instance;

@InjectableInit()
Future<void> configureDependencies() async {
  // 1. Inicializar Supabase (Base de datos)
  await Supabase.initialize(
    url: AppConstants.supabaseUrl,
    anonKey: AppConstants.supabaseAnonKey,
  );

  // 2. Registrar Dependencias Externas
  getIt.registerLazySingleton<SupabaseClient>(() => Supabase.instance.client);
  getIt.registerLazySingleton<Connectivity>(() => Connectivity());

  // ---> AQU REGISTRAMOS EL CLIENTE HTTP MANUALMENTE <---
  getIt.registerLazySingleton<http.Client>(() => http.Client());

  // 3. Inicializar las inyecciones generadas autom谩ticamente (Auth, Pets, etc.)
  // Esto carga lo que ya ten铆as configurado con @injectable
  getIt.init();

  // ====================================================
  //  4. FEATURE: AI ASSISTANT (CHAT) - REGISTRO MANUAL
  // ====================================================

  // Data Source: Necesita el http.Client que registramos arriba
  getIt.registerLazySingleton<AIRemoteDataSource>(
    () => AIRemoteDataSourceImpl(getIt()),
  );

  // Repository: Necesita el Data Source
  getIt.registerLazySingleton<AIRepository>(
    () => AIRepositoryImpl(getIt()),
  );

  // BLoC: Necesita el Repository
  // Usamos registerFactory para que se cree uno nuevo cada vez que entras al chat
  getIt.registerFactory(
    () => ChatBloc(getIt()),
  );
}
</file>

<file path="README.md">
# prueba_bim2

A new Flutter project.

## Getting Started

This project is a starting point for a Flutter application.

A few resources to get you started if this is your first Flutter project:

- [Lab: Write your first Flutter app](https://docs.flutter.dev/get-started/codelab)
- [Cookbook: Useful Flutter samples](https://docs.flutter.dev/cookbook)

For help getting started with Flutter development, view the
[online documentation](https://docs.flutter.dev/), which offers tutorials,
samples, guidance on mobile development, and a full API reference.
</file>

<file path="vercel/.gitignore">
.vercel
.env*.local
</file>

<file path="vercel/api/config.js">
// Vercel Serverless Function para exponer variables de entorno
export default function handler(req, res) {
  // CORS headers
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') {
    res.status(200).end();
    return;
  }

  // Retornar solo las variables p煤blicas 
  res.status(200).json({
    supabaseUrl: process.env.SUPABASE_URL,
    supabaseAnonKey: process.env.SUPABASE_ANON_KEY,
  });
}
</file>

<file path="vercel/package.json">
{
  "name": "login-pro-vercel",
  "version": "1.0.0",
  "description": "Vercel pages for email verification and password reset",
  "scripts": {
    "deploy": "vercel --prod"
  },
  "dependencies": {},
  "devDependencies": {}
}
</file>

<file path="vercel/public/reset-password.html">
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Restablecer Contrase帽a - Login Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        padding: 48px;
        max-width: 500px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      .icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 24px;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .icon svg {
        width: 40px;
        height: 40px;
        fill: white;
      }

      .icon.success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      }

      h1 {
        color: #2d3436;
        font-size: 28px;
        margin-bottom: 16px;
        text-align: center;
      }

      p {
        color: #636e72;
        font-size: 16px;
        line-height: 1.6;
        margin-bottom: 32px;
        text-align: center;
      }

      .form-group {
        margin-bottom: 24px;
      }

      label {
        display: block;
        color: #2d3436;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      input {
        width: 100%;
        padding: 16px 20px;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        font-size: 16px;
        transition: all 0.3s ease;
      }

      input:focus {
        outline: none;
        border-color: #f5576c;
      }

      input.error {
        border-color: #ff6b6b;
      }

      .password-requirements {
        margin-top: 12px;
        padding: 16px;
        background: #f8f9fa;
        border-radius: 8px;
        font-size: 14px;
      }

      .requirement {
        display: flex;
        align-items: center;
        color: #636e72;
        margin-bottom: 8px;
      }

      .requirement:last-child {
        margin-bottom: 0;
      }

      .requirement.valid {
        color: #00b894;
      }

      .requirement svg {
        width: 16px;
        height: 16px;
        margin-right: 8px;
        fill: currentColor;
      }

      .button {
        width: 100%;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border: none;
        padding: 16px 32px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(245, 87, 108, 0.3);
      }

      .button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .loader {
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top: 3px solid white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .hidden {
        display: none;
      }

      .error-message {
        color: #ff6b6b;
        font-size: 14px;
        margin-top: 8px;
        text-align: left;
      }

      .loading-state {
        text-align: center;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #f5576c;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Loading State -->
      <div id="loading-state" class="loading-state">
        <div class="loading-spinner"></div>
        <h1>Verificando enlace...</h1>
        <p>Por favor espera mientras verificamos tu enlace de recuperaci贸n.</p>
      </div>

      <!-- Form State -->
      <div id="form-state" class="hidden">
        <div class="icon">
          <svg viewBox="0 0 24 24">
            <path
              d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"
            />
          </svg>
        </div>
        <h1>Nueva Contrase帽a</h1>
        <p>Ingresa tu nueva contrase帽a para tu cuenta de Login Pro.</p>

        <form id="reset-form" onsubmit="handleSubmit(event)">
          <div class="form-group">
            <label for="password">Nueva Contrase帽a</label>
            <input
              type="password"
              id="password"
              placeholder="Ingresa tu nueva contrase帽a"
              oninput="validatePassword()"
              required
            />
          </div>

          <div class="form-group">
            <label for="confirm-password">Confirmar Contrase帽a</label>
            <input
              type="password"
              id="confirm-password"
              placeholder="Confirma tu nueva contrase帽a"
              oninput="validatePassword()"
              required
            />
            <div id="password-error" class="error-message hidden"></div>
          </div>

          <div class="password-requirements">
            <div class="requirement" id="req-length">
              <svg viewBox="0 0 24 24">
                <path
                  d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"
                />
              </svg>
              M铆nimo 6 caracteres
            </div>
            <div class="requirement" id="req-match">
              <svg viewBox="0 0 24 24">
                <path
                  d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"
                />
              </svg>
              Las contrase帽as coinciden
            </div>
          </div>

          <button type="submit" class="button" id="submit-btn" disabled>
            Cambiar Contrase帽a
          </button>
        </form>
      </div>

      <!-- Success State -->
      <div id="success-state" class="hidden">
        <div class="icon success">
          <svg viewBox="0 0 24 24">
            <path
              d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"
            />
          </svg>
        </div>
        <h1>隆Contrase帽a actualizada!</h1>
        <p>
          Tu contrase帽a ha sido cambiada correctamente. Ahora ser谩s redirigido a
          la aplicaci贸n.
        </p>
        <button class="button" onclick="openApp()">Abrir Aplicaci贸n</button>
      </div>

      <!-- Error State -->
      <div id="error-state" class="hidden">
        <div
          class="icon"
          style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)"
        >
          <svg viewBox="0 0 24 24">
            <path
              d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"
            />
          </svg>
        </div>
        <h1>Error</h1>
        <p id="error-message">
          El enlace de recuperaci贸n es inv谩lido o ha expirado. Por favor
          solicita un nuevo enlace.
        </p>
        <button class="button" onclick="openApp()">Ir a la Aplicaci贸n</button>
      </div>
    </div>

    <script>
      console.log("Script iniciado");
      console.log("window.supabase disponible:", typeof window.supabase);

      // Configurar Supabase - Las credenciales se cargan desde variables de entorno
      // Para desarrollo local, crea un archivo .env en la carpeta vercel/
      // Para producci贸n, configura las variables en Vercel Dashboard
      let supabase;

      // Funci贸n para inicializar Supabase
      async function initSupabase() {
        try {
          // En producci贸n, Vercel inyectar谩 estas variables
          // En desarrollo, usa las del archivo .env local o configura en Vercel CLI
          const response = await fetch('/api/config');
          const config = await response.json();

          const SUPABASE_URL = config.supabaseUrl;
          const SUPABASE_ANON_KEY = config.supabaseAnonKey;

          // Esperar a que el SDK de Supabase est茅 cargado
          if (!window.supabase) {
            console.error("ERROR: SDK de Supabase no est谩 cargado");
            alert(
              "Error: No se pudo cargar el SDK de Supabase. Por favor recarga la p谩gina."
            );
            return;
          }

          supabase = window.supabase.createClient(
            SUPABASE_URL,
            SUPABASE_ANON_KEY
          );
          console.log("Cliente de Supabase creado:", supabase);

          // Iniciar la aplicaci贸n despu茅s de que Supabase est茅 listo
          initApp();
        } catch (error) {
          console.error("Error al cargar configuraci贸n:", error);
          alert("Error al cargar la configuraci贸n. Por favor recarga la p谩gina.");
        }
      }

      // Validar contrase帽a (debe estar en scope global para ser accesible desde HTML)
      function validatePassword() {
        const password = document.getElementById("password").value;
        const confirmPassword =
          document.getElementById("confirm-password").value;
        const errorDiv = document.getElementById("password-error");
        const submitBtn = document.getElementById("submit-btn");

        console.log("Validando contrase帽a:", {
          passwordLength: password.length,
          confirmPasswordLength: confirmPassword.length,
          match: password === confirmPassword
        });

        // Validar longitud
        const lengthReq = document.getElementById("req-length");
        if (password.length >= 6) {
          lengthReq.classList.add("valid");
        } else {
          lengthReq.classList.remove("valid");
        }

        // Validar coincidencia
        const matchReq = document.getElementById("req-match");
        if (password && confirmPassword && password === confirmPassword) {
          matchReq.classList.add("valid");
          errorDiv.classList.add("hidden");
          document.getElementById("confirm-password").classList.remove("error");
        } else if (confirmPassword) {
          matchReq.classList.remove("valid");
          errorDiv.textContent = "Las contrase帽as no coinciden";
          errorDiv.classList.remove("hidden");
          document.getElementById("confirm-password").classList.add("error");
        } else {
          // Si no hay confirmPassword a煤n, limpiar el error
          matchReq.classList.remove("valid");
          errorDiv.classList.add("hidden");
          document.getElementById("confirm-password").classList.remove("error");
        }

        // Habilitar/deshabilitar bot贸n
        const isValid = password.length >= 6 && confirmPassword.length > 0 && password === confirmPassword;
        submitBtn.disabled = !isValid;
        console.log("Bot贸n habilitado:", !isValid);
      }

      // Manejar env铆o del formulario (debe estar en scope global para ser accesible desde HTML)
      async function handleSubmit(event) {
        event.preventDefault();

        const password = document.getElementById("password").value;
        const confirmPassword =
          document.getElementById("confirm-password").value;
        const submitBtn = document.getElementById("submit-btn");

        if (password !== confirmPassword) {
          showError("Las contrase帽as no coinciden");
          return;
        }

        if (password.length < 6) {
          showError("La contrase帽a debe tener al menos 6 caracteres");
          return;
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<div class="loader"></div>Actualizando...';

        try {
          // Verificar que tengamos una sesi贸n activa antes de actualizar
          const {
            data: { session },
          } = await supabase.auth.getSession();
          console.log("Sesi贸n actual:", session);

          if (!session) {
            throw new Error(
              "No hay sesi贸n activa. Por favor recarga la p谩gina."
            );
          }

          // Actualizar la contrase帽a
          const { data, error } = await supabase.auth.updateUser({
            password: password,
          });

          console.log("Resultado de actualizaci贸n:", { data, error });

          if (error) throw error;

          // Mostrar 茅xito
          document.getElementById("form-state").classList.add("hidden");
          document.getElementById("success-state").classList.remove("hidden");

          // Redirigir autom谩ticamente despu茅s de 3 segundos
          setTimeout(() => {
            openApp();
          }, 3000);
        } catch (error) {
          console.error("Error completo:", error);
          showError("Error al actualizar la contrase帽a: " + error.message);
          submitBtn.disabled = false;
          submitBtn.textContent = "Cambiar Contrase帽a";
        }
      }

      // Abrir app (debe estar en scope global)
      function openApp() {
        // Intentar obtener tokens del hash primero, luego de query params
        const hashParams = new URLSearchParams(
          window.location.hash.substring(1)
        );
        const queryParams = new URLSearchParams(window.location.search);

        const accessToken =
          hashParams.get("access_token") || queryParams.get("access_token");
        const refreshToken =
          hashParams.get("refresh_token") || queryParams.get("refresh_token");

        let deepLink = "loginpro://password-reset-success";

        if (accessToken) {
          deepLink += `?access_token=${encodeURIComponent(accessToken)}`;
          if (refreshToken) {
            deepLink += `&refresh_token=${encodeURIComponent(refreshToken)}`;
          }
        }

        window.location.href = deepLink;

        setTimeout(() => {
          alert(
            "Si la aplicaci贸n no se abre autom谩ticamente, 谩brela manualmente."
          );
        }, 2000);
      }

      // Mostrar error (debe estar en scope global)
      function showError(message) {
        document.getElementById("loading-state").classList.add("hidden");
        document.getElementById("form-state").classList.add("hidden");
        document.getElementById("error-message").textContent = message;
        document.getElementById("error-state").classList.remove("hidden");
      }

      // Funci贸n principal de la aplicaci贸n
      function initApp() {
        // Verificar y establecer sesi贸n al cargar
        async function checkSession() {
          try {
          console.log("URL completa:", window.location.href);
          console.log("Hash:", window.location.hash);
          console.log("Search:", window.location.search);

          const hashParams = new URLSearchParams(
            window.location.hash.substring(1)
          );
          const queryParams = new URLSearchParams(window.location.search);

          // Obtener tokens del hash (flujo impl铆cito)
          const accessToken = hashParams.get("access_token");
          const refreshToken = hashParams.get("refresh_token");

          // Obtener token PKCE de query params
          const token = queryParams.get("token");
          const type = queryParams.get("type") || hashParams.get("type");

          console.log("Tokens encontrados:", {
            accessToken: !!accessToken,
            token: !!token,
            type,
          });

          // CASO 1: Token PKCE (token=pkce_xxx en query params)
          if (token && type === "recovery") {
            console.log("Verificando token PKCE de recuperaci贸n...");
            const { data, error } = await supabase.auth.verifyOtp({
              token_hash: token,
              type: "recovery",
            });

            console.log("Resultado verifyOtp:", { data, error });

            if (error) throw error;

            if (data.session) {
              console.log("Sesi贸n establecida con token PKCE");
              document.getElementById("loading-state").classList.add("hidden");
              document.getElementById("form-state").classList.remove("hidden");
              // Focus en el campo de contrase帽a para mejor UX
              setTimeout(() => document.getElementById("password").focus(), 100);
              return;
            }
          }

          // CASO 2: Tokens en hash (flujo impl铆cito antiguo)
          if (accessToken) {
            console.log("Estableciendo sesi贸n con tokens del hash...");
            const { data, error } = await supabase.auth.setSession({
              access_token: accessToken,
              refresh_token: refreshToken,
            });

            if (error) throw error;

            if (data.session) {
              console.log("Sesi贸n establecida con tokens del hash");
              document.getElementById("loading-state").classList.add("hidden");
              document.getElementById("form-state").classList.remove("hidden");
              // Focus en el campo de contrase帽a para mejor UX
              setTimeout(() => document.getElementById("password").focus(), 100);
              return;
            }
          }

          // CASO 3: Verificar sesi贸n existente
          console.log("Verificando sesi贸n existente...");
          const {
            data: { session },
            error,
          } = await supabase.auth.getSession();

          if (session) {
            console.log("Sesi贸n existente encontrada");
            document.getElementById("loading-state").classList.add("hidden");
            document.getElementById("form-state").classList.remove("hidden");
            // Focus en el campo de contrase帽a para mejor UX
            setTimeout(() => document.getElementById("password").focus(), 100);
            return;
          }

          // No hay sesi贸n v谩lida
          console.log("No se encontr贸 sesi贸n v谩lida");
          showError(
            "El enlace de recuperaci贸n es inv谩lido o ha expirado. Por favor solicita un nuevo enlace."
          );
        } catch (error) {
          console.error("Error al verificar sesi贸n:", error);
          showError("Error al verificar el enlace: " + error.message);
          }
        }

        // Ejecutar cuando el DOM est茅 listo
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", checkSession);
        } else {
          // DOM ya est谩 listo
          checkSession();
        }
      } // Cierre de initApp()

      // Inicializar Supabase cuando se cargue la p谩gina
      initSupabase();
    </script>
  </body>
</html>
</file>

<file path="vercel/vercel.json">
{
  "rewrites": [
    { "source": "/verify-email", "destination": "/verify-email.html" },
    { "source": "/reset-password", "destination": "/reset-password.html" }
  ]
}
</file>

<file path=".env.example">
SUPABASE_URL="https://supabase.supabase.co"
SUPABASE_ANON_KEY="eyJhbGc...""
# Vercel Configuracion
# tu URL de despliegue de vercel for password reset and email verification
VERCEL_BASE_URL="https://vercel.vercel.app"
GEMINI_API_KEY="Tu_API_Key_Aqui"
GEMINI_BASE_URL="https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent"
</file>

<file path="android/gradle/wrapper/gradle-wrapper.properties">
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.2-all.zip
</file>

<file path="android/settings.gradle">
pluginManagement {
    def flutterSdkPath = {
        def properties = new Properties()
        file("local.properties").withInputStream { properties.load(it) }
        def flutterSdkPath = properties.getProperty("flutter.sdk")
        assert flutterSdkPath != null, "flutter.sdk not set in local.properties"
        return flutterSdkPath
    }()

    includeBuild("$flutterSdkPath/packages/flutter_tools/gradle")

    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}

plugins {
    id "dev.flutter.flutter-plugin-loader" version "1.0.0"
    id "com.android.application" version "8.2.1" apply false
    id "org.jetbrains.kotlin.android" version "1.9.0" apply false
}

include ":app"
</file>

<file path="lib/core/theme/app_theme.dart">
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';

class AppTheme {
  // Colores extra铆dos del dise帽o del PDF
  static const Color primaryColor = Color(0xFFFF8B3D); // Naranja principal
  static const Color secondaryColor = Color(0xFF00BFA5); // Verde Azulado (Refugios)
  static const Color backgroundColor = Color(0xFFFFFBF6); // Crema suave (Fondo)
  static const Color surfaceColor = Colors.white;
  static const Color errorColor = Color(0xFFFF6B6B);
  static const Color textPrimaryColor = Color(0xFF2D3436);
  static const Color textSecondaryColor = Color(0xFF636E72);

  static ThemeData get lightTheme {
    return ThemeData(
      useMaterial3: true,
      scaffoldBackgroundColor: backgroundColor,
      colorScheme: ColorScheme.light(
        primary: primaryColor,
        secondary: secondaryColor,
        surface: surfaceColor,
        error: errorColor,
        onPrimary: Colors.white,
        onSecondary: Colors.white,
        onSurface: textPrimaryColor,
      ),
      textTheme: GoogleFonts.nunitoTextTheme().copyWith( // Nunito es m谩s "amigable" para mascotas
        displayLarge: GoogleFonts.nunito(fontSize: 32, fontWeight: FontWeight.bold, color: textPrimaryColor),
        displayMedium: GoogleFonts.nunito(fontSize: 28, fontWeight: FontWeight.bold, color: textPrimaryColor),
        bodyLarge: GoogleFonts.nunito(fontSize: 16, color: textPrimaryColor),
        bodyMedium: GoogleFonts.nunito(fontSize: 14, color: textSecondaryColor),
      ),
      elevatedButtonTheme: ElevatedButtonThemeData(
        style: ElevatedButton.styleFrom(
          backgroundColor: primaryColor,
          foregroundColor: Colors.white,
          elevation: 0,
          padding: const EdgeInsets.symmetric(horizontal: 32, vertical: 16),
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
          textStyle: GoogleFonts.nunito(fontSize: 16, fontWeight: FontWeight.bold),
        ),
      ),
      inputDecorationTheme: InputDecorationTheme(
        filled: true,
        fillColor: surfaceColor,
        contentPadding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
        border: OutlineInputBorder(borderRadius: BorderRadius.circular(16), borderSide: BorderSide.none),
        enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(16), borderSide: BorderSide.none),
        focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(16), borderSide: const BorderSide(color: primaryColor, width: 2)),
      ),
    );
  }
}
</file>

<file path="lib/features/auth/data/datasources/auth_remote_data_source.dart">
import 'package:injectable/injectable.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import '../models/user_model.dart';

abstract class AuthRemoteDataSource {
  Future<UserModel> signInWithEmailAndPassword({
    required String email,
    required String password,
  });

  Future<UserModel> signUpWithEmailAndPassword({
    required String email,
    required String password,
    String? displayName,
    String? role,
  });

  Future<void> sendPasswordResetEmail({
    required String email,
  });

  Future<void> signOut();

  Future<UserModel?> getCurrentUser();

  Stream<UserModel?> get authStateChanges;
}

@LazySingleton(as: AuthRemoteDataSource)
class AuthRemoteDataSourceImpl implements AuthRemoteDataSource {
  final SupabaseClient supabaseClient;

  AuthRemoteDataSourceImpl(this.supabaseClient);

  @override
  Future<UserModel> signInWithEmailAndPassword({
    required String email,
    required String password,
  }) async {
    try {
      final response = await supabaseClient.auth.signInWithPassword(
        email: email,
        password: password,
      );

      if (response.user == null) {
        throw Exception('No se pudo iniciar sesi贸n');
      }

      return UserModel.fromSupabaseUser(response.user!);
    } on AuthException catch (e) {
      // Interceptamos el error de Supabase y lo traducimos
      throw Exception(_mapSupabaseError(e));
    } catch (e) {
      throw Exception('Ocurri贸 un error inesperado al iniciar sesi贸n.');
    }
  }

  @override
  Future<UserModel> signUpWithEmailAndPassword({
    required String email,
    required String password,
    String? displayName,
    String? role,
  }) async {
    try {
      final response = await supabaseClient.auth.signUp(
        email: email,
        password: password,
        data: {
          if (displayName != null) 'display_name': displayName,
          'role': role ?? 'adopter',
        },
      );

      // Si hay usuario pero no sesi贸n, es que falta confirmar el correo
      if (response.user != null && response.session == null) {
        return UserModel.fromSupabaseUser(response.user!);
      }

      if (response.user == null) {
        throw Exception('No se pudo crear la cuenta');
      }

      return UserModel.fromSupabaseUser(response.user!);
    } on AuthException catch (e) {
      throw Exception(_mapSupabaseError(e));
    } catch (e) {
      throw Exception('Error al registrarse. Intenta de nuevo.');
    }
  }

  @override
  Future<void> sendPasswordResetEmail({
    required String email,
  }) async {
    try {
      await supabaseClient.auth.resetPasswordForEmail(
        email,
        // Aseg煤rate que este link coincida con el intent-filter en AndroidManifest
        redirectTo: 'loginpro://reset-callback',
      );
    } on AuthException catch (e) {
      throw Exception(_mapSupabaseError(e));
    } catch (e) {
      throw Exception('Error al enviar email de recuperaci贸n.');
    }
  }

  @override
  Future<void> signOut() async {
    try {
      await supabaseClient.auth.signOut();
    } on AuthException catch (e) {
      throw Exception(e.message); // En signOut rara vez hay error cr铆tico
    } catch (e) {
      throw Exception('Error al cerrar sesi贸n.');
    }
  }

  @override
  Future<UserModel?> getCurrentUser() async {
    try {
      final user = supabaseClient.auth.currentUser;
      if (user == null) return null;
      return UserModel.fromSupabaseUser(user);
    } catch (e) {
      return null;
    }
  }

  @override
  Stream<UserModel?> get authStateChanges {
    return supabaseClient.auth.onAuthStateChange.map((event) {
      final user = event.session?.user;
      if (user == null) return null;
      return UserModel.fromSupabaseUser(user);
    });
  }

  // --- TRADUCTOR DE ERRORES ---
  String _mapSupabaseError(AuthException error) {
    final msg = error.message.toLowerCase();

    // Credenciales incorrectas (Login)
    if (msg.contains('invalid login credentials')) {
      return 'Correo o contrase帽a incorrectos.';
    }

    // Correo no confirmado (Login)
    if (msg.contains('email not confirmed')) {
      return 'Debes confirmar tu correo electr贸nico antes de entrar.';
    }

    // Usuario no encontrado (A veces Supabase usa esto en lugar de invalid credentials)
    if (msg.contains('user not found')) {
      return 'No existe una cuenta con este correo.';
    }

    // Contrase帽a muy d茅bil (Registro)
    if (msg.contains('password should be')) {
      return 'La contrase帽a es muy d茅bil (m铆nimo 6 caracteres).';
    }

    // Correo ya registrado (Registro)
    if (msg.contains('already registered') ||
        msg.contains('user already exists')) {
      return 'Este correo ya est谩 registrado.';
    }

    // Demasiados intentos (Seguridad)
    if (msg.contains('rate limit') || msg.contains('too many requests')) {
      return 'Demasiados intentos. Espera unos minutos.';
    }

    // Retorno por defecto si es otro error
    return error.message;
  }
}
</file>

<file path="lib/features/auth/data/models/user_model.dart">
import 'package:supabase_flutter/supabase_flutter.dart';
import '../../domain/entities/user_entity.dart';

class UserModel extends UserEntity {
  const UserModel({
    required super.id,
    required super.email,
    super.displayName,
    super.photoUrl,
    super.createdAt,
    super.role,
  });

  factory UserModel.fromSupabaseUser(User user) {

    final metadata = user.userMetadata;

    return UserModel(
      id: user.id,
      email: user.email ?? '',
      displayName: user.userMetadata?['display_name'] as String?,
      photoUrl: user.userMetadata?['avatar_url'] as String?,
      createdAt: DateTime.parse(user.createdAt),
      role: metadata?['role'] as String? ?? 'adopter',
    );
  }

  UserEntity toEntity() {
    return UserEntity(
      id: id,
      email: email,
      displayName: displayName,
      photoUrl: photoUrl,
      createdAt: createdAt,
      role: role,
    );
  }
}
</file>

<file path="lib/features/auth/data/repositories/auth_repository_impl.dart">
import 'package:dartz/dartz.dart';
import 'package:injectable/injectable.dart';
import '../../../../core/error/failures.dart';
import '../../../../core/network/network_info.dart';
import '../../domain/entities/user_entity.dart';
import '../../domain/repositories/auth_repository.dart';
import '../datasources/auth_remote_data_source.dart';

@LazySingleton(as: AuthRepository)
class AuthRepositoryImpl implements AuthRepository {
  final AuthRemoteDataSource remoteDataSource;
  final NetworkInfo networkInfo;

  AuthRepositoryImpl({
    required this.remoteDataSource,
    required this.networkInfo,
  });

  @override
  Future<Either<Failure, UserEntity>> signInWithEmailAndPassword({
    required String email,
    required String password,
  }) async {
    print(' REPO: Iniciando login para $email'); // DEBUG

    // 1. Desactivamos temporalmente el check de internet para probar si es el culpable
    // if (!await networkInfo.isConnected) {
    //   print(' REPO: Sin internet');
    //   return const Left(NetworkFailure('Sin conexi贸n a internet'));
    // }

    try {
      print(' REPO: Llamando a Supabase DataSource...');
      final user = await remoteDataSource.signInWithEmailAndPassword(
        email: email,
        password: password,
      );
      print(' REPO: Login exitoso!');
      return Right(user);
    } catch (e) {
      print(' REPO: Error capturado -> $e'); // DEBUG CRTICO
      // Limpiamos el mensaje de error para que se vea bonito en el SnackBar
      final cleanMessage = e.toString().replaceAll('Exception: ', '');
      return Left(AuthFailure(cleanMessage));
    }
  }

  @override
  Future<Either<Failure, UserEntity>> signUpWithEmailAndPassword({
    required String email,
    required String password,
    String? displayName,
    String? role,
  }) async {
    print(' REPO: Iniciando registro');
    // if (!await networkInfo.isConnected) {
    //   return const Left(NetworkFailure('Sin conexi贸n a internet'));
    // }

    try {
      final user = await remoteDataSource.signUpWithEmailAndPassword(
        email: email,
        password: password,
        displayName: displayName,
        role: role,
      );
      return Right(user);
    } catch (e) {
      final cleanMessage = e.toString().replaceAll('Exception: ', '');
      return Left(AuthFailure(cleanMessage));
    }
  }

  @override
  Future<Either<Failure, void>> sendPasswordResetEmail({
    required String email,
  }) async {
    try {
      await remoteDataSource.sendPasswordResetEmail(email: email);
      return const Right(null);
    } catch (e) {
      return Left(AuthFailure(e.toString().replaceAll('Exception: ', '')));
    }
  }

  @override
  Future<Either<Failure, void>> signOut() async {
    try {
      await remoteDataSource.signOut();
      return const Right(null);
    } catch (e) {
      return Left(AuthFailure(e.toString().replaceAll('Exception: ', '')));
    }
  }

  @override
  Future<Either<Failure, UserEntity?>> getCurrentUser() async {
    try {
      final user = await remoteDataSource.getCurrentUser();
      return Right(user);
    } catch (e) {
      return Left(AuthFailure(e.toString().replaceAll('Exception: ', '')));
    }
  }

  @override
  Stream<UserEntity?> get authStateChanges {
    return remoteDataSource.authStateChanges;
  }
}
</file>

<file path="lib/features/auth/domain/entities/user_entity.dart">
import 'package:equatable/equatable.dart';

class UserEntity extends Equatable {
  final String id;
  final String email;
  final String? displayName;
  final String? photoUrl;
  final DateTime? createdAt;
  final String? role;

  const UserEntity({
    required this.id,
    required this.email,
    this.displayName,
    this.photoUrl,
    this.createdAt,
    this.role,
  });

  @override
  List<Object?> get props => [id, email, displayName, photoUrl, createdAt, role];
}
</file>

<file path="lib/features/auth/domain/repositories/auth_repository.dart">
import 'package:dartz/dartz.dart';
import '../../../../core/error/failures.dart';
import '../entities/user_entity.dart';

abstract class AuthRepository {
  Future<Either<Failure, UserEntity>> signInWithEmailAndPassword({
    required String email,
    required String password,
  });

  Future<Either<Failure, UserEntity>> signUpWithEmailAndPassword({
    required String email,
    required String password,
    String? displayName,
    String? role,
  });

  Future<Either<Failure, void>> sendPasswordResetEmail({
    required String email,
  });

  Future<Either<Failure, void>> signOut();

  Future<Either<Failure, UserEntity?>> getCurrentUser();

  Stream<UserEntity?> get authStateChanges;
}
</file>

<file path="lib/features/auth/domain/usecases/sign_up.dart">
import 'package:dartz/dartz.dart';
import 'package:injectable/injectable.dart';
import '../../../../core/error/failures.dart';
import '../../../../core/usecase/usecase.dart';
import '../entities/user_entity.dart';
import '../repositories/auth_repository.dart';

@injectable
class SignUp implements UseCase<UserEntity, SignUpParams> {
  final AuthRepository repository;

  SignUp(this.repository);

  @override
  Future<Either<Failure, UserEntity>> call(SignUpParams params) async {
    return await repository.signUpWithEmailAndPassword(
      email: params.email,
      password: params.password,
      displayName: params.displayName,
      role: params.role, // <--- PASARLO AL REPO
    );
  }
}

class SignUpParams {
  final String email;
  final String password;
  final String? displayName;
  final String? role; // <--- NUEVO CAMPO

  SignUpParams({
    required this.email,
    required this.password,
    this.displayName,
    this.role,
  });
}
</file>

<file path="lib/features/auth/presentation/bloc/auth_bloc.dart">
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:injectable/injectable.dart';
import '../../../../core/usecase/usecase.dart';
import '../../domain/usecases/get_current_user.dart';
import '../../domain/usecases/reset_password.dart';
import '../../domain/usecases/sign_in.dart';
import '../../domain/usecases/sign_out.dart';
import '../../domain/usecases/sign_up.dart';
import 'auth_event.dart';
import 'auth_state.dart';

@injectable
class AuthBloc extends Bloc<AuthEvent, AuthState> {
  final SignIn signIn;
  final SignUp signUp;
  final ResetPassword resetPassword;
  final SignOut signOut;
  final GetCurrentUser getCurrentUser;

  AuthBloc({
    required this.signIn,
    required this.signUp,
    required this.resetPassword,
    required this.signOut,
    required this.getCurrentUser,
  }) : super(const AuthInitial()) {
    on<SignInRequested>(_onSignInRequested);
    on<SignUpRequested>(_onSignUpRequested);
    on<ResetPasswordRequested>(_onResetPasswordRequested);
    on<SignOutRequested>(_onSignOutRequested);
    on<AuthCheckRequested>(_onAuthCheckRequested);
  }

  Future<void> _onSignInRequested(
    SignInRequested event,
    Emitter<AuthState> emit,
  ) async {
    emit(const AuthLoading());

    final result = await signIn(
      SignInParams(
        email: event.email,
        password: event.password,
      ),
    );

    result.fold(
      (failure) => emit(AuthError(failure.message)),
      (user) => emit(AuthAuthenticated(user)),
    );
  }

  Future<void> _onSignUpRequested(
    SignUpRequested event,
    Emitter<AuthState> emit,
  ) async {
    emit(const AuthLoading());

    final result = await signUp(
      SignUpParams(
        email: event.email,
        password: event.password,
        displayName: event.displayName,
        role: event.role, // <--- CONECTAMOS EL EVENTO CON EL USECASE
      ),
    );

    result.fold(
      (failure) => emit(AuthError(failure.message)),
      (user) => emit(EmailVerificationRequired(event.email)),
    );
  }

  Future<void> _onResetPasswordRequested(
    ResetPasswordRequested event,
    Emitter<AuthState> emit,
  ) async {
    emit(const AuthLoading());

    final result = await resetPassword(
      ResetPasswordParams(email: event.email),
    );

    result.fold(
      (failure) => emit(AuthError(failure.message)),
      (_) => emit(const ResetPasswordSent()),
    );
  }

  Future<void> _onSignOutRequested(
    SignOutRequested event,
    Emitter<AuthState> emit,
  ) async {
    emit(const AuthLoading());

    final result = await signOut(NoParams());

    result.fold(
      (failure) => emit(AuthError(failure.message)),
      (_) => emit(const AuthUnauthenticated()),
    );
  }

  Future<void> _onAuthCheckRequested(
    AuthCheckRequested event,
    Emitter<AuthState> emit,
  ) async {
    emit(const AuthLoading());

    final result = await getCurrentUser(NoParams());

    result.fold(
      (failure) => emit(const AuthUnauthenticated()),
      (user) {
        if (user != null) {
          emit(AuthAuthenticated(user));
        } else {
          emit(const AuthUnauthenticated());
        }
      },
    );
  }
}
</file>

<file path="lib/features/auth/presentation/bloc/auth_event.dart">
import 'package:equatable/equatable.dart';

abstract class AuthEvent extends Equatable {
  const AuthEvent();

  @override
  List<Object?> get props => [];
}

class SignInRequested extends AuthEvent {
  final String email;
  final String password;

  const SignInRequested({
    required this.email,
    required this.password,
  });

  @override
  List<Object> get props => [email, password];
}

class SignUpRequested extends AuthEvent {
  final String email;
  final String password;
  final String? displayName;
  final String role; // <--- NUEVO CAMPO

  const SignUpRequested({
    required this.email,
    required this.password,
    this.displayName,
    required this.role, // <--- REQUERIDO AHORA
  });

  @override
  List<Object?> get props => [email, password, displayName, role];
}

class ResetPasswordRequested extends AuthEvent {
  final String email;

  const ResetPasswordRequested({required this.email});

  @override
  List<Object> get props => [email];
}

class SignOutRequested extends AuthEvent {
  const SignOutRequested();
}

class AuthCheckRequested extends AuthEvent {
  const AuthCheckRequested();
}
</file>

<file path="lib/features/auth/presentation/pages/login_page.dart">
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../bloc/auth_bloc.dart';
import '../bloc/auth_event.dart';
import '../bloc/auth_state.dart';
import '../widgets/custom_text_field.dart';
import '../widgets/loading_overlay.dart';
import 'register_page.dart';
import 'reset_password_page.dart';
import 'welcome_page.dart';

class LoginPage extends StatefulWidget {
  const LoginPage({super.key});

  @override
  State<LoginPage> createState() => _LoginPageState();
}

class _LoginPageState extends State<LoginPage> {
  final _formKey = GlobalKey<FormState>();
  final _emailController = TextEditingController();
  final _passwordController = TextEditingController();

  @override
  void dispose() {
    _emailController.dispose();
    _passwordController.dispose();
    super.dispose();
  }

  void _handleSignIn() {
    // 1. Ocultar el teclado para ver bien el SnackBar y el Loading
    FocusScope.of(context).unfocus();

    if (_formKey.currentState!.validate()) {
      context.read<AuthBloc>().add(
            SignInRequested(
              email: _emailController.text.trim(),
              password: _passwordController.text,
            ),
          );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: BlocConsumer<AuthBloc, AuthState>(
        listener: (context, state) {
          if (state is AuthError) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: Text(state.message),
                backgroundColor: Theme.of(context).colorScheme.error,
              ),
            );
          } else if (state is AuthAuthenticated) {
            Navigator.of(context).pushReplacement(
              MaterialPageRoute(
                builder: (_) => WelcomePage(user: state.user),
              ),
            );
          }
        },
        builder: (context, state) {
          final isLoading = state is AuthLoading;

          return LoadingOverlay(
            isLoading: isLoading,
            child: SafeArea(
              child: Center(
                child: SingleChildScrollView(
                  padding: const EdgeInsets.all(24.0),
                  child: Form(
                    key: _formKey,
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      crossAxisAlignment: CrossAxisAlignment.stretch,
                      children: [
                        // Logo o icono
                        Icon(
                          Icons.lock_person_rounded,
                          size: 80,
                          color: Theme.of(context).colorScheme.primary,
                        ),
                        const SizedBox(height: 24),

                        // T铆tulo
                        Text(
                          'Bienvenido',
                          style: Theme.of(context).textTheme.displayMedium,
                          textAlign: TextAlign.center,
                        ),
                        const SizedBox(height: 8),
                        Text(
                          'Inicia sesi贸n para continuar',
                          style: Theme.of(context).textTheme.bodyMedium,
                          textAlign: TextAlign.center,
                        ),
                        const SizedBox(height: 48),

                        // Email field
                        CustomTextField(
                          controller: _emailController,
                          label: 'Correo electr贸nico',
                          hint: 'tu@email.com',
                          prefixIcon: Icons.email_outlined,
                          keyboardType: TextInputType.emailAddress,
                          validator: (value) {
                            if (value == null || value.isEmpty) {
                              return 'Por favor ingresa tu correo';
                            }
                            if (!value.contains('@')) {
                              return 'Por favor ingresa un correo v谩lido';
                            }
                            return null;
                          },
                        ),
                        const SizedBox(height: 16),

                        // Password field
                        CustomTextField(
                          controller: _passwordController,
                          label: 'Contrase帽a',
                          hint: '⑩⑩⑩⑩⑩⑩⑩',
                          prefixIcon: Icons.lock_outline,
                          isPassword: true,
                          validator: (value) {
                            if (value == null || value.isEmpty) {
                              return 'Por favor ingresa tu contrase帽a';
                            }
                            if (value.length < 6) {
                              return 'La contrase帽a debe tener al menos 6 caracteres';
                            }
                            return null;
                          },
                        ),
                        const SizedBox(height: 8),

                        // Forgot password
                        Align(
                          alignment: Alignment.centerRight,
                          child: TextButton(
                            onPressed: () {
                              Navigator.of(context).push(
                                MaterialPageRoute(
                                  builder: (_) => const ResetPasswordPage(),
                                ),
                              );
                            },
                            child: Text(
                              '驴Olvidaste tu contrase帽a?',
                              style: TextStyle(
                                color: Theme.of(context).colorScheme.primary,
                                fontWeight: FontWeight.w600,
                              ),
                            ),
                          ),
                        ),
                        const SizedBox(height: 24),

                        // Login button
                        SizedBox(
                          height: 56,
                          child: ElevatedButton(
                            onPressed: isLoading ? null : _handleSignIn,
                            child: const Text('Iniciar sesi贸n'),
                          ),
                        ),
                        const SizedBox(height: 24),

                        // Register link
                        Row(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            Text(
                              '驴No tienes cuenta?',
                              style: Theme.of(context).textTheme.bodyMedium,
                            ),
                            TextButton(
                              onPressed: () {
                                Navigator.of(context).push(
                                  MaterialPageRoute(
                                    builder: (_) => const RegisterPage(),
                                  ),
                                );
                              },
                              child: Text(
                                'Reg铆strate',
                                style: TextStyle(
                                  color: Theme.of(context).colorScheme.primary,
                                  fontWeight: FontWeight.w600,
                                ),
                              ),
                            ),
                          ],
                        ),
                      ],
                    ),
                  ),
                ),
              ),
            ),
          );
        },
      ),
    );
  }
}
</file>

<file path="lib/features/auth/presentation/pages/register_page.dart">
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../bloc/auth_bloc.dart';
import '../bloc/auth_event.dart';
import '../bloc/auth_state.dart';
import '../widgets/custom_text_field.dart';
import '../widgets/loading_overlay.dart';
import 'email_verification_sent_page.dart';

class RegisterPage extends StatefulWidget {
  const RegisterPage({super.key});

  @override
  State<RegisterPage> createState() => _RegisterPageState();
}

class _RegisterPageState extends State<RegisterPage> {
  final _formKey = GlobalKey<FormState>();
  final _nameController = TextEditingController();
  final _emailController = TextEditingController();
  final _passwordController = TextEditingController();

  // Estado para el rol seleccionado
  String _selectedRole = 'adopter'; // 'adopter' o 'shelter'

  void _handleSignUp() {
    if (_formKey.currentState!.validate()) {
      context.read<AuthBloc>().add(
            SignUpRequested(
              email: _emailController.text.trim(),
              password: _passwordController.text,
              displayName: _nameController.text.trim(),
              role: _selectedRole, // Enviamos el rol seleccionado
            ),
          );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(backgroundColor: Colors.transparent, elevation: 0),
      body: BlocConsumer<AuthBloc, AuthState>(
        listener: (context, state) {
          if (state is AuthError) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                  content: Text(state.message), backgroundColor: Colors.red),
            );
          } else if (state is EmailVerificationRequired) {
            Navigator.of(context).pushReplacement(
              MaterialPageRoute(
                  builder: (_) =>
                      EmailVerificationSentPage(email: state.email)),
            );
          }
        },
        builder: (context, state) {
          return LoadingOverlay(
            isLoading: state is AuthLoading,
            child: SafeArea(
              child: SingleChildScrollView(
                padding: const EdgeInsets.all(24.0),
                child: Form(
                  key: _formKey,
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.stretch,
                    children: [
                      Text('驴Qui茅n eres?',
                          style: Theme.of(context).textTheme.displayMedium),
                      const SizedBox(height: 8),
                      const Text(
                          'Selecciona el tipo de cuenta que deseas crear'),
                      const SizedBox(height: 24),

                      // SELECCIN DE ROL (Tarjetas)
                      Row(
                        children: [
                          Expanded(
                              child: _RoleCard(
                            title: 'Adoptante',
                            icon: Icons.home_rounded,
                            isSelected: _selectedRole == 'adopter',
                            onTap: () =>
                                setState(() => _selectedRole = 'adopter'),
                            color: const Color(0xFFFF8B3D),
                          )),
                          const SizedBox(width: 16),
                          Expanded(
                              child: _RoleCard(
                            title: 'Refugio',
                            icon: Icons.pets_rounded,
                            isSelected: _selectedRole == 'shelter',
                            onTap: () =>
                                setState(() => _selectedRole = 'shelter'),
                            color: const Color(0xFF00BFA5),
                          )),
                        ],
                      ),
                      const SizedBox(height: 32),

                      CustomTextField(
                        controller: _nameController,
                        label: _selectedRole == 'shelter'
                            ? 'Nombre del Refugio'
                            : 'Nombre Completo',
                        hint: _selectedRole == 'shelter'
                            ? 'Refugio de Animales'
                            : 'Nombre Apellido',
                        prefixIcon: Icons.person_outline,
                        validator: (v) => v!.isEmpty ? 'Campo requerido' : null,
                      ),
                      const SizedBox(height: 16),
                      CustomTextField(
                        controller: _emailController,
                        label: 'Correo electr贸nico',
                        hint: 'hola@ejemplo.com',
                        prefixIcon: Icons.email_outlined,
                        validator: (v) =>
                            !v!.contains('@') ? 'Email inv谩lido' : null,
                      ),
                      const SizedBox(height: 16),
                      CustomTextField(
                        controller: _passwordController,
                        label: 'Contrase帽a',
                        hint: '⑩⑩⑩⑩⑩⑩⑩',
                        prefixIcon: Icons.lock_outline,
                        isPassword: true,
                        validator: (v) =>
                            v!.length < 6 ? 'M铆nimo 6 caracteres' : null,
                      ),
                      const SizedBox(height: 32),

                      ElevatedButton(
                        onPressed: state is AuthLoading ? null : _handleSignUp,
                        child: Text(
                            'Crear cuenta como ${_selectedRole == 'shelter' ? 'Refugio' : 'Adoptante'}'),
                      ),
                    ],
                  ),
                ),
              ),
            ),
          );
        },
      ),
    );
  }
}

// Widget auxiliar para las tarjetas de selecci贸n
class _RoleCard extends StatelessWidget {
  final String title;
  final IconData icon;
  final bool isSelected;
  final VoidCallback onTap;
  final Color color;

  const _RoleCard({
    required this.title,
    required this.icon,
    required this.isSelected,
    required this.onTap,
    required this.color,
  });

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: isSelected ? color.withOpacity(0.1) : Colors.white,
          border: Border.all(
            color: isSelected ? color : Colors.grey.shade300,
            width: 2,
          ),
          borderRadius: BorderRadius.circular(16),
        ),
        child: Column(
          children: [
            Icon(icon, size: 40, color: isSelected ? color : Colors.grey),
            const SizedBox(height: 8),
            Text(
              title,
              style: TextStyle(
                fontWeight: FontWeight.bold,
                color: isSelected ? color : Colors.grey,
              ),
            ),
          ],
        ),
      ),
    );
  }
}
</file>

<file path="lib/features/auth/presentation/pages/welcome_page.dart">
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../domain/entities/user_entity.dart';
import '../bloc/auth_bloc.dart';
import '../bloc/auth_state.dart';
import 'login_page.dart';
import '../../../pet_management/presentation/pages/shelter_home_page.dart';
import '../../../pet_management/presentation/pages/adopter_home_page.dart';

class WelcomePage extends StatelessWidget {
  final UserEntity user;

  const WelcomePage({super.key, required this.user});

  @override
  Widget build(BuildContext context) {
    // Envolvemos la decisi贸n de vistas con un Listener que vigila la sesi贸n
    return BlocListener<AuthBloc, AuthState>(
      listener: (context, state) {
        // Si el estado cambia a "No Autenticado" (cerr贸 sesi贸n), nos vamos al Login
        if (state is AuthUnauthenticated) {
          Navigator.of(context).pushAndRemoveUntil(
            MaterialPageRoute(builder: (_) => const LoginPage()),
            (route) =>
                false, // Elimina todas las pantallas anteriores del stack
          );
        }
      },
      // Aqu铆 mantenemos tu l贸gica de roles
      child: user.role == 'shelter'
          ? ShelterHomePage(userId: user.id)
          : const AdopterHomePage(),
    );
  }
}
</file>

<file path="lib/features/pet_management/presentation/pages/adopter_home_page.dart">
import 'dart:async';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:prueba_bim2/features/pet_management/presentation/pages/map_page.dart';
import '../../../../injection_container.dart';
import '../../../auth/presentation/bloc/auth_bloc.dart';
import '../../../auth/presentation/bloc/auth_event.dart';
import '../../../auth/presentation/bloc/auth_state.dart';
import '../../../auth/presentation/pages/profile_page.dart';
import '../../../ai_assistant/presentation/pages/chat_page.dart'; // <--- Importar esto
import '../bloc/pet_bloc.dart';
import '../bloc/pet_event.dart';
import '../bloc/pet_state.dart';
import '../widgets/pet_card.dart';
import 'pet_detail_page.dart';
import 'package:geolocator/geolocator.dart';
import 'package:latlong2/latlong.dart';

class AdopterHomePage extends StatefulWidget {
  const AdopterHomePage({super.key});

  @override
  State<AdopterHomePage> createState() => _AdopterHomePageState();
}

class _AdopterHomePageState extends State<AdopterHomePage> {
  int _currentIndex = 0;
  String _currentFilter = 'Todos';
  String _searchQuery = '';
  Timer? _debounce;
  LatLng? _userPosition;

  @override
  void dispose() {
    _debounce?.cancel();
    super.dispose();
  }

  @override
  void initState() {
    super.initState();
    _getUserLocation(); // <--- Llamamos al iniciar
  }

  // Funci贸n para obtener ubicaci贸n silenciosamente (sin bloquear la UI)
  Future<void> _getUserLocation() async {
    bool serviceEnabled = await Geolocator.isLocationServiceEnabled();
    if (!serviceEnabled) return;

    LocationPermission permission = await Geolocator.checkPermission();
    if (permission == LocationPermission.denied) {
      permission = await Geolocator.requestPermission();
      if (permission == LocationPermission.denied) return;
    }

    if (permission == LocationPermission.deniedForever) return;

    final position = await Geolocator.getCurrentPosition();
    if (mounted) {
      setState(() {
        _userPosition = LatLng(position.latitude, position.longitude);
      });
    }
  }

  void _onFilterChanged(BuildContext context, String filter) {
    setState(() => _currentFilter = filter);
    context
        .read<PetBloc>()
        .add(LoadPets(filter: filter, searchQuery: _searchQuery));
  }

  void _onSearchChanged(BuildContext context, String query) {
    setState(() => _searchQuery = query);
    if (_debounce?.isActive ?? false) _debounce!.cancel();
    _debounce = Timer(const Duration(milliseconds: 500), () {
      context
          .read<PetBloc>()
          .add(LoadPets(filter: _currentFilter, searchQuery: _searchQuery));
    });
  }

  @override
  Widget build(BuildContext context) {
    final authState = context.watch<AuthBloc>().state;
    String userName = 'Amante de los animales';
    if (authState is AuthAuthenticated) {
      userName = authState.user.displayName ?? 'Usuario';
    }

    return BlocProvider(
      create: (_) => getIt<PetBloc>()..add(const LoadPets()),
      child: Scaffold(
        backgroundColor: const Color(0xFFFFF8F0),
        body: SafeArea(
          // L贸gica de pesta帽as: Home o Perfil (u otros)
          child: _currentIndex == 0
              ? _buildHomeBody(context, userName)
              : _currentIndex == 1
                  ? const MapPage()
                  : _currentIndex == 2
                      ? const ChatPage() // P谩gina de Chat IA
                      : const ProfilePage(), // Perfil integrado en la barra
        ),
        bottomNavigationBar: BottomNavigationBar(
          currentIndex: _currentIndex,
          onTap: (index) => setState(() => _currentIndex = index),
          selectedItemColor: const Color(0xFFFF8B3D),
          unselectedItemColor: Colors.grey,
          showUnselectedLabels: true,
          type: BottomNavigationBarType.fixed,
          items: const [
            BottomNavigationBarItem(icon: Icon(Icons.home), label: 'Inicio'),
            BottomNavigationBarItem(
                icon: Icon(Icons.map_outlined), label: 'Mapa'),
            BottomNavigationBarItem(
                icon: Icon(Icons.chat_bubble_outline), label: 'Chat IA'),
            BottomNavigationBarItem(
                icon: Icon(Icons.person_outline), label: 'Perfil'),
          ],
        ),
      ),
    );
  }

  // Extraemos el cuerpo del Home para mantener el c贸digo limpio
  Widget _buildHomeBody(BuildContext context, String userName) {
    // Necesitamos un Builder aqu铆 tambi茅n para el contexto del BlocProvider padre
    return Builder(builder: (homeContext) {
      return Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // 1. Encabezado + Bot贸n Salir
          Padding(
            padding: const EdgeInsets.fromLTRB(24, 24, 24, 0),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text('Hola, $userName ',
                        style:
                            const TextStyle(color: Colors.grey, fontSize: 14)),
                    const SizedBox(height: 4),
                    const Text('Encuentra tu mascota',
                        style: TextStyle(
                            fontSize: 24,
                            fontWeight: FontWeight.w800,
                            color: Color(0xFF2D3436))),
                  ],
                ),
                CircleAvatar(
                  backgroundColor: Colors.white,
                  child: IconButton(
                    icon: const Icon(Icons.logout, color: Colors.black54),
                    onPressed: () =>
                        context.read<AuthBloc>().add(const SignOutRequested()),
                  ),
                )
              ],
            ),
          ),

          const SizedBox(height: 20),

          // 2. Buscador (NUEVO PARA ADOPTANTE)
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 24.0),
            child: TextField(
              onChanged: (value) => _onSearchChanged(homeContext, value),
              decoration: InputDecoration(
                hintText: 'Buscar mascota...',
                prefixIcon: const Icon(Icons.search, color: Colors.grey),
                filled: true,
                fillColor: Colors.white,
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                  borderSide: BorderSide.none,
                ),
                contentPadding: const EdgeInsets.symmetric(vertical: 0),
              ),
            ),
          ),

          const SizedBox(height: 20),

          // 3. Filtros
          SizedBox(
            height: 40,
            child: ListView(
              scrollDirection: Axis.horizontal,
              padding: const EdgeInsets.symmetric(horizontal: 24),
              children: [
                _FilterChip(
                  label: 'Todos',
                  isSelected: _currentFilter == 'Todos',
                  onTap: () => _onFilterChanged(homeContext, 'Todos'),
                ),
                _FilterChip(
                  label: 'Perro',
                  isSelected: _currentFilter == 'Perro',
                  onTap: () => _onFilterChanged(homeContext, 'Perro'),
                ),
                _FilterChip(
                  label: 'Gato',
                  isSelected: _currentFilter == 'Gato',
                  onTap: () => _onFilterChanged(homeContext, 'Gato'),
                ),
              ],
            ),
          ),
          const SizedBox(height: 20),

          // 4. Grilla
          Expanded(
            child: BlocBuilder<PetBloc, PetState>(
              builder: (context, state) {
                if (state is PetLoading) {
                  return const Center(child: CircularProgressIndicator());
                } else if (state is PetLoaded) {
                  if (state.pets.isEmpty) {
                    return Center(
                        child: Text('No hay mascotas ($_currentFilter)'));
                  }
                  return RefreshIndicator(
                    onRefresh: () async => context.read<PetBloc>().add(LoadPets(
                        filter: _currentFilter, searchQuery: _searchQuery)),
                    child: GridView.builder(
                      padding: const EdgeInsets.symmetric(
                          horizontal: 24, vertical: 10),
                      gridDelegate:
                          const SliverGridDelegateWithFixedCrossAxisCount(
                        crossAxisCount: 2,
                        childAspectRatio: 0.75,
                        crossAxisSpacing: 16,
                        mainAxisSpacing: 16,
                      ),
                      itemCount: state.pets.length,
                      itemBuilder: (context, index) {
                        final pet = state.pets[index];
                        return PetCard(
                          pet: pet,
                          userLocation: _userPosition,
                          onTap: () {
                            Navigator.push(
                              context,
                              MaterialPageRoute(
                                builder: (_) => PetDetailPage(
                                  pet: pet,
                                  userLocation: _userPosition,
                                ),
                              ),
                            );
                          },
                        );
                      },
                    ),
                  );
                }
                return const SizedBox.shrink();
              },
            ),
          ),
        ],
      );
    });
  }
}

// (Mant茅n la clase _FilterChip igual que antes al final del archivo)
class _FilterChip extends StatelessWidget {
  final String label;
  final bool isSelected;
  final VoidCallback onTap;

  const _FilterChip(
      {required this.label, required this.isSelected, required this.onTap});

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        margin: const EdgeInsets.only(right: 10),
        padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 8),
        decoration: BoxDecoration(
          color: isSelected ? const Color(0xFFFF8B3D) : Colors.white,
          borderRadius: BorderRadius.circular(20),
          border: isSelected ? null : Border.all(color: Colors.grey.shade300),
          boxShadow: isSelected
              ? [
                  BoxShadow(
                      color: const Color(0xFFFF8B3D).withOpacity(0.3),
                      blurRadius: 8,
                      offset: const Offset(0, 4))
                ]
              : null,
        ),
        child: Center(
          child: Text(
            label,
            style: TextStyle(
              color: isSelected ? Colors.white : Colors.grey[700],
              fontWeight: FontWeight.bold,
            ),
          ),
        ),
      ),
    );
  }
}
</file>

<file path="lib/features/pet_management/presentation/pages/create_pet_page.dart">
import 'dart:io';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:image_picker/image_picker.dart';
import 'package:uuid/uuid.dart';
import 'package:latlong2/latlong.dart';
import '../../../../injection_container.dart';
import '../../../auth/presentation/bloc/auth_bloc.dart';
import '../../../auth/presentation/bloc/auth_state.dart';
import '../../domain/entities/pet_entity.dart';
import '../bloc/pet_bloc.dart';
import '../bloc/pet_event.dart';
import '../bloc/pet_state.dart';
import '../../../auth/presentation/widgets/custom_text_field.dart';
import '../../../auth/presentation/widgets/loading_overlay.dart';
import 'location_picker_page.dart';

class CreatePetPage extends StatefulWidget {
  final PetEntity?
      petToEdit; // Si es null, es CREAR. Si tiene datos, es EDITAR.

  const CreatePetPage({super.key, this.petToEdit});

  @override
  State<CreatePetPage> createState() => _CreatePetPageState();
}

class _CreatePetPageState extends State<CreatePetPage> {
  final _formKey = GlobalKey<FormState>();
  late TextEditingController _nameController;
  late TextEditingController _breedController;
  late TextEditingController _ageController;
  late TextEditingController _descriptionController;

  late String _selectedSpecies;
  late String _selectedGender;
  late String _selectedSize;

  File? _imageFile; // Foto nueva seleccionada
  final _picker = ImagePicker();

  LatLng _petLocation = const LatLng(0, 0); // Ubicaci贸n por defecto

  @override
  void initState() {
    super.initState();
    // Inicializar datos (Pre-llenar si es edici贸n)
    final pet = widget.petToEdit;
    _nameController = TextEditingController(text: pet?.name ?? '');
    _breedController = TextEditingController(text: pet?.breed ?? '');
    _ageController = TextEditingController(text: pet?.age ?? '');
    _descriptionController =
        TextEditingController(text: pet?.description ?? '');

    _selectedSpecies = pet?.species ?? 'Perro';
    _selectedGender = pet?.gender ?? 'Macho';
    _selectedSize = pet?.size ?? 'Mediano';

    // Cargar ubicaci贸n existente si hay
    if (pet != null) {
      _petLocation = LatLng(pet.locationLat, pet.locationLng);
    }
  }

  // Selecci贸n de Imagen (C谩mara o Galer铆a)
  void _showImageSourceActionSheet(BuildContext context) {
    showModalBottomSheet(
      context: context,
      builder: (BuildContext _) {
        return SafeArea(
          child: Wrap(
            children: <Widget>[
              ListTile(
                leading: const Icon(Icons.photo_library),
                title: const Text('Galer铆a'),
                onTap: () {
                  _pickImage(ImageSource.gallery);
                  Navigator.of(context).pop();
                },
              ),
              ListTile(
                leading: const Icon(Icons.camera_alt),
                title: const Text('C谩mara'),
                onTap: () {
                  _pickImage(ImageSource.camera);
                  Navigator.of(context).pop();
                },
              ),
            ],
          ),
        );
      },
    );
  }

  Future<void> _pickImage(ImageSource source) async {
    try {
      final pickedFile =
          await _picker.pickImage(source: source, imageQuality: 50);
      if (pickedFile != null) {
        setState(() {
          _imageFile = File(pickedFile.path);
        });
      }
    } catch (e) {
      // Manejar error silenciosamente o mostrar snackbar
    }
  }

  // Selecci贸n de Ubicaci贸n (Abre el Mapa)
  Future<void> _pickLocation() async {
    final LatLng? result = await Navigator.push(
      context,
      MaterialPageRoute(
        builder: (_) => LocationPickerPage(initialLocation: _petLocation),
      ),
    );

    if (result != null) {
      setState(() {
        _petLocation = result;
      });
    }
  }

  void _submit(BuildContext context) {
    FocusScope.of(context).unfocus();

    if (_formKey.currentState!.validate()) {
      // Validaci贸n de imagen: Debe tener foto nueva O estar editando una existente
      if (_imageFile == null && widget.petToEdit == null) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('Debes seleccionar una foto')),
        );
        return;
      }

      final authState = context.read<AuthBloc>().state;
      if (authState is AuthAuthenticated) {
        // --- MODO EDICIN ---
        if (widget.petToEdit != null) {
          final updatedPet = PetEntity(
            id: widget.petToEdit!.id,
            name: _nameController.text,
            species: _selectedSpecies,
            breed: _breedController.text,
            age: _ageController.text,
            size: _selectedSize,
            gender: _selectedGender,
            description: _descriptionController.text,
            imageUrl: widget.petToEdit!.imageUrl,
            // USAMOS LAS COORDENADAS SELECCIONADAS
            locationLat: _petLocation.latitude,
            locationLng: _petLocation.longitude,
            shelterId: widget.petToEdit!.shelterId,
            isAdopted: widget.petToEdit!.isAdopted,
          );

          context
              .read<PetBloc>()
              .add(UpdatePet(pet: updatedPet, newImage: _imageFile));
        }
        // --- MODO CREACIN ---
        else {
          final newPet = PetEntity(
            id: const Uuid().v4(),
            name: _nameController.text,
            species: _selectedSpecies,
            breed: _breedController.text,
            age: _ageController.text,
            size: _selectedSize,
            gender: _selectedGender,
            description: _descriptionController.text,
            imageUrl: '', // Se llena en el backend
            // USAMOS LAS COORDENADAS SELECCIONADAS
            locationLat: _petLocation.latitude,
            locationLng: _petLocation.longitude,
            shelterId: authState.user.id,
            isAdopted: false,
          );

          context
              .read<PetBloc>()
              .add(CreatePet(pet: newPet, imageFile: _imageFile!));
        }
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    final isEditing = widget.petToEdit != null;

    return BlocProvider(
      create: (_) => getIt<PetBloc>(),
      child: BlocConsumer<PetBloc, PetState>(
        listener: (context, state) {
          if (state is PetOperationSuccess) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                  content: Text(state.message), backgroundColor: Colors.green),
            );
            Navigator.pop(context);
          } else if (state is PetError) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                  content: Text(state.message), backgroundColor: Colors.red),
            );
          }
        },
        builder: (builderContext, state) {
          return LoadingOverlay(
            isLoading: state is PetLoading,
            child: Scaffold(
              appBar: AppBar(
                  title: Text(isEditing ? 'Editar Mascota' : 'Nueva Mascota')),
              body: SingleChildScrollView(
                padding: const EdgeInsets.all(16),
                child: Form(
                  key: _formKey,
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.stretch,
                    children: [
                      // --- 1. REA DE FOTO ---
                      GestureDetector(
                        onTap: () => _showImageSourceActionSheet(context),
                        child: Container(
                          height: 200,
                          decoration: BoxDecoration(
                            color: Colors.grey[200],
                            borderRadius: BorderRadius.circular(12),
                            border: Border.all(color: Colors.grey.shade300),
                            image: _imageFile != null
                                ? DecorationImage(
                                    image: FileImage(_imageFile!),
                                    fit: BoxFit.cover)
                                : (isEditing &&
                                        widget.petToEdit!.imageUrl.isNotEmpty)
                                    ? DecorationImage(
                                        image: NetworkImage(
                                            widget.petToEdit!.imageUrl),
                                        fit: BoxFit.cover)
                                    : null,
                          ),
                          child: (_imageFile == null && !isEditing)
                              ? const Column(
                                  mainAxisAlignment: MainAxisAlignment.center,
                                  children: [
                                    Icon(Icons.camera_alt,
                                        size: 50, color: Colors.grey),
                                    Text('Toca para agregar foto')
                                  ],
                                )
                              : null,
                        ),
                      ),
                      if (isEditing)
                        const Padding(
                          padding: EdgeInsets.all(8.0),
                          child: Text('Toca la imagen para cambiarla',
                              textAlign: TextAlign.center,
                              style: TextStyle(color: Colors.grey)),
                        ),
                      const SizedBox(height: 20),

                      // --- 2. CAMPOS DE TEXTO ---
                      CustomTextField(
                          controller: _nameController,
                          label: 'Nombre',
                          hint: 'Ej: Firulais',
                          prefixIcon: Icons.pets),
                      const SizedBox(height: 10),

                      DropdownButtonFormField<String>(
                        value: _selectedSpecies,
                        decoration: const InputDecoration(
                            labelText: 'Especie', border: OutlineInputBorder()),
                        items: ['Perro', 'Gato']
                            .map((e) =>
                                DropdownMenuItem(value: e, child: Text(e)))
                            .toList(),
                        onChanged: (v) => setState(() => _selectedSpecies = v!),
                      ),
                      const SizedBox(height: 10),

                      CustomTextField(
                          controller: _breedController,
                          label: 'Raza',
                          hint: 'Ej: Labrador',
                          prefixIcon: Icons.category),
                      const SizedBox(height: 10),

                      CustomTextField(
                          controller: _ageController,
                          label: 'Edad',
                          hint: 'Ej: 2 a帽os',
                          prefixIcon: Icons.cake),
                      const SizedBox(height: 10),

                      Row(
                        children: [
                          Expanded(
                            child: DropdownButtonFormField<String>(
                              value: _selectedGender,
                              decoration: const InputDecoration(
                                  labelText: 'Sexo',
                                  border: OutlineInputBorder()),
                              items: ['Macho', 'Hembra']
                                  .map((e) => DropdownMenuItem(
                                      value: e, child: Text(e)))
                                  .toList(),
                              onChanged: (v) =>
                                  setState(() => _selectedGender = v!),
                            ),
                          ),
                          const SizedBox(width: 10),
                          Expanded(
                            child: DropdownButtonFormField<String>(
                              value: _selectedSize,
                              decoration: const InputDecoration(
                                  labelText: 'Tama帽o',
                                  border: OutlineInputBorder()),
                              items: ['Peque帽o', 'Mediano', 'Grande']
                                  .map((e) => DropdownMenuItem(
                                      value: e, child: Text(e)))
                                  .toList(),
                              onChanged: (v) =>
                                  setState(() => _selectedSize = v!),
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 10),

                      CustomTextField(
                          controller: _descriptionController,
                          label: 'Descripci贸n',
                          hint: 'Historia...',
                          prefixIcon: Icons.description),
                      const SizedBox(height: 20),

                      // --- 3. CAMPO DE UBICACIN (NUEVO) ---
                      const Text('Ubicaci贸n del Refugio',
                          style: TextStyle(
                              fontWeight: FontWeight.bold, fontSize: 16)),
                      const SizedBox(height: 8),
                      InkWell(
                        onTap: _pickLocation, // Abre el mapa
                        child: Container(
                          padding: const EdgeInsets.symmetric(
                              horizontal: 12, vertical: 16),
                          decoration: BoxDecoration(
                            border: Border.all(color: Colors.grey),
                            borderRadius: BorderRadius.circular(12),
                          ),
                          child: Row(
                            children: [
                              const Icon(Icons.location_on,
                                  color: Colors.orange),
                              const SizedBox(width: 12),
                              Expanded(
                                child: Text(
                                  (_petLocation.latitude == 0 &&
                                          _petLocation.longitude == 0)
                                      ? 'Toca para seleccionar en el mapa'
                                      : 'Lat: ${_petLocation.latitude.toStringAsFixed(4)}, Lng: ${_petLocation.longitude.toStringAsFixed(4)}',
                                  style: TextStyle(
                                    color: (_petLocation.latitude == 0)
                                        ? Colors.grey
                                        : Colors.black,
                                  ),
                                ),
                              ),
                              const Icon(Icons.arrow_forward_ios,
                                  size: 16, color: Colors.grey),
                            ],
                          ),
                        ),
                      ),
                      const SizedBox(height: 30),

                      // --- 4. BOTN PUBLICAR ---
                      ElevatedButton(
                        onPressed: state is PetLoading
                            ? null
                            : () => _submit(builderContext),
                        child: Text(
                            isEditing ? 'Guardar Cambios' : 'Publicar Mascota'),
                      ),
                    ],
                  ),
                ),
              ),
            ),
          );
        },
      ),
    );
  }
}
</file>

<file path="lib/features/pet_management/presentation/pages/pet_detail_page.dart">
import 'package:flutter/material.dart';
import 'package:latlong2/latlong.dart';
import '../../domain/entities/pet_entity.dart';

class PetDetailPage extends StatelessWidget {
  final PetEntity pet;
  final LatLng? userLocation;
  final String? locationName;

  const PetDetailPage({
    super.key,
    required this.pet,
    this.userLocation, // Recibimos la ubicaci贸n del usuario
    this.locationName, // Recibimos el nombre del lugar (opcional)
  });

  // Funci贸n auxiliar para calcular distancia
  String _calculateDistance() {
    if (userLocation == null) return '';
    if (pet.locationLat == 0 && pet.locationLng == 0) return '';

    final Distance distance = const Distance();
    final double km = distance.as(
      LengthUnit.Kilometer,
      userLocation!,
      LatLng(pet.locationLat, pet.locationLng),
    );

    if (km < 1) {
      final double meters = distance.as(
        LengthUnit.Meter,
        userLocation!,
        LatLng(pet.locationLat, pet.locationLng),
      );
      return '${meters.round()} m';
    }
    return '${km.toStringAsFixed(1)} km';
  }

  // Funci贸n para obtener el nombre del lugar
  String _getLocationName() {
    // 1. Si ya nos pasaron el nombre (desde el mapa), lo usamos directo
    if (locationName != null && locationName!.isNotEmpty) return locationName!;

    // 2. Si no (venimos del Home), intentamos deducirlo por coordenadas
    final lat = pet.locationLat;
    final lng = pet.locationLng;

    // Usamos una peque帽a tolerancia para comparar floats
    if ((lat - -0.210300).abs() < 0.001 && (lng - -78.489000).abs() < 0.001) {
      return 'Poliperros EPN';
    }
    if ((lat - -0.217300).abs() < 0.001 && (lng - -78.402000).abs() < 0.001) {
      return 'PAE Tumbaco';
    }
    if ((lat - -0.180653).abs() < 0.001 && (lng - -78.467834).abs() < 0.001) {
      return 'Parque La Carolina';
    }

    // 3. Default si no coincide con ninguno
    return 'Refugio Aliado';
  }

  @override
  Widget build(BuildContext context) {
    final distanceText = _calculateDistance();
    final placeName = _getLocationName();

    return Scaffold(
      backgroundColor: const Color(0xFFFFF8F0),
      body: CustomScrollView(
        slivers: [
          // --- 1. IMAGEN (AppBar El谩stica) ---
          SliverAppBar(
            expandedHeight: 350,
            pinned: true,
            backgroundColor: Colors.transparent,
            elevation: 0,
            leading: CircleAvatar(
              backgroundColor: Colors.white.withOpacity(0.5),
              child: IconButton(
                icon: const Icon(Icons.arrow_back, color: Colors.black),
                onPressed: () => Navigator.pop(context),
              ),
            ),
            flexibleSpace: FlexibleSpaceBar(
              background: Hero(
                tag: pet.id,
                child: Image.network(
                  pet.imageUrl,
                  fit: BoxFit.cover,
                  errorBuilder: (_, __, ___) => Container(
                    color: Colors.grey[200],
                    child: const Center(
                        child: Icon(Icons.pets, size: 50, color: Colors.grey)),
                  ),
                ),
              ),
            ),
          ),

          // --- 2. CONTENIDO PRINCIPAL ---
          SliverToBoxAdapter(
            child: Container(
              transform: Matrix4.translationValues(0, -20, 0),
              decoration: const BoxDecoration(
                color: Color(0xFFFFF8F0),
                borderRadius: BorderRadius.vertical(top: Radius.circular(30)),
              ),
              padding: const EdgeInsets.all(24),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // Header: Nombre, Raza y Estado
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              pet.name,
                              style: const TextStyle(
                                fontSize: 28,
                                fontWeight: FontWeight.bold,
                                color: Color(0xFF2D3436),
                              ),
                            ),
                            Text(
                              pet.breed,
                              style: TextStyle(
                                fontSize: 16,
                                color: Colors.grey[600],
                              ),
                            ),
                          ],
                        ),
                      ),
                      Container(
                        padding: const EdgeInsets.symmetric(
                            horizontal: 12, vertical: 6),
                        decoration: BoxDecoration(
                          color: const Color(0xFFE0F2F1),
                          borderRadius: BorderRadius.circular(20),
                        ),
                        child: const Text(
                          'Disponible',
                          style: TextStyle(
                            color: Color(0xFF00695C),
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ),
                    ],
                  ),

                  const SizedBox(height: 20),

                  // --- TARJETA DE UBICACIN (NUEVO) ---
                  Container(
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: Colors.white,
                      borderRadius: BorderRadius.circular(16),
                      border: Border.all(color: Colors.grey.shade200),
                      boxShadow: [
                        BoxShadow(
                          color: Colors.black.withOpacity(0.02),
                          blurRadius: 10,
                          offset: const Offset(0, 4),
                        )
                      ],
                    ),
                    child: Row(
                      children: [
                        // Icono de Tienda/Refugio
                        Container(
                          padding: const EdgeInsets.all(10),
                          decoration: BoxDecoration(
                            color: const Color(0xFFE0F2F1), // Fondo menta suave
                            borderRadius: BorderRadius.circular(12),
                          ),
                          child: const Icon(Icons.store_mall_directory,
                              color: Color(0xFF00695C), size: 24),
                        ),
                        const SizedBox(width: 16),
                        // Textos
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(
                                placeName, // Muestra "Poliperros EPN", etc.
                                style: const TextStyle(
                                  fontWeight: FontWeight.bold,
                                  fontSize: 16,
                                  color: Color(0xFF2D3436),
                                ),
                              ),
                              const SizedBox(height: 4),
                              // Muestra la distancia si existe
                              if (distanceText.isNotEmpty)
                                Row(
                                  children: [
                                    const Icon(Icons.near_me,
                                        size: 14, color: Colors.grey),
                                    const SizedBox(width: 4),
                                    Text(
                                      'A $distanceText de ti',
                                      style: TextStyle(
                                          fontSize: 13,
                                          color: Colors.grey[600]),
                                    ),
                                  ],
                                )
                              else
                                Text(
                                  'Ver en mapa',
                                  style: TextStyle(
                                      fontSize: 13, color: Colors.grey[600]),
                                ),
                            ],
                          ),
                        ),
                        // Bot贸n peque帽o para ir al mapa (opcional visualmente)
                        const Icon(Icons.arrow_forward_ios,
                            size: 16, color: Colors.grey),
                      ],
                    ),
                  ),
                  // ------------------------------------

                  const SizedBox(height: 24),

                  // Cajas de Informaci贸n (Edad, Sexo, Tama帽o)
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      _InfoBox(title: 'Edad', value: pet.age),
                      _InfoBox(title: 'Sexo', value: pet.gender),
                      _InfoBox(title: 'Tama帽o', value: pet.size),
                    ],
                  ),
                  const SizedBox(height: 24),

                  // Descripci贸n
                  const Text(
                    'Sobre m铆',
                    style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
                  ),
                  const SizedBox(height: 8),
                  Text(
                    pet.description,
                    style: TextStyle(
                      fontSize: 15,
                      color: Colors.grey[700],
                      height: 1.5,
                    ),
                  ),
                  const SizedBox(height: 100), // Espacio para el bot贸n flotante
                ],
              ),
            ),
          ),
        ],
      ),

      // Bot贸n Inferior
      floatingActionButton: Container(
        width: double.infinity,
        padding: const EdgeInsets.symmetric(horizontal: 24),
        child: FloatingActionButton.extended(
          onPressed: () {
            ScaffoldMessenger.of(context).showSnackBar(
              const SnackBar(
                  content:
                      Text('Solicitud de adopci贸n en construcci贸n (Fase 5)')),
            );
          },
          backgroundColor: const Color(0xFFFF8B3D),
          label: const Text('Solicitar Adopci贸n',
              style:
                  TextStyle(fontWeight: FontWeight.bold, color: Colors.white)),
          icon: const Icon(Icons.favorite, color: Colors.white),
        ),
      ),
      floatingActionButtonLocation: FloatingActionButtonLocation.centerFloat,
    );
  }
}

// Widget auxiliar para las cajitas de info
class _InfoBox extends StatelessWidget {
  final String title;
  final String value;

  const _InfoBox({required this.title, required this.value});

  @override
  Widget build(BuildContext context) {
    return Container(
      width: 100,
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(color: Colors.black.withOpacity(0.05), blurRadius: 10),
        ],
      ),
      child: Column(
        children: [
          Text(
            value,
            style: const TextStyle(
                fontWeight: FontWeight.bold,
                fontSize: 16,
                color: Color(0xFFFF8B3D)),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 4),
          Text(title, style: TextStyle(fontSize: 12, color: Colors.grey[500])),
        ],
      ),
    );
  }
}
</file>

<file path="lib/features/pet_management/presentation/widgets/pet_card.dart">
import 'package:flutter/material.dart';
import 'package:latlong2/latlong.dart'; // Para LatLng y Distance
import '../../domain/entities/pet_entity.dart';

class PetCard extends StatelessWidget {
  final PetEntity pet;
  final VoidCallback onTap;
  final LatLng? userLocation; // <--- Recibimos ubicaci贸n del usuario

  const PetCard({
    super.key,
    required this.pet,
    required this.onTap,
    this.userLocation, // Opcional (puede ser null si no hay GPS)
  });

  // Funci贸n auxiliar para calcular distancia
  String _calculateDistance() {
    if (userLocation == null) return '';
    // Si la mascota no tiene ubicaci贸n (0,0), no mostramos nada
    if (pet.locationLat == 0 && pet.locationLng == 0) return '';

    final Distance distance = const Distance();
    final double km = distance.as(
      LengthUnit.Kilometer,
      userLocation!,
      LatLng(pet.locationLat, pet.locationLng),
    );

    if (km < 1) {
      // Si es menos de 1km, mostramos metros
      final double meters = distance.as(
        LengthUnit.Meter,
        userLocation!,
        LatLng(pet.locationLat, pet.locationLng),
      );
      return '${meters.round()} m';
    }
    return '${km.toStringAsFixed(1)} km';
  }

  @override
  Widget build(BuildContext context) {
    final distanceText = _calculateDistance();

    return GestureDetector(
      onTap: onTap,
      child: Container(
        decoration: BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.circular(20),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.05),
              blurRadius: 10,
              offset: const Offset(0, 5),
            ),
          ],
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: [
            // IMAGEN
            Expanded(
              child: Stack(
                children: [
                  Positioned.fill(
                    child: ClipRRect(
                      borderRadius:
                          const BorderRadius.vertical(top: Radius.circular(20)),
                      child: Hero(
                        tag: pet.id,
                        child: Image.network(
                          pet.imageUrl,
                          fit: BoxFit.cover,
                          errorBuilder: (_, __, ___) => Container(
                            color: Colors.grey[200],
                            child: Icon(Icons.pets,
                                size: 40, color: Colors.grey[400]),
                          ),
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            ),

            // INFORMACIN
            Padding(
              padding: const EdgeInsets.all(12.0),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Flexible(
                        child: Text(
                          pet.name,
                          style: const TextStyle(
                            fontSize: 16,
                            fontWeight:
                                FontWeight.w800,
                            color: Color(0xFF2D3436),
                          ),
                          maxLines: 1,
                          overflow: TextOverflow.ellipsis,
                        ),
                      ),
                      Icon(
                        pet.gender == 'Macho' ? Icons.male : Icons.female,
                        size: 16,
                        color:
                            pet.gender == 'Macho' ? Colors.blue : Colors.pink,
                      ),
                    ],
                  ),
                  const SizedBox(height: 4),

                  // Raza y Edad
                  Text(
                    '${pet.breed}  ${pet.age}',
                    style: TextStyle(fontSize: 12, color: Colors.grey[600]),
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                  ),

                  const SizedBox(height: 8),

                  // --- NUEVA TARJETA DE UBICACIN ---
                  if (distanceText.isNotEmpty)
                    Row(
                      children: [
                        const Icon(Icons.location_on,
                            size: 14,
                            color: Color(0xFFFF8B3D)), // Color Naranja marca
                        const SizedBox(width: 4),
                        Text(
                          distanceText, // "2.5 km"
                          style: TextStyle(
                            fontSize: 12,
                            fontWeight: FontWeight.w600,
                            color: Colors.grey[700],
                          ),
                        ),
                      ],
                    )
                  else
                    // Si no hay ubicaci贸n, mostramos algo gen茅rico o nada
                    Row(
                      children: [
                        Icon(Icons.location_on_outlined,
                            size: 14, color: Colors.grey[400]),
                        const SizedBox(width: 4),
                        Text(
                          'Ver ubicaci贸n',
                          style:
                              TextStyle(fontSize: 12, color: Colors.grey[400]),
                        ),
                      ],
                    ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
}
</file>

<file path="lib/injection_container.config.dart">
// dart format width=80
// GENERATED CODE - DO NOT MODIFY BY HAND

// **************************************************************************
// InjectableConfigGenerator
// **************************************************************************

// ignore_for_file: type=lint
// coverage:ignore-file

// ignore_for_file: no_leading_underscores_for_library_prefixes
import 'package:connectivity_plus/connectivity_plus.dart' as _i895;
import 'package:get_it/get_it.dart' as _i174;
import 'package:http/http.dart' as _i519;
import 'package:injectable/injectable.dart' as _i526;
import 'package:prueba_bim2/core/network/network_info.dart' as _i949;
import 'package:prueba_bim2/features/ai_assistant/data/datasources/ai_remote_data_source.dart'
    as _i703;
import 'package:prueba_bim2/features/ai_assistant/data/repositories/ai_repository_impl.dart'
    as _i95;
import 'package:prueba_bim2/features/ai_assistant/domain/repositories/ai_repository.dart'
    as _i115;
import 'package:prueba_bim2/features/ai_assistant/presentation/bloc/chat_bloc.dart'
    as _i909;
import 'package:prueba_bim2/features/auth/data/datasources/auth_remote_data_source.dart'
    as _i714;
import 'package:prueba_bim2/features/auth/data/repositories/auth_repository_impl.dart'
    as _i1008;
import 'package:prueba_bim2/features/auth/domain/repositories/auth_repository.dart'
    as _i169;
import 'package:prueba_bim2/features/auth/domain/usecases/get_current_user.dart'
    as _i587;
import 'package:prueba_bim2/features/auth/domain/usecases/reset_password.dart'
    as _i796;
import 'package:prueba_bim2/features/auth/domain/usecases/sign_in.dart' as _i74;
import 'package:prueba_bim2/features/auth/domain/usecases/sign_out.dart'
    as _i926;
import 'package:prueba_bim2/features/auth/domain/usecases/sign_up.dart'
    as _i695;
import 'package:prueba_bim2/features/auth/presentation/bloc/auth_bloc.dart'
    as _i916;
import 'package:prueba_bim2/features/pet_management/data/datasources/pet_remote_data_source.dart'
    as _i236;
import 'package:prueba_bim2/features/pet_management/data/repositories/pet_repository_impl.dart'
    as _i1036;
import 'package:prueba_bim2/features/pet_management/domain/repositories/pet_repository.dart'
    as _i1019;
import 'package:prueba_bim2/features/pet_management/presentation/bloc/pet_bloc.dart'
    as _i262;
import 'package:supabase_flutter/supabase_flutter.dart' as _i454;

extension GetItInjectableX on _i174.GetIt {
// initializes the registration of main-scope dependencies inside of GetIt
  _i174.GetIt init({
    String? environment,
    _i526.EnvironmentFilter? environmentFilter,
  }) {
    final gh = _i526.GetItHelper(
      this,
      environment,
      environmentFilter,
    );
    gh.lazySingleton<_i949.NetworkInfo>(
        () => _i949.NetworkInfoImpl(gh<_i895.Connectivity>()));
    gh.lazySingleton<_i714.AuthRemoteDataSource>(
        () => _i714.AuthRemoteDataSourceImpl(gh<_i454.SupabaseClient>()));
    gh.lazySingleton<_i236.PetRemoteDataSource>(
        () => _i236.PetRemoteDataSourceImpl(gh<_i454.SupabaseClient>()));
    gh.lazySingleton<_i1019.PetRepository>(() => _i1036.PetRepositoryImpl(
          remoteDataSource: gh<_i236.PetRemoteDataSource>(),
          networkInfo: gh<_i949.NetworkInfo>(),
        ));
    gh.factory<_i262.PetBloc>(() => _i262.PetBloc(gh<_i1019.PetRepository>()));
    gh.lazySingleton<_i703.AIRemoteDataSource>(
        () => _i703.AIRemoteDataSourceImpl(gh<_i519.Client>()));
    gh.lazySingleton<_i169.AuthRepository>(() => _i1008.AuthRepositoryImpl(
          remoteDataSource: gh<_i714.AuthRemoteDataSource>(),
          networkInfo: gh<_i949.NetworkInfo>(),
        ));
    gh.factory<_i587.GetCurrentUser>(
        () => _i587.GetCurrentUser(gh<_i169.AuthRepository>()));
    gh.factory<_i796.ResetPassword>(
        () => _i796.ResetPassword(gh<_i169.AuthRepository>()));
    gh.factory<_i74.SignIn>(() => _i74.SignIn(gh<_i169.AuthRepository>()));
    gh.factory<_i926.SignOut>(() => _i926.SignOut(gh<_i169.AuthRepository>()));
    gh.factory<_i695.SignUp>(() => _i695.SignUp(gh<_i169.AuthRepository>()));
    gh.lazySingleton<_i115.AIRepository>(
        () => _i95.AIRepositoryImpl(gh<_i703.AIRemoteDataSource>()));
    gh.factory<_i916.AuthBloc>(() => _i916.AuthBloc(
          signIn: gh<_i74.SignIn>(),
          signUp: gh<_i695.SignUp>(),
          resetPassword: gh<_i796.ResetPassword>(),
          signOut: gh<_i926.SignOut>(),
          getCurrentUser: gh<_i587.GetCurrentUser>(),
        ));
    gh.factory<_i909.ChatBloc>(() => _i909.ChatBloc(gh<_i115.AIRepository>()));
    return this;
  }
}
</file>

<file path="lib/main.dart">
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:flutter_dotenv/flutter_dotenv.dart';
import 'core/theme/app_theme.dart';
import 'features/auth/presentation/bloc/auth_bloc.dart';
import 'features/auth/presentation/bloc/auth_event.dart';
import 'features/auth/presentation/bloc/auth_state.dart';
import 'features/auth/presentation/pages/login_page.dart';
import 'features/auth/presentation/pages/welcome_page.dart';
import 'injection_container.dart'; // Da acceso a getIt y configureDependencies

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // 1. CARGA SEGURA DEL .ENV (Correcci贸n clave)
  // Usamos try-catch para que la app no muera si falla la carga del archivo
  try {
    await dotenv.load(fileName: ".env");
  } catch (e) {
    debugPrint("锔 Advertencia: No se pudo cargar el archivo .env: $e");
  }

  // 2. INICIALIZAR DEPENDENCIAS
  await configureDependencies();

  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return BlocProvider(
      // Inyectamos el AuthBloc y lanzamos el evento de verificaci贸n al inicio
      create: (_) => getIt<AuthBloc>()..add(const AuthCheckRequested()),
      child: MaterialApp(
        title: 'PetAdopt',
        debugShowCheckedModeBanner: false,
        theme: AppTheme.lightTheme,
        // Manejador de estado global de Autenticaci贸n
        home: BlocBuilder<AuthBloc, AuthState>(
          builder: (context, state) {
            // Solo mostramos loading global si el BLoC est谩 reci茅n creado
            if (state is AuthInitial) {
              return const Scaffold(
                body: Center(child: CircularProgressIndicator()),
              );
            }

            // Si est谩 autenticado -> Vamos adentro
            else if (state is AuthAuthenticated) {
              return WelcomePage(user: state.user);
            }

            // Si no est谩 autenticado, hubo error, o est谩 cargando el login -> Vamos al Login
            else {
              return const LoginPage();
            }
          },
        ),
      ),
    );
  }
}
</file>

<file path="pubspec.lock">
# Generated by pub
# See https://dart.dev/tools/pub/glossary#lockfile
packages:
  _fe_analyzer_shared:
    dependency: transitive
    description:
      name: _fe_analyzer_shared
      sha256: da0d9209ca76bde579f2da330aeb9df62b6319c834fa7baae052021b0462401f
      url: "https://pub.dev"
    source: hosted
    version: "85.0.0"
  adaptive_number:
    dependency: transitive
    description:
      name: adaptive_number
      sha256: "3a567544e9b5c9c803006f51140ad544aedc79604fd4f3f2c1380003f97c1d77"
      url: "https://pub.dev"
    source: hosted
    version: "1.0.0"
  analyzer:
    dependency: transitive
    description:
      name: analyzer
      sha256: "974859dc0ff5f37bc4313244b3218c791810d03ab3470a579580279ba971a48d"
      url: "https://pub.dev"
    source: hosted
    version: "7.7.1"
  app_links:
    dependency: "direct main"
    description:
      name: app_links
      sha256: "5f88447519add627fe1cbcab4fd1da3d4fed15b9baf29f28b22535c95ecee3e8"
      url: "https://pub.dev"
    source: hosted
    version: "6.4.1"
  app_links_linux:
    dependency: transitive
    description:
      name: app_links_linux
      sha256: f5f7173a78609f3dfd4c2ff2c95bd559ab43c80a87dc6a095921d96c05688c81
      url: "https://pub.dev"
    source: hosted
    version: "1.0.3"
  app_links_platform_interface:
    dependency: transitive
    description:
      name: app_links_platform_interface
      sha256: "05f5379577c513b534a29ddea68176a4d4802c46180ee8e2e966257158772a3f"
      url: "https://pub.dev"
    source: hosted
    version: "2.0.2"
  app_links_web:
    dependency: transitive
    description:
      name: app_links_web
      sha256: af060ed76183f9e2b87510a9480e56a5352b6c249778d07bd2c95fc35632a555
      url: "https://pub.dev"
    source: hosted
    version: "1.0.4"
  args:
    dependency: transitive
    description:
      name: args
      sha256: d0481093c50b1da8910eb0bb301626d4d8eb7284aa739614d2b394ee09e3ea04
      url: "https://pub.dev"
    source: hosted
    version: "2.7.0"
  async:
    dependency: transitive
    description:
      name: async
      sha256: "947bfcf187f74dbc5e146c9eb9c0f10c9f8b30743e341481c1e2ed3ecc18c20c"
      url: "https://pub.dev"
    source: hosted
    version: "2.11.0"
  bloc:
    dependency: transitive
    description:
      name: bloc
      sha256: "106842ad6569f0b60297619e9e0b1885c2fb9bf84812935490e6c5275777804e"
      url: "https://pub.dev"
    source: hosted
    version: "8.1.4"
  boolean_selector:
    dependency: transitive
    description:
      name: boolean_selector
      sha256: "6cfb5af12253eaf2b368f07bacc5a80d1301a071c73360d746b7f2e32d762c66"
      url: "https://pub.dev"
    source: hosted
    version: "2.1.1"
  build:
    dependency: transitive
    description:
      name: build
      sha256: cef23f1eda9b57566c81e2133d196f8e3df48f244b317368d65c5943d91148f0
      url: "https://pub.dev"
    source: hosted
    version: "2.4.2"
  build_config:
    dependency: transitive
    description:
      name: build_config
      sha256: "4ae2de3e1e67ea270081eaee972e1bd8f027d459f249e0f1186730784c2e7e33"
      url: "https://pub.dev"
    source: hosted
    version: "1.1.2"
  build_daemon:
    dependency: transitive
    description:
      name: build_daemon
      sha256: "8e928697a82be082206edb0b9c99c5a4ad6bc31c9e9b8b2f291ae65cd4a25daa"
      url: "https://pub.dev"
    source: hosted
    version: "4.0.4"
  build_resolvers:
    dependency: transitive
    description:
      name: build_resolvers
      sha256: b9e4fda21d846e192628e7a4f6deda6888c36b5b69ba02ff291a01fd529140f0
      url: "https://pub.dev"
    source: hosted
    version: "2.4.4"
  build_runner:
    dependency: "direct dev"
    description:
      name: build_runner
      sha256: "058fe9dce1de7d69c4b84fada934df3e0153dd000758c4d65964d0166779aa99"
      url: "https://pub.dev"
    source: hosted
    version: "2.4.15"
  build_runner_core:
    dependency: transitive
    description:
      name: build_runner_core
      sha256: "22e3aa1c80e0ada3722fe5b63fd43d9c8990759d0a2cf489c8c5d7b2bdebc021"
      url: "https://pub.dev"
    source: hosted
    version: "8.0.0"
  built_collection:
    dependency: transitive
    description:
      name: built_collection
      sha256: "376e3dd27b51ea877c28d525560790aee2e6fbb5f20e2f85d5081027d94e2100"
      url: "https://pub.dev"
    source: hosted
    version: "5.1.1"
  built_value:
    dependency: transitive
    description:
      name: built_value
      sha256: "426cf75afdb23aa74bd4e471704de3f9393f3c7b04c1e2d9c6f1073ae0b8b139"
      url: "https://pub.dev"
    source: hosted
    version: "8.12.1"
  characters:
    dependency: transitive
    description:
      name: characters
      sha256: "04a925763edad70e8443c99234dc3328f442e811f1d8fd1a72f1c8ad0f69a605"
      url: "https://pub.dev"
    source: hosted
    version: "1.3.0"
  checked_yaml:
    dependency: transitive
    description:
      name: checked_yaml
      sha256: feb6bed21949061731a7a75fc5d2aa727cf160b91af9a3e464c5e3a32e28b5ff
      url: "https://pub.dev"
    source: hosted
    version: "2.0.3"
  clock:
    dependency: transitive
    description:
      name: clock
      sha256: cb6d7f03e1de671e34607e909a7213e31d7752be4fb66a86d29fe1eb14bfb5cf
      url: "https://pub.dev"
    source: hosted
    version: "1.1.1"
  code_builder:
    dependency: transitive
    description:
      name: code_builder
      sha256: "0ec10bf4a89e4c613960bf1e8b42c64127021740fb21640c29c909826a5eea3e"
      url: "https://pub.dev"
    source: hosted
    version: "4.10.1"
  collection:
    dependency: transitive
    description:
      name: collection
      sha256: a1ace0a119f20aabc852d165077c036cd864315bd99b7eaa10a60100341941bf
      url: "https://pub.dev"
    source: hosted
    version: "1.19.0"
  connectivity_plus:
    dependency: "direct main"
    description:
      name: connectivity_plus
      sha256: b5e72753cf63becce2c61fd04dfe0f1c430cc5278b53a1342dc5ad839eab29ec
      url: "https://pub.dev"
    source: hosted
    version: "6.1.5"
  connectivity_plus_platform_interface:
    dependency: transitive
    description:
      name: connectivity_plus_platform_interface
      sha256: "42657c1715d48b167930d5f34d00222ac100475f73d10162ddf43e714932f204"
      url: "https://pub.dev"
    source: hosted
    version: "2.0.1"
  convert:
    dependency: transitive
    description:
      name: convert
      sha256: b30acd5944035672bc15c6b7a8b47d773e41e2f17de064350988c5d02adb1c68
      url: "https://pub.dev"
    source: hosted
    version: "3.1.2"
  cross_file:
    dependency: transitive
    description:
      name: cross_file
      sha256: "7caf6a750a0c04effbb52a676dce9a4a592e10ad35c34d6d2d0e4811160d5670"
      url: "https://pub.dev"
    source: hosted
    version: "0.3.4+2"
  crypto:
    dependency: transitive
    description:
      name: crypto
      sha256: c8ea0233063ba03258fbcf2ca4d6dadfefe14f02fab57702265467a19f27fadf
      url: "https://pub.dev"
    source: hosted
    version: "3.0.7"
  cupertino_icons:
    dependency: "direct main"
    description:
      name: cupertino_icons
      sha256: ba631d1c7f7bef6b729a622b7b752645a2d076dba9976925b8f25725a30e1ee6
      url: "https://pub.dev"
    source: hosted
    version: "1.0.8"
  dart_earcut:
    dependency: transitive
    description:
      name: dart_earcut
      sha256: e485001bfc05dcbc437d7bfb666316182e3522d4c3f9668048e004d0eb2ce43b
      url: "https://pub.dev"
    source: hosted
    version: "1.2.0"
  dart_jsonwebtoken:
    dependency: transitive
    description:
      name: dart_jsonwebtoken
      sha256: "00a0812d2aeaeb0d30bcbc4dd3cee57971dbc0ab2216adf4f0247f37793f15ef"
      url: "https://pub.dev"
    source: hosted
    version: "2.17.0"
  dart_style:
    dependency: transitive
    description:
      name: dart_style
      sha256: "27eb0ae77836989a3bc541ce55595e8ceee0992807f14511552a898ddd0d88ac"
      url: "https://pub.dev"
    source: hosted
    version: "3.0.1"
  dartz:
    dependency: "direct main"
    description:
      name: dartz
      sha256: e6acf34ad2e31b1eb00948692468c30ab48ac8250e0f0df661e29f12dd252168
      url: "https://pub.dev"
    source: hosted
    version: "0.10.1"
  dbus:
    dependency: transitive
    description:
      name: dbus
      sha256: "79e0c23480ff85dc68de79e2cd6334add97e48f7f4865d17686dd6ea81a47e8c"
      url: "https://pub.dev"
    source: hosted
    version: "0.7.11"
  ed25519_edwards:
    dependency: transitive
    description:
      name: ed25519_edwards
      sha256: "6ce0112d131327ec6d42beede1e5dfd526069b18ad45dcf654f15074ad9276cd"
      url: "https://pub.dev"
    source: hosted
    version: "0.3.1"
  equatable:
    dependency: "direct main"
    description:
      name: equatable
      sha256: "3e0141505477fd8ad55d6eb4e7776d3fe8430be8e497ccb1521370c3f21a3e2b"
      url: "https://pub.dev"
    source: hosted
    version: "2.0.8"
  fake_async:
    dependency: transitive
    description:
      name: fake_async
      sha256: "511392330127add0b769b75a987850d136345d9227c6b94c96a04cf4a391bf78"
      url: "https://pub.dev"
    source: hosted
    version: "1.3.1"
  ffi:
    dependency: transitive
    description:
      name: ffi
      sha256: "16ed7b077ef01ad6170a3d0c57caa4a112a38d7a2ed5602e0aca9ca6f3d98da6"
      url: "https://pub.dev"
    source: hosted
    version: "2.1.3"
  file:
    dependency: transitive
    description:
      name: file
      sha256: a3b4f84adafef897088c160faf7dfffb7696046cb13ae90b508c2cbc95d3b8d4
      url: "https://pub.dev"
    source: hosted
    version: "7.0.1"
  file_selector_linux:
    dependency: transitive
    description:
      name: file_selector_linux
      sha256: "54cbbd957e1156d29548c7d9b9ec0c0ebb6de0a90452198683a7d23aed617a33"
      url: "https://pub.dev"
    source: hosted
    version: "0.9.3+2"
  file_selector_macos:
    dependency: transitive
    description:
      name: file_selector_macos
      sha256: "8c9250b2bd2d8d4268e39c82543bacbaca0fda7d29e0728c3c4bbb7c820fd711"
      url: "https://pub.dev"
    source: hosted
    version: "0.9.4+3"
  file_selector_platform_interface:
    dependency: transitive
    description:
      name: file_selector_platform_interface
      sha256: a3994c26f10378a039faa11de174d7b78eb8f79e4dd0af2a451410c1a5c3f66b
      url: "https://pub.dev"
    source: hosted
    version: "2.6.2"
  file_selector_windows:
    dependency: transitive
    description:
      name: file_selector_windows
      sha256: "320fcfb6f33caa90f0b58380489fc5ac05d99ee94b61aa96ec2bff0ba81d3c2b"
      url: "https://pub.dev"
    source: hosted
    version: "0.9.3+4"
  fixnum:
    dependency: transitive
    description:
      name: fixnum
      sha256: b6dc7065e46c974bc7c5f143080a6764ec7a4be6da1285ececdc37be96de53be
      url: "https://pub.dev"
    source: hosted
    version: "1.1.1"
  flutter:
    dependency: "direct main"
    description: flutter
    source: sdk
    version: "0.0.0"
  flutter_bloc:
    dependency: "direct main"
    description:
      name: flutter_bloc
      sha256: b594505eac31a0518bdcb4b5b79573b8d9117b193cc80cc12e17d639b10aa27a
      url: "https://pub.dev"
    source: hosted
    version: "8.1.6"
  flutter_dotenv:
    dependency: "direct main"
    description:
      name: flutter_dotenv
      sha256: b7c7be5cd9f6ef7a78429cabd2774d3c4af50e79cb2b7593e3d5d763ef95c61b
      url: "https://pub.dev"
    source: hosted
    version: "5.2.1"
  flutter_lints:
    dependency: "direct dev"
    description:
      name: flutter_lints
      sha256: "5398f14efa795ffb7a33e9b6a08798b26a180edac4ad7db3f231e40f82ce11e1"
      url: "https://pub.dev"
    source: hosted
    version: "5.0.0"
  flutter_map:
    dependency: "direct main"
    description:
      name: flutter_map
      sha256: "2ecb34619a4be19df6f40c2f8dce1591675b4eff7a6857bd8f533706977385da"
      url: "https://pub.dev"
    source: hosted
    version: "7.0.2"
  flutter_markdown:
    dependency: "direct main"
    description:
      name: flutter_markdown
      sha256: "08fb8315236099ff8e90cb87bb2b935e0a724a3af1623000a9cec930468e0f27"
      url: "https://pub.dev"
    source: hosted
    version: "0.7.7+1"
  flutter_plugin_android_lifecycle:
    dependency: transitive
    description:
      name: flutter_plugin_android_lifecycle
      sha256: "6382ce712ff69b0f719640ce957559dde459e55ecd433c767e06d139ddf16cab"
      url: "https://pub.dev"
    source: hosted
    version: "2.0.29"
  flutter_svg:
    dependency: "direct main"
    description:
      name: flutter_svg
      sha256: cd57f7969b4679317c17af6fd16ee233c1e60a82ed209d8a475c54fd6fd6f845
      url: "https://pub.dev"
    source: hosted
    version: "2.2.0"
  flutter_test:
    dependency: "direct dev"
    description: flutter
    source: sdk
    version: "0.0.0"
  flutter_web_plugins:
    dependency: transitive
    description: flutter
    source: sdk
    version: "0.0.0"
  frontend_server_client:
    dependency: transitive
    description:
      name: frontend_server_client
      sha256: f64a0333a82f30b0cca061bc3d143813a486dc086b574bfb233b7c1372427694
      url: "https://pub.dev"
    source: hosted
    version: "4.0.0"
  functions_client:
    dependency: transitive
    description:
      name: functions_client
      sha256: "94074d62167ae634127ef6095f536835063a7dc80f2b1aa306d2346ff9023996"
      url: "https://pub.dev"
    source: hosted
    version: "2.5.0"
  geocoding:
    dependency: "direct main"
    description:
      name: geocoding
      sha256: d580c801cba9386b4fac5047c4c785a4e19554f46be42f4f5e5b7deacd088a66
      url: "https://pub.dev"
    source: hosted
    version: "3.0.0"
  geocoding_android:
    dependency: transitive
    description:
      name: geocoding_android
      sha256: "1b13eca79b11c497c434678fed109c2be020b158cec7512c848c102bc7232603"
      url: "https://pub.dev"
    source: hosted
    version: "3.3.1"
  geocoding_ios:
    dependency: transitive
    description:
      name: geocoding_ios
      sha256: "18ab1c8369e2b0dcb3a8ccc907319334f35ee8cf4cfef4d9c8e23b13c65cb825"
      url: "https://pub.dev"
    source: hosted
    version: "3.1.0"
  geocoding_platform_interface:
    dependency: transitive
    description:
      name: geocoding_platform_interface
      sha256: "8c2c8226e5c276594c2e18bfe88b19110ed770aeb7c1ab50ede570be8b92229b"
      url: "https://pub.dev"
    source: hosted
    version: "3.2.0"
  geolocator:
    dependency: "direct main"
    description:
      name: geolocator
      sha256: f62bcd90459e63210bbf9c35deb6a51c521f992a78de19a1fe5c11704f9530e2
      url: "https://pub.dev"
    source: hosted
    version: "13.0.4"
  geolocator_android:
    dependency: transitive
    description:
      name: geolocator_android
      sha256: fcb1760a50d7500deca37c9a666785c047139b5f9ee15aa5469fae7dbbe3170d
      url: "https://pub.dev"
    source: hosted
    version: "4.6.2"
  geolocator_apple:
    dependency: transitive
    description:
      name: geolocator_apple
      sha256: dbdd8789d5aaf14cf69f74d4925ad1336b4433a6efdf2fce91e8955dc921bf22
      url: "https://pub.dev"
    source: hosted
    version: "2.3.13"
  geolocator_platform_interface:
    dependency: transitive
    description:
      name: geolocator_platform_interface
      sha256: "30cb64f0b9adcc0fb36f628b4ebf4f731a2961a0ebd849f4b56200205056fe67"
      url: "https://pub.dev"
    source: hosted
    version: "4.2.6"
  geolocator_web:
    dependency: transitive
    description:
      name: geolocator_web
      sha256: b1ae9bdfd90f861fde8fd4f209c37b953d65e92823cb73c7dee1fa021b06f172
      url: "https://pub.dev"
    source: hosted
    version: "4.1.3"
  geolocator_windows:
    dependency: transitive
    description:
      name: geolocator_windows
      sha256: "175435404d20278ffd220de83c2ca293b73db95eafbdc8131fe8609be1421eb6"
      url: "https://pub.dev"
    source: hosted
    version: "0.2.5"
  get_it:
    dependency: "direct main"
    description:
      name: get_it
      sha256: d85128a5dae4ea777324730dc65edd9c9f43155c109d5cc0a69cab74139fbac1
      url: "https://pub.dev"
    source: hosted
    version: "7.7.0"
  glob:
    dependency: transitive
    description:
      name: glob
      sha256: c3f1ee72c96f8f78935e18aa8cecced9ab132419e8625dc187e1c2408efc20de
      url: "https://pub.dev"
    source: hosted
    version: "2.1.3"
  go_router:
    dependency: "direct main"
    description:
      name: go_router
      sha256: f02fd7d2a4dc512fec615529824fdd217fecb3a3d3de68360293a551f21634b3
      url: "https://pub.dev"
    source: hosted
    version: "14.8.1"
  google_fonts:
    dependency: "direct main"
    description:
      name: google_fonts
      sha256: df9763500dadba0155373e9cb44e202ce21bd9ed5de6bdbd05c5854e86839cb8
      url: "https://pub.dev"
    source: hosted
    version: "6.3.0"
  google_generative_ai:
    dependency: "direct main"
    description:
      name: google_generative_ai
      sha256: "71f613d0247968992ad87a0eb21650a566869757442ba55a31a81be6746e0d1f"
      url: "https://pub.dev"
    source: hosted
    version: "0.4.7"
  gotrue:
    dependency: transitive
    description:
      name: gotrue
      sha256: f7b52008311941a7c3e99f9590c4ee32dfc102a5442e43abf1b287d9f8cc39b2
      url: "https://pub.dev"
    source: hosted
    version: "2.18.0"
  graphs:
    dependency: transitive
    description:
      name: graphs
      sha256: "741bbf84165310a68ff28fe9e727332eef1407342fca52759cb21ad8177bb8d0"
      url: "https://pub.dev"
    source: hosted
    version: "2.3.2"
  gtk:
    dependency: transitive
    description:
      name: gtk
      sha256: e8ce9ca4b1df106e4d72dad201d345ea1a036cc12c360f1a7d5a758f78ffa42c
      url: "https://pub.dev"
    source: hosted
    version: "2.1.0"
  http:
    dependency: "direct main"
    description:
      name: http
      sha256: "87721a4a50b19c7f1d49001e51409bddc46303966ce89a65af4f4e6004896412"
      url: "https://pub.dev"
    source: hosted
    version: "1.6.0"
  http_multi_server:
    dependency: transitive
    description:
      name: http_multi_server
      sha256: aa6199f908078bb1c5efb8d8638d4ae191aac11b311132c3ef48ce352fb52ef8
      url: "https://pub.dev"
    source: hosted
    version: "3.2.2"
  http_parser:
    dependency: transitive
    description:
      name: http_parser
      sha256: "178d74305e7866013777bab2c3d8726205dc5a4dd935297175b19a23a2e66571"
      url: "https://pub.dev"
    source: hosted
    version: "4.1.2"
  image_picker:
    dependency: "direct main"
    description:
      name: image_picker
      sha256: "736eb56a911cf24d1859315ad09ddec0b66104bc41a7f8c5b96b4e2620cf5041"
      url: "https://pub.dev"
    source: hosted
    version: "1.2.0"
  image_picker_android:
    dependency: transitive
    description:
      name: image_picker_android
      sha256: e83b2b05141469c5e19d77e1dfa11096b6b1567d09065b2265d7c6904560050c
      url: "https://pub.dev"
    source: hosted
    version: "0.8.13"
  image_picker_for_web:
    dependency: transitive
    description:
      name: image_picker_for_web
      sha256: "40c2a6a0da15556dc0f8e38a3246064a971a9f512386c3339b89f76db87269b6"
      url: "https://pub.dev"
    source: hosted
    version: "3.1.0"
  image_picker_ios:
    dependency: transitive
    description:
      name: image_picker_ios
      sha256: eb06fe30bab4c4497bad449b66448f50edcc695f1c59408e78aa3a8059eb8f0e
      url: "https://pub.dev"
    source: hosted
    version: "0.8.13"
  image_picker_linux:
    dependency: transitive
    description:
      name: image_picker_linux
      sha256: "1f81c5f2046b9ab724f85523e4af65be1d47b038160a8c8deed909762c308ed4"
      url: "https://pub.dev"
    source: hosted
    version: "0.2.2"
  image_picker_macos:
    dependency: transitive
    description:
      name: image_picker_macos
      sha256: d58cd9d67793d52beefd6585b12050af0a7663c0c2a6ece0fb110a35d6955e04
      url: "https://pub.dev"
    source: hosted
    version: "0.2.2"
  image_picker_platform_interface:
    dependency: transitive
    description:
      name: image_picker_platform_interface
      sha256: "9f143b0dba3e459553209e20cc425c9801af48e6dfa4f01a0fcf927be3f41665"
      url: "https://pub.dev"
    source: hosted
    version: "2.11.0"
  image_picker_windows:
    dependency: transitive
    description:
      name: image_picker_windows
      sha256: d248c86554a72b5495a31c56f060cf73a41c7ff541689327b1a7dbccc33adfae
      url: "https://pub.dev"
    source: hosted
    version: "0.2.2"
  injectable:
    dependency: "direct main"
    description:
      name: injectable
      sha256: "1b86fab6a98c11a97e5c718afb00e628d47d183c2a2256392e995a4c561141c1"
      url: "https://pub.dev"
    source: hosted
    version: "2.5.1"
  injectable_generator:
    dependency: "direct dev"
    description:
      name: injectable_generator
      sha256: b04673a4c88b3a848c0c77bf58b8309f9b9e064d9fe1df5450c8ee1675eaea1a
      url: "https://pub.dev"
    source: hosted
    version: "2.7.0"
  intl:
    dependency: "direct main"
    description:
      name: intl
      sha256: d6f56758b7d3014a48af9701c085700aac781a92a87a62b1333b46d8879661cf
      url: "https://pub.dev"
    source: hosted
    version: "0.19.0"
  io:
    dependency: transitive
    description:
      name: io
      sha256: dfd5a80599cf0165756e3181807ed3e77daf6dd4137caaad72d0b7931597650b
      url: "https://pub.dev"
    source: hosted
    version: "1.0.5"
  js:
    dependency: transitive
    description:
      name: js
      sha256: c1b2e9b5ea78c45e1a0788d29606ba27dc5f71f019f32ca5140f61ef071838cf
      url: "https://pub.dev"
    source: hosted
    version: "0.7.1"
  json_annotation:
    dependency: transitive
    description:
      name: json_annotation
      sha256: "1ce844379ca14835a50d2f019a3099f419082cfdd231cd86a142af94dd5c6bb1"
      url: "https://pub.dev"
    source: hosted
    version: "4.9.0"
  jwt_decode:
    dependency: transitive
    description:
      name: jwt_decode
      sha256: d2e9f68c052b2225130977429d30f187aa1981d789c76ad104a32243cfdebfbb
      url: "https://pub.dev"
    source: hosted
    version: "0.3.1"
  latlong2:
    dependency: "direct main"
    description:
      name: latlong2
      sha256: "98227922caf49e6056f91b6c56945ea1c7b166f28ffcd5fb8e72fc0b453cc8fe"
      url: "https://pub.dev"
    source: hosted
    version: "0.9.1"
  leak_tracker:
    dependency: transitive
    description:
      name: leak_tracker
      sha256: "7bb2830ebd849694d1ec25bf1f44582d6ac531a57a365a803a6034ff751d2d06"
      url: "https://pub.dev"
    source: hosted
    version: "10.0.7"
  leak_tracker_flutter_testing:
    dependency: transitive
    description:
      name: leak_tracker_flutter_testing
      sha256: "9491a714cca3667b60b5c420da8217e6de0d1ba7a5ec322fab01758f6998f379"
      url: "https://pub.dev"
    source: hosted
    version: "3.0.8"
  leak_tracker_testing:
    dependency: transitive
    description:
      name: leak_tracker_testing
      sha256: "6ba465d5d76e67ddf503e1161d1f4a6bc42306f9d66ca1e8f079a47290fb06d3"
      url: "https://pub.dev"
    source: hosted
    version: "3.0.1"
  lints:
    dependency: transitive
    description:
      name: lints
      sha256: c35bb79562d980e9a453fc715854e1ed39e24e7d0297a880ef54e17f9874a9d7
      url: "https://pub.dev"
    source: hosted
    version: "5.1.1"
  lists:
    dependency: transitive
    description:
      name: lists
      sha256: "4ca5c19ae4350de036a7e996cdd1ee39c93ac0a2b840f4915459b7d0a7d4ab27"
      url: "https://pub.dev"
    source: hosted
    version: "1.0.1"
  logger:
    dependency: transitive
    description:
      name: logger
      sha256: a7967e31b703831a893bbc3c3dd11db08126fe5f369b5c648a36f821979f5be3
      url: "https://pub.dev"
    source: hosted
    version: "2.6.2"
  logging:
    dependency: transitive
    description:
      name: logging
      sha256: c8245ada5f1717ed44271ed1c26b8ce85ca3228fd2ffdb75468ab01979309d61
      url: "https://pub.dev"
    source: hosted
    version: "1.3.0"
  markdown:
    dependency: transitive
    description:
      name: markdown
      sha256: "935e23e1ff3bc02d390bad4d4be001208ee92cc217cb5b5a6c19bc14aaa318c1"
      url: "https://pub.dev"
    source: hosted
    version: "7.3.0"
  matcher:
    dependency: transitive
    description:
      name: matcher
      sha256: d2323aa2060500f906aa31a895b4030b6da3ebdcc5619d14ce1aada65cd161cb
      url: "https://pub.dev"
    source: hosted
    version: "0.12.16+1"
  material_color_utilities:
    dependency: transitive
    description:
      name: material_color_utilities
      sha256: f7142bb1154231d7ea5f96bc7bde4bda2a0945d2806bb11670e30b850d56bdec
      url: "https://pub.dev"
    source: hosted
    version: "0.11.1"
  meta:
    dependency: transitive
    description:
      name: meta
      sha256: bdb68674043280c3428e9ec998512fb681678676b3c54e773629ffe74419f8c7
      url: "https://pub.dev"
    source: hosted
    version: "1.15.0"
  mgrs_dart:
    dependency: transitive
    description:
      name: mgrs_dart
      sha256: fb89ae62f05fa0bb90f70c31fc870bcbcfd516c843fb554452ab3396f78586f7
      url: "https://pub.dev"
    source: hosted
    version: "2.0.0"
  mime:
    dependency: transitive
    description:
      name: mime
      sha256: "41a20518f0cb1256669420fdba0cd90d21561e560ac240f26ef8322e45bb7ed6"
      url: "https://pub.dev"
    source: hosted
    version: "2.0.0"
  nested:
    dependency: transitive
    description:
      name: nested
      sha256: "03bac4c528c64c95c722ec99280375a6f2fc708eec17c7b3f07253b626cd2a20"
      url: "https://pub.dev"
    source: hosted
    version: "1.0.0"
  nm:
    dependency: transitive
    description:
      name: nm
      sha256: "2c9aae4127bdc8993206464fcc063611e0e36e72018696cd9631023a31b24254"
      url: "https://pub.dev"
    source: hosted
    version: "0.5.0"
  package_config:
    dependency: transitive
    description:
      name: package_config
      sha256: f096c55ebb7deb7e384101542bfba8c52696c1b56fca2eb62827989ef2353bbc
      url: "https://pub.dev"
    source: hosted
    version: "2.2.0"
  path:
    dependency: transitive
    description:
      name: path
      sha256: "087ce49c3f0dc39180befefc60fdb4acd8f8620e5682fe2476afd0b3688bb4af"
      url: "https://pub.dev"
    source: hosted
    version: "1.9.0"
  path_parsing:
    dependency: transitive
    description:
      name: path_parsing
      sha256: "883402936929eac138ee0a45da5b0f2c80f89913e6dc3bf77eb65b84b409c6ca"
      url: "https://pub.dev"
    source: hosted
    version: "1.1.0"
  path_provider:
    dependency: transitive
    description:
      name: path_provider
      sha256: "50c5dd5b6e1aaf6fb3a78b33f6aa3afca52bf903a8a5298f53101fdaee55bbcd"
      url: "https://pub.dev"
    source: hosted
    version: "2.1.5"
  path_provider_android:
    dependency: transitive
    description:
      name: path_provider_android
      sha256: d0d310befe2c8ab9e7f393288ccbb11b60c019c6b5afc21973eeee4dda2b35e9
      url: "https://pub.dev"
    source: hosted
    version: "2.2.17"
  path_provider_foundation:
    dependency: transitive
    description:
      name: path_provider_foundation
      sha256: "4843174df4d288f5e29185bd6e72a6fbdf5a4a4602717eed565497429f179942"
      url: "https://pub.dev"
    source: hosted
    version: "2.4.1"
  path_provider_linux:
    dependency: transitive
    description:
      name: path_provider_linux
      sha256: f7a1fe3a634fe7734c8d3f2766ad746ae2a2884abe22e241a8b301bf5cac3279
      url: "https://pub.dev"
    source: hosted
    version: "2.2.1"
  path_provider_platform_interface:
    dependency: transitive
    description:
      name: path_provider_platform_interface
      sha256: "88f5779f72ba699763fa3a3b06aa4bf6de76c8e5de842cf6f29e2e06476c2334"
      url: "https://pub.dev"
    source: hosted
    version: "2.1.2"
  path_provider_windows:
    dependency: transitive
    description:
      name: path_provider_windows
      sha256: bd6f00dbd873bfb70d0761682da2b3a2c2fccc2b9e84c495821639601d81afe7
      url: "https://pub.dev"
    source: hosted
    version: "2.3.0"
  permission_handler:
    dependency: "direct main"
    description:
      name: permission_handler
      sha256: "59adad729136f01ea9e35a48f5d1395e25cba6cea552249ddbe9cf950f5d7849"
      url: "https://pub.dev"
    source: hosted
    version: "11.4.0"
  permission_handler_android:
    dependency: transitive
    description:
      name: permission_handler_android
      sha256: d3971dcdd76182a0c198c096b5db2f0884b0d4196723d21a866fc4cdea057ebc
      url: "https://pub.dev"
    source: hosted
    version: "12.1.0"
  permission_handler_apple:
    dependency: transitive
    description:
      name: permission_handler_apple
      sha256: f000131e755c54cf4d84a5d8bd6e4149e262cc31c5a8b1d698de1ac85fa41023
      url: "https://pub.dev"
    source: hosted
    version: "9.4.7"
  permission_handler_html:
    dependency: transitive
    description:
      name: permission_handler_html
      sha256: "38f000e83355abb3392140f6bc3030660cfaef189e1f87824facb76300b4ff24"
      url: "https://pub.dev"
    source: hosted
    version: "0.1.3+5"
  permission_handler_platform_interface:
    dependency: transitive
    description:
      name: permission_handler_platform_interface
      sha256: eb99b295153abce5d683cac8c02e22faab63e50679b937fa1bf67d58bb282878
      url: "https://pub.dev"
    source: hosted
    version: "4.3.0"
  permission_handler_windows:
    dependency: transitive
    description:
      name: permission_handler_windows
      sha256: "1a790728016f79a41216d88672dbc5df30e686e811ad4e698bfc51f76ad91f1e"
      url: "https://pub.dev"
    source: hosted
    version: "0.2.1"
  petitparser:
    dependency: transitive
    description:
      name: petitparser
      sha256: c15605cd28af66339f8eb6fbe0e541bfe2d1b72d5825efc6598f3e0a31b9ad27
      url: "https://pub.dev"
    source: hosted
    version: "6.0.2"
  platform:
    dependency: transitive
    description:
      name: platform
      sha256: "5d6b1b0036a5f331ebc77c850ebc8506cbc1e9416c27e59b439f917a902a4984"
      url: "https://pub.dev"
    source: hosted
    version: "3.1.6"
  plugin_platform_interface:
    dependency: transitive
    description:
      name: plugin_platform_interface
      sha256: "4820fbfdb9478b1ebae27888254d445073732dae3d6ea81f0b7e06d5dedc3f02"
      url: "https://pub.dev"
    source: hosted
    version: "2.1.8"
  pointycastle:
    dependency: transitive
    description:
      name: pointycastle
      sha256: "4be0097fcf3fd3e8449e53730c631200ebc7b88016acecab2b0da2f0149222fe"
      url: "https://pub.dev"
    source: hosted
    version: "3.9.1"
  polylabel:
    dependency: transitive
    description:
      name: polylabel
      sha256: "41b9099afb2aa6c1730bdd8a0fab1400d287694ec7615dd8516935fa3144214b"
      url: "https://pub.dev"
    source: hosted
    version: "1.0.1"
  pool:
    dependency: transitive
    description:
      name: pool
      sha256: "978783255c543aa3586a1b3c21f6e9d720eb315376a915872c61ef8b5c20177d"
      url: "https://pub.dev"
    source: hosted
    version: "1.5.2"
  postgrest:
    dependency: transitive
    description:
      name: postgrest
      sha256: f4b6bb24b465c47649243ef0140475de8a0ec311dc9c75ebe573b2dcabb10460
      url: "https://pub.dev"
    source: hosted
    version: "2.6.0"
  proj4dart:
    dependency: transitive
    description:
      name: proj4dart
      sha256: c8a659ac9b6864aa47c171e78d41bbe6f5e1d7bd790a5814249e6b68bc44324e
      url: "https://pub.dev"
    source: hosted
    version: "2.1.0"
  provider:
    dependency: transitive
    description:
      name: provider
      sha256: "4e82183fa20e5ca25703ead7e05de9e4cceed1fbd1eadc1ac3cb6f565a09f272"
      url: "https://pub.dev"
    source: hosted
    version: "6.1.5+1"
  pub_semver:
    dependency: transitive
    description:
      name: pub_semver
      sha256: "5bfcf68ca79ef689f8990d1160781b4bad40a3bd5e5218ad4076ddb7f4081585"
      url: "https://pub.dev"
    source: hosted
    version: "2.2.0"
  pubspec_parse:
    dependency: transitive
    description:
      name: pubspec_parse
      sha256: "0560ba233314abbed0a48a2956f7f022cce7c3e1e73df540277da7544cad4082"
      url: "https://pub.dev"
    source: hosted
    version: "1.5.0"
  realtime_client:
    dependency: transitive
    description:
      name: realtime_client
      sha256: "5268afc208d02fb9109854d262c1ebf6ece224cd285199ae1d2f92d2ff49dbf1"
      url: "https://pub.dev"
    source: hosted
    version: "2.7.0"
  recase:
    dependency: transitive
    description:
      name: recase
      sha256: e4eb4ec2dcdee52dcf99cb4ceabaffc631d7424ee55e56f280bc039737f89213
      url: "https://pub.dev"
    source: hosted
    version: "4.1.0"
  retry:
    dependency: transitive
    description:
      name: retry
      sha256: "822e118d5b3aafed083109c72d5f484c6dc66707885e07c0fbcb8b986bba7efc"
      url: "https://pub.dev"
    source: hosted
    version: "3.1.2"
  rxdart:
    dependency: transitive
    description:
      name: rxdart
      sha256: "5c3004a4a8dbb94bd4bf5412a4def4acdaa12e12f269737a5751369e12d1a962"
      url: "https://pub.dev"
    source: hosted
    version: "0.28.0"
  shared_preferences:
    dependency: transitive
    description:
      name: shared_preferences
      sha256: "6e8bf70b7fef813df4e9a36f658ac46d107db4b4cfe1048b477d4e453a8159f5"
      url: "https://pub.dev"
    source: hosted
    version: "2.5.3"
  shared_preferences_android:
    dependency: transitive
    description:
      name: shared_preferences_android
      sha256: "5bcf0772a761b04f8c6bf814721713de6f3e5d9d89caf8d3fe031b02a342379e"
      url: "https://pub.dev"
    source: hosted
    version: "2.4.11"
  shared_preferences_foundation:
    dependency: transitive
    description:
      name: shared_preferences_foundation
      sha256: "6a52cfcdaeac77cad8c97b539ff688ccfc458c007b4db12be584fbe5c0e49e03"
      url: "https://pub.dev"
    source: hosted
    version: "2.5.4"
  shared_preferences_linux:
    dependency: transitive
    description:
      name: shared_preferences_linux
      sha256: "580abfd40f415611503cae30adf626e6656dfb2f0cee8f465ece7b6defb40f2f"
      url: "https://pub.dev"
    source: hosted
    version: "2.4.1"
  shared_preferences_platform_interface:
    dependency: transitive
    description:
      name: shared_preferences_platform_interface
      sha256: "57cbf196c486bc2cf1f02b85784932c6094376284b3ad5779d1b1c6c6a816b80"
      url: "https://pub.dev"
    source: hosted
    version: "2.4.1"
  shared_preferences_web:
    dependency: transitive
    description:
      name: shared_preferences_web
      sha256: c49bd060261c9a3f0ff445892695d6212ff603ef3115edbb448509d407600019
      url: "https://pub.dev"
    source: hosted
    version: "2.4.3"
  shared_preferences_windows:
    dependency: transitive
    description:
      name: shared_preferences_windows
      sha256: "94ef0f72b2d71bc3e700e025db3710911bd51a71cefb65cc609dd0d9a982e3c1"
      url: "https://pub.dev"
    source: hosted
    version: "2.4.1"
  shelf:
    dependency: transitive
    description:
      name: shelf
      sha256: e7dd780a7ffb623c57850b33f43309312fc863fb6aa3d276a754bb299839ef12
      url: "https://pub.dev"
    source: hosted
    version: "1.4.2"
  shelf_web_socket:
    dependency: transitive
    description:
      name: shelf_web_socket
      sha256: "3632775c8e90d6c9712f883e633716432a27758216dfb61bd86a8321c0580925"
      url: "https://pub.dev"
    source: hosted
    version: "3.0.0"
  shimmer:
    dependency: "direct main"
    description:
      name: shimmer
      sha256: "5f88c883a22e9f9f299e5ba0e4f7e6054857224976a5d9f839d4ebdc94a14ac9"
      url: "https://pub.dev"
    source: hosted
    version: "3.0.0"
  sky_engine:
    dependency: transitive
    description: flutter
    source: sdk
    version: "0.0.0"
  source_gen:
    dependency: transitive
    description:
      name: source_gen
      sha256: "35c8150ece9e8c8d263337a265153c3329667640850b9304861faea59fc98f6b"
      url: "https://pub.dev"
    source: hosted
    version: "2.0.0"
  source_span:
    dependency: transitive
    description:
      name: source_span
      sha256: "53e943d4206a5e30df338fd4c6e7a077e02254531b138a15aec3bd143c1a8b3c"
      url: "https://pub.dev"
    source: hosted
    version: "1.10.0"
  stack_trace:
    dependency: transitive
    description:
      name: stack_trace
      sha256: "9f47fd3630d76be3ab26f0ee06d213679aa425996925ff3feffdec504931c377"
      url: "https://pub.dev"
    source: hosted
    version: "1.12.0"
  storage_client:
    dependency: transitive
    description:
      name: storage_client
      sha256: "1c61b19ed9e78f37fdd1ca8b729ab8484e6c8fe82e15c87e070b861951183657"
      url: "https://pub.dev"
    source: hosted
    version: "2.4.1"
  stream_channel:
    dependency: transitive
    description:
      name: stream_channel
      sha256: ba2aa5d8cc609d96bbb2899c28934f9e1af5cddbd60a827822ea467161eb54e7
      url: "https://pub.dev"
    source: hosted
    version: "2.1.2"
  stream_transform:
    dependency: transitive
    description:
      name: stream_transform
      sha256: ad47125e588cfd37a9a7f86c7d6356dde8dfe89d071d293f80ca9e9273a33871
      url: "https://pub.dev"
    source: hosted
    version: "2.1.1"
  string_scanner:
    dependency: transitive
    description:
      name: string_scanner
      sha256: "688af5ed3402a4bde5b3a6c15fd768dbf2621a614950b17f04626c431ab3c4c3"
      url: "https://pub.dev"
    source: hosted
    version: "1.3.0"
  supabase:
    dependency: transitive
    description:
      name: supabase
      sha256: cc039f63a3168386b3a4f338f3bff342c860d415a3578f3fbe854024aee6f911
      url: "https://pub.dev"
    source: hosted
    version: "2.10.2"
  supabase_flutter:
    dependency: "direct main"
    description:
      name: supabase_flutter
      sha256: "92b2416ecb6a5c3ed34cf6e382b35ce6cc8921b64f2a9299d5d28968d42b09bb"
      url: "https://pub.dev"
    source: hosted
    version: "2.12.0"
  term_glyph:
    dependency: transitive
    description:
      name: term_glyph
      sha256: a29248a84fbb7c79282b40b8c72a1209db169a2e0542bce341da992fe1bc7e84
      url: "https://pub.dev"
    source: hosted
    version: "1.2.1"
  test_api:
    dependency: transitive
    description:
      name: test_api
      sha256: "664d3a9a64782fcdeb83ce9c6b39e78fd2971d4e37827b9b06c3aa1edc5e760c"
      url: "https://pub.dev"
    source: hosted
    version: "0.7.3"
  timing:
    dependency: transitive
    description:
      name: timing
      sha256: "62ee18aca144e4a9f29d212f5a4c6a053be252b895ab14b5821996cff4ed90fe"
      url: "https://pub.dev"
    source: hosted
    version: "1.0.2"
  typed_data:
    dependency: transitive
    description:
      name: typed_data
      sha256: f9049c039ebfeb4cf7a7104a675823cd72dba8297f264b6637062516699fa006
      url: "https://pub.dev"
    source: hosted
    version: "1.4.0"
  unicode:
    dependency: transitive
    description:
      name: unicode
      sha256: "0f69e46593d65245774d4f17125c6084d2c20b4e473a983f6e21b7d7762218f1"
      url: "https://pub.dev"
    source: hosted
    version: "0.3.1"
  url_launcher:
    dependency: "direct main"
    description:
      name: url_launcher
      sha256: f6a7e5c4835bb4e3026a04793a4199ca2d14c739ec378fdfe23fc8075d0439f8
      url: "https://pub.dev"
    source: hosted
    version: "6.3.2"
  url_launcher_android:
    dependency: transitive
    description:
      name: url_launcher_android
      sha256: "0aedad096a85b49df2e4725fa32118f9fa580f3b14af7a2d2221896a02cd5656"
      url: "https://pub.dev"
    source: hosted
    version: "6.3.17"
  url_launcher_ios:
    dependency: transitive
    description:
      name: url_launcher_ios
      sha256: "7f2022359d4c099eea7df3fdf739f7d3d3b9faf3166fb1dd390775176e0b76cb"
      url: "https://pub.dev"
    source: hosted
    version: "6.3.3"
  url_launcher_linux:
    dependency: transitive
    description:
      name: url_launcher_linux
      sha256: "4e9ba368772369e3e08f231d2301b4ef72b9ff87c31192ef471b380ef29a4935"
      url: "https://pub.dev"
    source: hosted
    version: "3.2.1"
  url_launcher_macos:
    dependency: transitive
    description:
      name: url_launcher_macos
      sha256: "17ba2000b847f334f16626a574c702b196723af2a289e7a93ffcb79acff855c2"
      url: "https://pub.dev"
    source: hosted
    version: "3.2.2"
  url_launcher_platform_interface:
    dependency: transitive
    description:
      name: url_launcher_platform_interface
      sha256: "552f8a1e663569be95a8190206a38187b531910283c3e982193e4f2733f01029"
      url: "https://pub.dev"
    source: hosted
    version: "2.3.2"
  url_launcher_web:
    dependency: transitive
    description:
      name: url_launcher_web
      sha256: "4bd2b7b4dc4d4d0b94e5babfffbca8eac1a126c7f3d6ecbc1a11013faa3abba2"
      url: "https://pub.dev"
    source: hosted
    version: "2.4.1"
  url_launcher_windows:
    dependency: transitive
    description:
      name: url_launcher_windows
      sha256: "3284b6d2ac454cf34f114e1d3319866fdd1e19cdc329999057e44ffe936cfa77"
      url: "https://pub.dev"
    source: hosted
    version: "3.1.4"
  uuid:
    dependency: "direct main"
    description:
      name: uuid
      sha256: a11b666489b1954e01d992f3d601b1804a33937b5a8fe677bd26b8a9f96f96e8
      url: "https://pub.dev"
    source: hosted
    version: "4.5.2"
  vector_graphics:
    dependency: transitive
    description:
      name: vector_graphics
      sha256: a4f059dc26fc8295b5921376600a194c4ec7d55e72f2fe4c7d2831e103d461e6
      url: "https://pub.dev"
    source: hosted
    version: "1.1.19"
  vector_graphics_codec:
    dependency: transitive
    description:
      name: vector_graphics_codec
      sha256: "99fd9fbd34d9f9a32efd7b6a6aae14125d8237b10403b422a6a6dfeac2806146"
      url: "https://pub.dev"
    source: hosted
    version: "1.1.13"
  vector_graphics_compiler:
    dependency: transitive
    description:
      name: vector_graphics_compiler
      sha256: ca81fdfaf62a5ab45d7296614aea108d2c7d0efca8393e96174bf4d51e6725b0
      url: "https://pub.dev"
    source: hosted
    version: "1.1.18"
  vector_math:
    dependency: transitive
    description:
      name: vector_math
      sha256: "80b3257d1492ce4d091729e3a67a60407d227c27241d6927be0130c98e741803"
      url: "https://pub.dev"
    source: hosted
    version: "2.1.4"
  vm_service:
    dependency: transitive
    description:
      name: vm_service
      sha256: f6be3ed8bd01289b34d679c2b62226f63c0e69f9fd2e50a6b3c1c729a961041b
      url: "https://pub.dev"
    source: hosted
    version: "14.3.0"
  watcher:
    dependency: transitive
    description:
      name: watcher
      sha256: f52385d4f73589977c80797e60fe51014f7f2b957b5e9a62c3f6ada439889249
      url: "https://pub.dev"
    source: hosted
    version: "1.2.0"
  web:
    dependency: transitive
    description:
      name: web
      sha256: "868d88a33d8a87b18ffc05f9f030ba328ffefba92d6c127917a2ba740f9cfe4a"
      url: "https://pub.dev"
    source: hosted
    version: "1.1.1"
  web_socket:
    dependency: transitive
    description:
      name: web_socket
      sha256: "34d64019aa8e36bf9842ac014bb5d2f5586ca73df5e4d9bf5c936975cae6982c"
      url: "https://pub.dev"
    source: hosted
    version: "1.0.1"
  web_socket_channel:
    dependency: transitive
    description:
      name: web_socket_channel
      sha256: d645757fb0f4773d602444000a8131ff5d48c9e47adfe9772652dd1a4f2d45c8
      url: "https://pub.dev"
    source: hosted
    version: "3.0.3"
  wkt_parser:
    dependency: transitive
    description:
      name: wkt_parser
      sha256: "8a555fc60de3116c00aad67891bcab20f81a958e4219cc106e3c037aa3937f13"
      url: "https://pub.dev"
    source: hosted
    version: "2.0.0"
  xdg_directories:
    dependency: transitive
    description:
      name: xdg_directories
      sha256: "7a3f37b05d989967cdddcbb571f1ea834867ae2faa29725fd085180e0883aa15"
      url: "https://pub.dev"
    source: hosted
    version: "1.1.0"
  xml:
    dependency: transitive
    description:
      name: xml
      sha256: b015a8ad1c488f66851d762d3090a21c600e479dc75e68328c52774040cf9226
      url: "https://pub.dev"
    source: hosted
    version: "6.5.0"
  yaml:
    dependency: transitive
    description:
      name: yaml
      sha256: b9da305ac7c39faa3f030eccd175340f968459dae4af175130b3fc47e40d76ce
      url: "https://pub.dev"
    source: hosted
    version: "3.1.3"
  yet_another_json_isolate:
    dependency: transitive
    description:
      name: yet_another_json_isolate
      sha256: fe45897501fa156ccefbfb9359c9462ce5dec092f05e8a56109db30be864f01e
      url: "https://pub.dev"
    source: hosted
    version: "2.1.0"
sdks:
  dart: ">=3.6.2 <4.0.0"
  flutter: ">=3.27.0"
</file>

<file path="pubspec.yaml">
name: prueba_bim2
description: "A new Flutter project."
# The following line prevents the package from being accidentally published to
# pub.dev using `flutter pub publish`. This is preferred for private packages.
publish_to: 'none' # Remove this line if you wish to publish to pub.dev

# The following defines the version and build number for your application.
# A version number is three numbers separated by dots, like 1.2.43
# followed by an optional build number separated by a +.
# Both the version and the builder number may be overridden in flutter
# build by specifying --build-name and --build-number, respectively.
# In Android, build-name is used as versionName while build-number used as versionCode.
# Read more about Android versioning at https://developer.android.com/studio/publish/versioning
# In iOS, build-name is used as CFBundleShortVersionString while build-number is used as CFBundleVersion.
# Read more about iOS versioning at
# https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CoreFoundationKeys.html
# In Windows, build-name is used as the major, minor, and patch parts
# of the product and file versions while build-number is used as the build suffix.
version: 1.0.0+1

environment:
  sdk: ^3.6.2

# Dependencies specify other packages that your package needs in order to work.
# To automatically upgrade your package dependencies to the latest versions
# consider running `flutter pub upgrade --major-versions`. Alternatively,
# dependencies can be manually updated by changing the version numbers below to
# the latest version available on pub.dev. To see which dependencies have newer
# versions available, run `flutter pub outdated`.
dependencies:
  flutter:
    sdk: flutter

  # The following adds the Cupertino Icons font to your application.
  # Use with the CupertinoIcons class for iOS style icons.
  cupertino_icons: ^1.0.8

  # --- ARQUITECTURA & GESTIN DE ESTADO ---
  flutter_bloc: ^8.1.6
  get_it: ^7.7.0
  equatable: ^2.0.7
  go_router: ^14.2.0
  injectable: ^2.5.0

  # --- BACKEND (SUPABASE) ---
  supabase_flutter: ^2.6.0

  # Environment Variables
  flutter_dotenv: ^5.2.1


  # Functional Programming
  dartz: ^0.10.1

  # Network
  connectivity_plus: ^6.1.2

  # Deep Linking
  app_links: ^6.3.3

  # --- MAPAS & GPS (OPENSTREETMAP) ---
  flutter_map: ^7.0.0
  latlong2: ^0.9.1
  geolocator: ^13.0.0
  geocoding: ^3.0.0 # Para direcciones
  permission_handler: ^11.1.0 # Para pedir permiso de ubicaci贸n de forma limpia

  # --- INTELIGENCIA ARTIFICIAL (GEMINI) ---
  google_generative_ai: ^0.4.4
  http: ^1.4.0
  flutter_markdown: ^0.7.4+1

  # --- UTILIDADES & UI ---
  image_picker: ^1.1.2 # Para subir fotos de mascotas
  google_fonts: ^6.2.1 # Para dise帽o moderno (+ puntos)
  intl: ^0.19.0 # Para fechas
  url_launcher: ^6.3.0 # Para abrir links externos si hace falta
  uuid: ^4.4.0 # Para generar nombres 煤nicos de im谩genes
  flutter_svg: ^2.0.10+1
  shimmer: ^3.0.0

dev_dependencies:
  flutter_test:
    sdk: flutter

  # The "flutter_lints" package below contains a set of recommended lints to
  # encourage good coding practices. The lint set provided by the package is
  # activated in the `analysis_options.yaml` file located at the root of your
  # package. See that file for information about deactivating specific lint
  # rules and activating additional ones.
  flutter_lints: ^5.0.0

  # Code Generation
  build_runner: ^2.4.13
  injectable_generator: ^2.6.2

# For information on the generic Dart part of this file, see the
# following page: https://dart.dev/tools/pub/pubspec

# The following section is specific to Flutter packages.
flutter:

  # The following line ensures that the Material Icons font is
  # included with your application, so that you can use the icons in
  # the material Icons class.
  uses-material-design: true

  assets:
    - .env
    - assets/images/
    - assets/icons/

  # To add assets to your application, add an assets section, like this:
  # assets:
  #   - images/a_dot_burr.jpeg
  #   - images/a_dot_ham.jpeg

  # An image asset can refer to one or more resolution-specific "variants", see
  # https://flutter.dev/to/resolution-aware-images

  # For details regarding adding assets from package dependencies, see
  # https://flutter.dev/to/asset-from-package

  # To add custom fonts to your application, add a fonts section here,
  # in this "flutter" section. Each entry in this list should have a
  # "family" key with the font family name, and a "fonts" key with a
  # list giving the asset and other descriptors for the font. For
  # example:
  # fonts:
  #   - family: Schyler
  #     fonts:
  #       - asset: fonts/Schyler-Regular.ttf
  #       - asset: fonts/Schyler-Italic.ttf
  #         style: italic
  #   - family: Trajan Pro
  #     fonts:
  #       - asset: fonts/TrajanPro.ttf
  #       - asset: fonts/TrajanPro_Bold.ttf
  #         weight: 700
  #
  # For details regarding fonts from package dependencies,
  # see https://flutter.dev/to/font-from-package
</file>

<file path="vercel/public/verify-email.html">
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificaci贸n PetAdopt</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #FF8B3D 0%, #FFB74D 100%);
            margin: 0;
        }

        .card {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 450px;
            width: 90%;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #FF8B3D;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .hidden {
            display: none;
        }

        h1 {
            color: #2D3436;
            font-size: 1.8rem;
            margin-bottom: 1rem;
        }

        p {
            color: #636E72;
            margin-bottom: 2rem;
            line-height: 1.5;
        }

        button {
            background: #FF8B3D;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            width: 100%;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 139, 61, 0.3);
        }

        .icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: #FFF3E0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon svg {
            width: 40px;
            height: 40px;
        }
    </style>
</head>

<body>
    <div class="card">
        <div id="loading">
            <div class="loader"></div>
            <h1>Verificando...</h1>
            <p>Estamos confirmando tu cuenta con el servidor.</p>
        </div>

        <div id="success" class="hidden">
            <div class="icon" style="background: #E0F2F1;">
                <svg fill="#00BFA5" viewBox="0 0 24 24">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" />
                </svg>
            </div>
            <h1 style="color: #2D3436">隆Cuenta Activada!</h1>
            <p>Tu correo ha sido confirmado correctamente. Ya puedes iniciar sesi贸n en la app.</p>
            <button onclick="openApp()">Abrir App</button>
        </div>

        <div id="error" class="hidden">
            <div class="icon" style="background: #FFEBEE;">
                <svg fill="#FF6B6B" viewBox="0 0 24 24">
                    <path
                        d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z" />
                </svg>
            </div>
            <h1 style="color: #2D3436">Algo sali贸 mal</h1>
            <p id="error-msg">El enlace es inv谩lido o ha expirado.</p>
        </div>
    </div>

    <script>
        // Variable global para el cliente
        let supabase;

        // 1. Funci贸n inicial que carga la configuraci贸n
        async function initSupabase() {
            try {
                // Pedimos las credenciales a nuestra API en Vercel
                // Esto evita tener las claves escritas en el c贸digo HTML
                const response = await fetch('/api/config');
                const config = await response.json();

                if (!window.supabase) {
                    throw new Error("No se pudo cargar la librer铆a de Supabase.");
                }

                // Inicializamos el cliente con las claves obtenidas
                supabase = window.supabase.createClient(
                    config.supabaseUrl,
                    config.supabaseAnonKey
                );

                console.log("Supabase inicializado correctamente");

                // Una vez inicializado, ejecutamos la verificaci贸n
                verifyEmail();

            } catch (error) {
                console.error("Error de configuraci贸n:", error);
                showError("Error interno al conectar con el servidor.");
            }
        }

        // 2. Funci贸n que verifica el token
        async function verifyEmail() {
            try {
                // Obtener token de la URL (hash o query params)
                const params = new URLSearchParams(window.location.search);
                const tokenHash = params.get('token_hash') || params.get('token');
                const type = params.get('type') || 'signup';

                if (!tokenHash) throw new Error("No se encontr贸 el token de verificaci贸n.");

                console.log("Verificando token...", type);

                // Llamada real a Supabase usando el cliente inicializado
                const { error } = await supabase.auth.verifyOtp({
                    token_hash: tokenHash,
                    type: type,
                });

                if (error) throw error;

                // xito
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('success').classList.remove('hidden');

                // Intento autom谩tico de abrir la app
                setTimeout(openApp, 1500);

            } catch (e) {
                console.error(e);
                showError(e.message || "Enlace inv谩lido o expirado");
            }
        }

        function showError(msg) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('error-msg').innerText = msg;
        }

        function openApp() {
            // Deep Link a la app Flutter
            window.location.href = 'loginpro://verified';
        }

        // Arrancamos el proceso
        initSupabase();
    </script>
</body>

</html>
</file>

<file path="android/app/src/main/AndroidManifest.xml">
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <uses-permission android:name="android.permission.INTERNET"/>
    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
    <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />

    <uses-permission android:name="android.permission.CAMERA" />
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
    <uses-permission android:name="android.permission.READ_MEDIA_IMAGES"/>

    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
    <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
    
    <application
        android:label="prueba_bim2"
        android:name="${applicationName}"
        android:icon="@mipmap/ic_launcher">
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:launchMode="singleTop"
            android:taskAffinity=""
            android:theme="@style/LaunchTheme"
            android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode"
            android:hardwareAccelerated="true"
            android:windowSoftInputMode="adjustResize">
            <!-- Specifies an Android theme to apply to this Activity as soon as
                the Android process has started. This theme is visible to the user
                while the Flutter UI initializes. After that, this theme continues
                to determine the Window background behind the Flutter UI. -->
            <meta-data
                android:name="io.flutter.embedding.android.NormalTheme"
                android:resource="@style/NormalTheme"
            />
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />

            </intent-filter>

            <!-- Deep linking configuration -->
            <intent-filter android:autoVerify="true">
                <action android:name="android.intent.action.VIEW"/>
                <category android:name="android.intent.category.DEFAULT"/>
                <category android:name="android.intent.category.BROWSABLE"/>
                <data android:scheme="loginpro"/>
            </intent-filter>

                        <!-- Supabase callback -->
            <intent-filter android:autoVerify="true">
                <action android:name="android.intent.action.VIEW"/>
                <category android:name="android.intent.category.DEFAULT"/>
                <category android:name="android.intent.category.BROWSABLE"/>
                <data android:scheme="https"
                        android:host="loginvercelflutter.vercel.app"/>
            </intent-filter>

        </activity>
        <!-- Don't delete the meta-data below.
            This is used by the Flutter tool to generate GeneratedPluginRegistrant.java -->
        <meta-data
            android:name="flutterEmbedding"
            android:value="2" />
    </application>
    <!-- Required to query activities that can process text, see:
        https://developer.android.com/training/package-visibility and
        https://developer.android.com/reference/android/content/Intent#ACTION_PROCESS_TEXT.

        In particular, this is used by the Flutter engine in io.flutter.plugin.text.ProcessTextPlugin. -->
    <queries>
        <intent>
            <action android:name="android.intent.action.PROCESS_TEXT" />
            <data android:mimeType="text/plain" />
        </intent>
    </queries>
</manifest>
</file>

</files>
